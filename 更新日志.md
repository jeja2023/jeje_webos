# 更新日志 (Changelog)

## v2.1.2 (2026-01-01) - 图表系统重构与ETL引擎增强

### 🎨 图表系统架构重构
- **图表工厂类 (ChartFactory)**：
  - 新增统一的图表生成工具类 `frontend/js/utils/chart_factory.js`，实现图表配置标准化
  - 支持柱状图、折线图、饼图、散点图、直方图、箱线图、热力图、趋势预测等 8 种图表类型
  - 统一数据过滤、字段匹配、排除项处理等逻辑，消除代码重复
  - 提供统一的 ECharts 配置生成接口，提升代码可维护性
- **图表分析模块重构**：
  - 重构 `analysis_chart.js`，使用 ChartFactory 统一图表生成逻辑
  - 大幅简化图表配置代码，提升代码可读性和维护性
  - 优化图表渲染性能，统一图表样式和交互体验

### 🚀 ETL 数据建模引擎增强
- **新算子支持**：
  - **文本处理算子 (text_ops)**：支持大小写转换 (UPPER/LOWER)、去空格 (TRIM)、长度计算 (LENGTH)、字符串反转 (REVERSE) 等操作
  - **数学运算算子 (math_ops)**：支持数值字段的数学运算处理
  - **窗口函数算子 (window)**：支持窗口函数计算，实现更复杂的数据分析场景
- **缓存机制优化**：
  - 新增 ETL 缓存自动清理功能，自动删除超过 24 小时的过期缓存文件
  - 优化缓存目录管理，提升系统存储空间利用率
  - 缓存清理过程异常安全，不影响正常 ETL 执行流程

### 💄 前端体验全面优化
- **数据导入模块优化**：
  - 大幅优化导入界面布局和交互体验
  - 增强文件上传、预览、批量导入等功能
  - 优化导入进度显示和错误提示
- **对比分析功能增强**：
  - 优化数据集对比功能的 UI 设计
  - 改进数据处理逻辑，提升对比结果的准确性
  - 增强对比结果的展示和导出功能
- **智能表格优化**：
  - 增强智能表格的数据展示功能
  - 优化表格编辑和筛选交互
  - 提升大数据量下的表格渲染性能
- **数据清洗模块优化**：
  - 优化清洗规则的配置界面
  - 增强清洗结果的预览和验证功能
- **样式统一化**：
  - 统一分析模块各子功能的样式风格
  - 优化响应式布局，提升不同屏幕尺寸下的显示效果
  - 修复多处样式细节问题，提升视觉一致性

### 🔧 后端服务优化
- **ETL 服务增强**：
  - 优化 ETL 节点执行逻辑，提升处理性能
  - 增强错误处理和日志记录
  - 优化数据转换和缓存机制
- **导入服务优化**：
  - 优化文件导入处理流程
  - 增强数据验证和错误处理
  - 提升大文件导入的稳定性
- **对比服务优化**：
  - 优化数据集对比算法
  - 增强数据清理和格式化处理
  - 提升对比结果的准确性

### 📝 代码质量提升
- **代码重构**：
  - 大量前端代码重构，消除重复逻辑
  - 统一工具类和公共方法，提升代码复用性
  - 优化组件结构和状态管理
- **样式优化**：
  - 统一 CSS 变量使用，提升主题适配性
  - 优化响应式布局和动画效果
  - 修复多处样式细节问题

### 🐛 问题修复
- 修复图表生成时的字段匹配问题
- 修复 ETL 缓存清理时的异常处理
- 修复导入模块的样式显示问题
- 修复智能表格的数据更新问题

---

## v2.1.1 (2025-12-31) - 存储规范统一与开发规范完善

### 📂 存储系统重构
- **统一存储管理器**：重构 `StorageManager`，实现全局统一的存储规则
- **用户隔离**：所有用户相关文件按 `user_{id}/` 目录隔离，确保数据安全
- **模块分类**：模块文件统一存放在 `modules/{module_name}/` 下，支持按用户进一步隔离
- **目录结构优化**：
  - `storage/users/user_{id}/` - 用户私有文件（上传、导出）
  - `storage/modules/{module}/temp/user_{id}/` - 模块临时文件
  - `storage/modules/{module}/archive/user_{id}/` - 模块归档文件
  - `storage/system/` - 系统级文件（备份、日志）

### 📊 智能报告模块优化
- **文件目录重构**：报告文件按 `user_{id}/report_{id}/` 结构存储，一个报告可生成多个PDF
- **删除逻辑完善**：删除报告或记录时，自动清理关联的PDF、调试文件和临时图片目录
- **PDF生成修复**：修复图表只显示一半的问题，优化隐藏渲染容器配置
- **数据库字段扩展**：`full_content` 字段类型改为 `MEDIUMTEXT`，支持存储更大的内容

### 📖 开发规范完善
- **JS/CSS文件规范**：
  - 新增「5.3 JS/CSS 文件命名与存放规范」章节
  - 明确文件命名规则：JS和CSS文件名必须完全一致
  - 明确存放规则：目录结构必须对应，子目录保持一致
- **存储规范**：
  - 新增「六、存储规范 (Storage Standards)」章节
  - 详细说明存储目录结构、StorageManager API使用方法
  - 提供完整的代码示例和使用场景说明

### 🐛 问题修复
- **PDF图表显示**：修复PDF中图表只显示一半的问题，优化ECharts渲染容器配置
- **文件路径错误**：修复PDF生成后下载路径不匹配的问题，统一使用临时目录
- **数据清理**：修复删除记录时未清理本地文件的问题，实现完整的文件清理机制

### 📝 文档更新
- **开发规范**：新增JS/CSS文件规范和存储规范章节
- **更新日志**：记录本次存储系统重构和规范完善
- **README**：更新项目结构说明，添加存储规范链接

---

## v2.1.0 (2025-12-25) - 数据透镜架构升级与体验打磨

### 👁️ 数据透镜模块 (DataLens) 深度优化
- **Spotlight 联动**：支持通过 `Ctrl + K` 全局搜索功能快速发现并一键唤起数据视图窗口。
- **高性能文件缓存**：为 CSV 和 Excel 数据源引入 **DataFrame 内存缓存机制**（有效期 60s），彻底解决大文件分页查询时的 IO 瓶颈。
- **架构重构与解耦**：
  - **独立窗口显示**：点击视图卡片时，由“页内标签”改为“桌面独立窗口”模式。
  - **多开对比支持**：支持同时打开多个视图窗口，任务并行处理能力大幅提升。
  - **路由逻辑优化**：支持通过视图 URL 直接唤起独立窗口，实现了主 Hub 与子视图的完全解耦。

### 🐛 问题修复
- **筛选面板逻辑优化**：
  - 打开筛选面板时自动添加默认空条件行，与排序面板行为一致。
  - 关闭筛选面板时自动清空条件并刷新数据。
  - 修复空字段名或占位符字段被发送到后端导致 SQL 查询失败的问题。
- **图表初始化修复**：修复 `_initChart` 方法中 `getElementById` 参数格式错误导致图表一直显示"初始化中"的问题。
- **HTML 标签语法修复**：修复 `datalens_viewer.js` 中多处 HTML 标签格式问题，确保状态标签、分页按钮等正确渲染。
- **独立窗口标题重复**：移除独立窗口模式下的面包屑导航区域，避免与窗口标题栏重复显示。
- **废弃代码清理**：移除已不再使用的"返回首页"按钮及相关事件监听器。

### 💄 UI/UX 与交互细节打磨
- **面包屑导航**：视图窗口新增 `数据透镜 > 分类 > 视图名` 面包屑，增强层级感知与专业感。
- **筛选逻辑优化**：隐藏筛选面板时不再清空已设定的条件，极大提升了复杂筛选场景下的连续操作体验。
- **预览按钮增强**：
  - 添加 `lens-btn-primary` 类，解决浅色模式下按钮不可见的问题。
  - 引入呼吸灯脉冲效果，强化执行指引。
- **样式变量统合**：
  - 修复了 DataLens 内部 CSS 变量命名不一致导致的背景显示异常，确保主题完美适配。
  - 增加了对 `--color-text` 和危险状态色的别名映射。

### 📖 文档更新
- **帮助中心**：新增「数据透镜指南」，详细说明新窗口架构和钉选功能。
- **README**：更新特性描述和版本号。

---

## v2.0.9 (2025-12-24) - 数据分析模块优化与测试规范

### 📊 数据分析模块增强
- **ETL 缓存持久化**：节点执行结果支持 Parquet 格式磁盘缓存，服务重启后可自动恢复，无需重新执行
- **BI 图表渲染优化**：
  - 顺序渲染：使用 `requestAnimationFrame` 避免同时渲染大量图表卡顿
  - 数据缓存：同一数据集多个组件共享缓存（30秒 TTL），减少重复 API 调用
  - 防抖 resize：全局共享 resize 监听器，避免内存泄漏
- **代码重构**：`aggregateData` 函数统一到 `Utils` 工具类，消除 `analysis_chart.js` 与 `analysis_bi.js` 中的重复实现

### 🧪 模块测试规范
- **测试目录结构**：测试文件放置在模块内部 `tests/` 目录下，模块删除时测试自动清理
- **单元测试覆盖**：为数据分析模块编写 26 个 ETL 算子单元测试，覆盖过滤、选择、去重、排序、聚合、采样、限制、类型转换、空值填充、重命名、清洗等算子

### 📖 开发规范更新
- **manifest.py 完整示例**：补充 `version`、`description`、`author`、`ModuleAssets`、`dependencies`、`kernel_version`、`enabled` 字段及生命周期钩子绑定
- **新增「4.4 模块测试规范」章节**：包含测试目录结构、代码示例、运行命令
- **模块内部结构表格更新**：添加 `tests/` 目录说明，`{id}_services.py` 说明复杂模块可拆分多个 service 文件
- **模块模板检查清单更新**：新增「生命周期钩子已绑定」和「tests/ 目录」检查项

### 🔧 模块热插拔修复
- **analysis 模块**：添加缺失的 `__init__.py` 文件
- **manifest 规范化**：更新 `analysis_manifest.py` 结构，与其他模块保持一致

---

## v2.0.8 (2025-12-20) - 数据分析与 BI 可视化增强

### 📊 图表分析功能
- **基础图表**：新增柱状图、饼图、折线图、散点图四种基础图表类型
- **高级图表**：
  - 📶 **直方图**：数据分布分析，自动分箱
  - 📦 **箱线图**：五数概括与异常值检测
  - 🔥 **热力图**：多字段相关性矩阵可视化（皮尔逊系数）
  - 🔮 **趋势预测**：基于移动平均的简单预测
- **图表引擎**：集成 ECharts 5.4.3，支持深色主题与响应式

### 🎯 BI 仪表盘模块
- **代码分离**：独立 `analysis_bi.js` 模块，便于维护扩展
- **仪表盘管理**：创建/删除/保存仪表盘，数据持久化至 LocalStorage
- **可视化组件**：支持柱状图、折线图、饼图、仪表盘等组件
- **编辑模式**：添加/删除/配置组件，支持多种尺寸（小/中/大/宽）
- **网格布局**：6列响应式网格系统，自动适配不同屏幕

### 🐛 主题样式修复
- **Dock 提示框**：修复深色主题下 tooltip 文字为黑色看不清的问题
- **按钮文字**：修复系统深色模式下按钮文字颜色未正确定义的问题

### 📁 新增文件
- `frontend/js/pages/analysis_bi.js` - BI 仪表盘组件
- `frontend/css/pages/analysis_bi.css` - BI 仪表盘样式

---

## v2.0.7 (2025-12-19) - 性能深度优化与品牌视觉提升
- 🚀 **后端全量 N+1 优化**：
    - **覆盖公告与反馈**：继笔记与博客后，全面修复公告 (Announcement) 与反馈 (Feedback) 模块的 N+1 查询问题。通过 ORM 显式联表加载 `selectinload`，确保获取列表和详情时，作者、处理人等关联信息一并加载，大幅降低数据库 IO。
- 📂 **存储结构优化**：
    - **统一备份目录**：将原本散落在 `backend/` 下的 `module_db_backups` 迁移至根目录 `storage/backups/modules`，实现了数据与代码的物理隔离，使后端目录更加纯净。
- 🎨 **品牌视觉识别增强**：
    - **全站图标同步**：在登录页与主页顶部栏引入 🌐 品牌图标，替换了临时的 Emoji。
    - **登录页 Logo**：支持自定义 Logo 图片展示，提升了系统的产品化质感。
- 🐛 **系统稳定性与兼容性**：
    - **Windows 环境适配**：修复了在 Windows 下通过应用市场上传模块包时，由于文件句柄未及时释放导致的“压缩包损坏”错误。
    - **冗余路由清理**：移除 `routers/health.py`，统一归并至 `core/health_checker.py`，减少维护成本。
- 🧪 **测试覆盖**：
    - 运行 `pytest` 通过全部 65 项后端单元测试，确保系统核心逻辑稳健。


## v2.0.6 (2025-12-18) - 系统性能优化与安全加固
- 🚀 **后端查询性能飞跃**：
    - **解决 N+1 问题**：重构笔记 (Notes) 与博客 (Blog) 模块的底层 ORM 模型关联，引入 `selectin` 预加载技术，将原本随列表规模线性增长的数据库请求压缩为常数级，列表加载速度平均提升 200%+。
    - **逻辑精简**：移除路由层冗余的循环异步查询，全面由 ORM 关系驱动数据填充。
- 🛡️ **底层安全加固**：
    - **Zip Slip 防御**：应用市场在安装 `.jwapp` 离线包时新增路径合法性校验，彻底封堵利用恶意相对路径进行系统文件篡改的漏洞。
- 🎨 **界面一致性与细节打磨**：
    - **视觉统合**：统一博客、公告管理页面的功能图标，将各类“新建/发布”操作图标统合为 `➕`，增强系统视觉连贯性。
    - **布局修复**：修复笔记页面在不同窗口尺寸下的弹性高度问题，确保侧边栏和主区域始终填满窗口且无溢出。
    - **浏览器兼容**：针对现代浏览器补全了 CSS 属性规范（如 `line-clamp`），消除检查警告并提升兼容性。
- 🧹 **代码质量改进**：
    - **冗余代码清理**：彻底移除已弃用的国际化 (i18n) API 及相关样式残留，保持代码库纯净。
    - **性能调优**：优化公共前端组件的加载逻辑，减少不必要的 DOM 重绘。

## v2.0.5 (2025-12-18) - 导航整合与笔记体验优化
- 🧭 **系统导航深度整合**：
    - **单一入口化**：侧边栏、开始菜单、Dock 菜单全面简化，不再显示繁琐的子菜单。
    - **一致性体验**：所有应用均通过主页面进入，子功能按键统一移至页面头部操作区，符合原生桌面操作逻辑。
    - **逻辑优化**：遵循 WebOS 窗口化逻辑，彻底移除所有应用子页面的返回按钮，界面更加清爽专业。
- 📝 **笔记模块 (Notes) 重构**：
    - **布局调整**：将“新建笔记”与“新建文件夹”按钮从侧边栏移至主视图头部右侧，保持与博客、公告等应用的一致性。
    - **导航优化**：侧边栏现在专注于目录树和快捷筛选（收藏、标签），布局更加整洁。
- 🏪 **应用中心 (App Center) 优化**：
    - **入口统一**：应用网格取消子菜单弹出，点击图标直接进入应用主页。
    - **路径修复**：补全了公告及其他动态模块的跳转路径映射，修复跳转失效问题。
- 🔧 **系统管理逻辑清晰化**：
    - 统一重命名“系统管理”相关入口，内部整合系统设置、日志、监控与备份，形成闭环管理体验。

## v2.0.4 (2025-12-18) - 控制面板与体验增强
- 🎛️ **用户管理控制面板**：
    - **快速创建用户**：管理员可直接添加用户，无需注册审核流程。
    - **重置用户密码**：管理员可一键重置任意用户密码。
    - **界面优化**：操作按钮统一调整，新增"添加用户"主操作按钮。
- 🔍 **全局搜索 (Spotlight)**：
    - **聚合搜索**：按下 `Ctrl + K` 或 `Ctrl + Space` 唤起搜索框，可同时搜索应用、系统设置项和云端文件。
    - **快速导航**：支持键盘光标键选择和回车打开，显著提升操作效率。
- 🔔 **通知中心增强**：
    - **通知持久化**：系统通知自动保存到消息中心供随时查阅。
    - **分类图标**：消息列表根据类型显示不同图标。
- 👤 **个人中心优化**：
    - **头像裁切**：上传头像前支持拖拽移动和缩放裁切，确保比例正确。
- 📱 **移动端适配**：
    - 新增全局样式 `mobile.css`，完善 TopBar、Dock 和桌面在小屏幕上的响应式布局。
- 🎨 **主题自动切换**：
    - 支持根据系统深色/浅色偏好自动切换主题。

## v2.0.3 (2025-12-18) - 应用市场功能完善
- 🏪 **应用市场**：
    - **离线安装**：支持通过 `.jwapp` 离线包上传安装第三方模块。
    - **规范化流程**：上传后模块处于"待安装"状态，需手动点击安装。
    - **创建应用**：支持一键创建新模块模板，自动生成前后端代码。
    - **删除应用**：支持完全删除未安装的模块。
- 🔧 **组件增强**：
    - **Toast.loading**：新增加载中提示组件，支持动态更新和手动关闭。

## v2.0.2 (2025-12-17) - 快传模块上线
- ⚡ **快传功能**：支持局域网内设备间高速文件传输，具备传输码机制与实时进度同步。
- 🎨 **界面优化**：全新设计的文件上传拖拽区域与传输历史列表。

## v2.0.1 (2025-12-16) - 文件管理与体验增强
- 📁 **文件管理增强**：新增右键菜单、拖拽移动、配额监控与增强的预览支持。
- 📝 **规范化**：统一系统各处功能名称，完善帮助中心文档。

## v2.0.0 (2025-12-15) - 统一发布版本
- ✨ **核心特性**：全新多窗口系统 (Multi-Window System)，支持窗口最小化、最大化、自由缩放与智能层级管理。
- 🎨 **体验优化**：Dock 栏指示器修复，浏览器地址栏同步功能。
