## [v2.5.11] - 2026-02-05 (文件夹批量上传与下载功能)

### 📁 文件管理功能增强 (FileManager Enhancement)

#### ✨ 新增功能
- **文件夹上传**: 新增"上传文件夹"按钮，支持选择整个文件夹进行上传，自动保持原有目录结构
  - 使用 `webkitdirectory` 属性支持浏览器原生文件夹选择
  - 自动递归创建子文件夹，按层级顺序处理
  - 显示上传进度和创建的文件夹数量
  - 智能文件名提取：从相对路径中正确提取文件名
- **文件夹下载**: 支持选中文件夹后一键下载，自动打包为 ZIP 文件
  - 递归收集文件夹下所有文件
  - 保持完整的目录结构
  - ZIP 文件名包含时间戳，避免重名
  - 流式传输，支持大文件夹

#### 🔧 交互优化
- **工具栏按钮组**: "上传文件"和"上传文件夹"采用 Flex 按钮组形式，水平排列，视觉更统一
- **下载按钮改进**: 下载按钮现在同时支持文件和文件夹（选中文件夹时自动打包）
- **右键菜单增强**: 右键菜单的"下载"选项现在同时支持文件和文件夹

#### 🐛 问题修复
- **文件名解析修复**: 修复了文件夹上传时文件名包含相对路径（如 `folder/file.txt`）导致显示错误的问题
- **文件夹创建修复**: 修复了数据库会话引用错误导致子文件夹无法正确创建的问题
- **按钮布局修复**: 修复了上传按钮组垂直叠放的样式问题，现采用水平 Flex 布局

#### 🛠️ 技术实现
- **前端**: 
  - 新增 `uploadFolder()` 和 `downloadFolder()` 方法
  - 通过 `webkitRelativePath` 解析目录结构
  - 新增 `canDownloadAny()` 和 `downloadSelected()` 方法统一处理下载逻辑
- **后端**: 
  - 新增 `POST /filemanager/upload/folder` 接口，支持批量创建目录并上传文件
  - 新增 `GET /filemanager/folders/{id}/download` 接口，递归打包文件夹为 ZIP
  - 新增 `_process_single_file_with_name()` 辅助函数，支持覆盖文件名

---


## [v2.5.10] - 2026-02-03 (图标体系统一与 UI 一致性优化)

### 🎨 图标体系统一化 (Icon System Unification)
- **Emoji 全面替换**: 将系统中大量使用的 Emoji 图标统一替换为 Remix Icons，确保跨平台显示一致性与视觉统一性。
  - **帮助中心 (help.js)**: 替换了快速入门、桌面环境、用户管理、系统设置、安全与权限、快捷键、常见问题、系统主题等模块的导航图标。
  - **系统监控 (monitor.js)**: 替换了 CPU、内存、磁盘、服务状态、进程信息、系统信息等卡片的标题图标。
  - **数据报表 (import-export.js)**: 替换了用户数据、通知数据、文件记录等数据导出卡片及按钮图标。
  - **数据建模 (analysis_modeling.js)**: 替换了模型管理、ETL 算子库、工具栏按钮、连线配置面板等大量 UI 元素图标。
- **图标类名修复**: 修复了帮助中心"安全与权限"菜单项因使用不存在的图标类名 (`ri-shield-key-line`) 导致图标不显示的问题，更正为正确的 `ri-shield-keyhole-line`。

### 🔧 细节优化 (Minor Improvements)
- **视觉一致性**: 所有替换后的图标与系统设计语言保持一致，采用 Remix Icon 的 Line 风格变体。
- **顶部通知图标区分**: 将顶部状态栏的通知图标从铃铛 (`ri-notification-3-line`) 改为信封 (`ri-mail-line`)，与通知应用的铃铛图标形成视觉区分，更符合"收到的消息"语义。
- **代码规范**: 清理了搜索框中的 Emoji 占位符，改用纯文本提示。



### 🏗️ 架构重构 (Architecture Refactor)
- **目录结构优化**: 移除了 `backend/services` 目录，将备份服务逻辑迁移并整合至 `backend/utils/backup_executor.py`，进一步扁平化项目结构，提升代码可维护性。
- **单元测试覆盖**: 
    - 新增核心模块自动化测试套件 (`tests/test_roles.py`, `tests/test_system_settings.py`, `tests/test_backup_executor.py`)。
    - 实现了对角色权限、动态配置、备份调度等关键业务逻辑的 100% 测试覆盖。
    - 解决了 SQLite 测试环境下的兼容性问题，确保测试稳定可靠。

### ⚙️ 系统配置动态化 (Dynamic Configuration)
- **JWT 动态有效期**: JWT 过期时间 (`jwt_expire_minutes`) 现支持通过系统设置动态调整，无需重启服务即可即时生效，极大提升了运维灵活性。
- **密码策略同步**: 密码最小长度 (`password_min_length`) 实现前后端动态同步。前端（用户创建、重置、修改密码）会自动读取系统设置进行校验，后端同步执行强制检查。
- **速率限制热更新**: API 速率限制参数（请求数、窗口时间、封禁时长）及白名单配置现已完全接入动态配置系统，支持运行时热调整。

### 📡 实时通信增强 (Real-time Communication)
- **配置广播机制**: 基于 WebSocket 实现了 `system.settings_updated` 事件广播。当管理员修改系统设置时，所有在线客户端会自动更新本地 Store 配置，确保系统状态的全局一致性。

### 🚀 性能与稳定性 (Performance & Stability)
- **角色管理优化**: 重构了角色列表查询逻辑，使用批量查询替代循环查询，彻底消除了 N+1 性能瓶颈。
- **数据完整性**: 
    - 修复了删除角色时未清理用户关联数据的问题，增加了自动清理逻辑。
    - 修复了审计日志导出时的关键词过滤失效问题。
    - 修复了 SQL 查询构建中的 `or_` 导入缺失 Bug。
- **API 健壮性**: 修复了系统设置和角色管理接口在特定场景下的 307/405 重定向问题，提升了接口兼容性。

### 📖 文档更新 (Documentation)
- **全模块帮助更新**: 全面更新了系统设置、审计日志、数据备份、用户管理与角色管理等 5 个核心模块的帮助文档，精准反映了最新的功能特性与配置逻辑。

## [v2.5.8] - 2026-02-03 (数据备份高级功能与体验优化)

### 💾 数据备份核心升级 (Backup Core Upgrade)
- **🔒 备份加密**: 支持手动备份时设置 AES 加密密码，保障数据安全；列表显示加密状态锁图标。
- **⏰ 自动调度**: 新增自动备份计划管理，支持按日/周/月定时执行全新/增量备份。
- **🔧 调度管理**: 提供可视化的调度计划列表，支持创建、编辑、删除及一键启用/禁用计划。
- **📝 备份备注**: 创建备份时支持填写备注，列表直观展示。

### 🔄 体验优化 (UX Improvements)
- **🔙 快捷返回**: 系统日志、系统监控、数据备份页面新增返回按钮，一键回到系统设置页。
- **🎨 界面重构**: 备份页面采用 Tab 切换设计，分离"手动备份"与"自动调度"管理。
- **📱 响应式适配**: 优化监控和日志页面的头部布局，更好地适配移动设备。

### [v2.5.7] - 2026-02-03 (系统管理功能全面优化)

### 🔧 系统设置页面优化 (System Settings Enhancement)
- **卡片化布局**: 设置项分组为独立卡片（基础设置、安全策略、速率限制、AI 配置），清晰直观。
- **API Key 保护**: AI 配置中的 API Key 新增显示/隐藏切换按钮，防止敏感信息泄露。
- **图标化设计**: 全部按钮和分区标题使用 Remix Icons，视觉更现代。
- **栅格布局**: 设置项采用响应式栅格排列，移动端自动单列适配。

### 📜 系统日志功能增强 (Audit Logs Enhancement)
- **时间范围筛选**: 新增开始时间和结束时间日期选择器，支持精确时间段查询。
- **Excel 导出**: 一键导出当前筛选条件下的日志为 Excel 文件（最多 10000 条）。
- **日志详情弹窗**: 点击操作列查看按钮可打开日志详情，完整展示消息和 User-Agent。
- **重置筛选**: 新增"重置"按钮，一键清空所有筛选条件。
- **后端优化**: 统一查询条件构建逻辑，支持 `start_time` 和 `end_time` 参数。

### 📊 系统监控页面优化 (System Monitor Enhancement)
- **页面标题改进**: 新增副标题显示自动刷新频率（每30秒）。
- **图标化按钮**: 刷新按钮使用 Remix Icons。
- **响应式布局**: 页面头部自动换行适配移动端。

---

## [v2.5.6] - 2026-02-03 (用户管理功能全面增强)

### 👥 用户管理深度优化 (User Management Enhancement)
- **批量操作能力**:
    - **全选与多选**: 列表新增复选框列与“全选/反选”功能。
    - **悬浮操作栏**: 选中用户后自动显示批量操作栏，支持“批量启用”、“批量禁用”及“批量删除”。
    - **智能策略**: 批量操作自动跳过超级管理员及当前登录账号，防止误操作。
- **高级筛选系统**:
    - **多维度过滤**: 新增“用户组 (Role ID)”筛选功能，支持按特定角色精准查找。
    - **后端查询增强**: 扩展 API 支持按注册时间及最后登录时间范围进行联合查询。
- **交互与视觉升级**:
    - **操作按钮收纳**: 引入下拉菜单机制，将“重置密码”、“删除”等低频敏感操作收纳至菜单中，简化表格布局。
    - **活跃度监控**: 列表新增“最后登录”统计列，方便管理员快速识别僵尸用户。
    - **图标化设计**: 全面切换为 Remix Icons 图标化按钮，增加 Hover 文字提示，视觉更清爽。
- **底层架构重构**:
    - **Schema 强校验**: 引入 Pydantic 专用 Schema (`UserProfileUpdate`, `UserBatchAction`)，完善后端参数校验机制。
    - **性能保护**: 调整 API 默认分页上限，降低极端查询场景下的服务器负载。
- **帮助文档同步**: 全面更新用户管理模块帮助指南，涵盖批量操作、高级筛选及权限管理说明。

---

## [v2.5.5] - 2026-02-03 (公告与通知功能增强)

### 📢 公告模块增强 (Announcement Enhancement)
- **富文本编辑器**: 集成 Markdown 所见即所得编辑器，支持标题、列表、代码块、表格等丰富格式。
- **多媒体支持**: 新增图片上传功能，支持拖拽、粘贴、点击上传，实现图文混排。
- **权限管控**: 
  - 细化权限控制，普通用户仅拥有查看权限，界面自动隐藏管理入口。
  - 管理员拥有完整发布、编辑、删除权限。
- **批量操作**: 新增列表批量操作栏，支持批量发布、取消发布及删除。
- **体验优化**: 
  - 移动端适配：列表在移动端自动切换为卡片式布局，操作按钮触控优化。
  - 状态标签中文化：统一使用中文状态标签（发布/草稿/置顶）。

### 🔔 通知系统升级 (Notification Upgrade)
- **TopBar 交互进化**: 
  - **悬浮快捷操作**: 顶部通知下拉面板新增悬浮操作栏，支持直接“标记已读”和“删除”。
  - **无感刷新**: 操作后列表局部静默更新，无需跳转页面，体验更流畅。
- **通知中心优化**:
  - **移动端适配**: 列表项响应式布局，小屏模式下操作按钮自动常驻。
  - **视觉统一**: 优化通知图标与颜色体系，与系统设计语言保持一致。
- **帮助文档**: 新增通知中心使用指南，更新公告模块帮助文档。

---

## [v2.5.4] - 2026-02-02 (搜索组件统一与功能修复)

### 🔧 功能修复 (Bug Fixes)

#### 🔍 博客模块搜索修复
- **搜索功能修复**: 修复了博客文章列表页面搜索功能失效的问题，确保搜索框能够正确触发文章筛选

#### 📚 知识库模块搜索修复
- **API 调用修复**: 修复了知识库搜索功能中 API 调用参数错误的问题
- **向量库兼容性**: 解决了与 ChromaDB 向量存储的兼容性问题
- **错误处理增强**: 优化了模型加载和数据索引过程中的错误处理机制

#### 👥 用户管理界面修复
- **布局修复**: 修复了用户管理页面元素错位的问题，确保表格和操作按钮正确对齐

### 🎨 界面体验优化 (UI/UX Enhancement)

#### 🔍 搜索组件统一化
- **全局搜索样式**: 将多个模块的搜索组件统一为全局风格（输入框 + 搜索按钮）
- **数据透镜**: 更新数据管理页面搜索组件，采用统一的搜索输入框和按钮结构
- **日程管理**: 优化日程管理模块的搜索输入框和按钮显示，修复侧边栏内按钮显示问题
- **在线考试**: 更新题库和试卷搜索界面，添加 Enter 键触发搜索支持

---

## [v2.5.3] - 2026-01-31 (代码质量与性能优化)

### 🚀 性能优化 (Performance Optimization)

#### ⚡ 前端资源加载优化
- **JS 延迟加载**: 为所有非核心脚本添加 `defer` 属性（约 60 个文件），允许浏览器在解析 HTML 的同时并行下载脚本，消除渲染阻塞。
- **CSS 按需加载**: 新增 `ResourceLoader` 资源加载器 (`loader.js`)，实现模块级 CSS 的懒加载。非首屏样式（如数据分析、PDF 工具等 30+ 模块）仅在用户访问对应路由时动态加载。
- **首屏样式精简**: 将首屏必需的 CSS 从 92 个文件精简至 31 个（核心样式 + 组件样式 + 基础页面样式）。
- **第三方库延迟**: 将 Leaflet、ECharts 等大型第三方库改为 `defer` 加载，进一步加速首屏渲染。
- **智能预加载**: 支持在浏览器空闲时预加载常用模块样式（文件管理、笔记、AI 助手），提升后续访问体验。
- **DNS 预获取与资源预加载**: 新增 DNS 预解析 (`dns-prefetch`) 与预连接 (`preconnect`)，提前解析第三方域名；扩展核心资源预加载范围，包括核心 CSS、JS 及 Logo 图片。
- **图片懒加载组件**: 新增 `LazyLoader` 图片懒加载工具 (`lazy_loader.js`)，基于 IntersectionObserver API 实现高性能图片懒加载，支持自动观察 DOM 变化、优雅降级、加载动画及错误处理。

#### ⚡ Service Worker 增强
- **预缓存资源扩展**: 将 Service Worker 预缓存列表从 27 个资源扩展至 70+ 个核心资源，涵盖入口页面、图片资源、核心 CSS/JS、组件脚本及第三方库，显著提升 PWA 离线可用性。
- **缓存版本更新**: 自动更新缓存版本号，确保用户获取最新资源。

#### ⚡ 数据库连接池增强
- **连接池参数完善**: 在 `database.py` 中新增 `pool_recycle=3600` 和 `pool_timeout=30` 配置，防止 MySQL `wait_timeout` 导致连接失效，并限制获取连接的最大等待时间。
- **配置参数化**: 将连接池大小 (`DB_POOL_SIZE`)、溢出连接数 (`DB_MAX_OVERFLOW`) 和回收时间 (`DB_POOL_RECYCLE`) 移至配置文件管理，支持通过环境变量灵活调整，提升高并发场景下的数据库性能调优能力。
- **详细参数注释**: 为所有连接池参数添加了中文注释说明，便于后续维护和调优。

#### 🔄 权限缓存策略增强
- **缓存容量扩展**: 将权限缓存容量从 1000 提升至 2000，缓存时间从 60 秒延长至 120 秒，减少高并发场景下的数据库查询压力。
- **主动失效机制**: 新增 `invalidate_permission_cache(user_id)` 函数，支持在修改用户权限后主动清除缓存，实现权限变更即时生效。

### 🧹 代码质量提升 (Code Quality)

#### 🏗️ 前端目录结构重构
- **Utils 目录合并**: 移除了 `frontend/js/utils/` 目录，将其内容按功能归类到更规范的目录中，使项目结构更加清晰：
  - `lazy_loader.js`, `shortcut_manager.js` → 移入 `core/` (核心工具)
  - `chart/` (图表工具), `module_help/` (帮助系统) → 移入 `components/` (组件支持)
- **引用路径更新**: 全量更新了 `index.html` 和 `sw.js` 中的脚本引用与缓存路径，确保无需改动业务逻辑即可平滑迁移。

#### 🔧 空异常捕获修复
- **问题**: 修复了多处静默的 `except: pass` 模式，这种模式会吞掉异常导致问题难以排查。
- **修复范围**:
  - `lm_cleaner_services.py`: 临时文件清理、源文件删除
  - `import_export.py`: Excel 列宽计算
  - `monitor.py`: 系统监控信息获取
  - `storage.py`: 路径安全检查
- **改进**: 改为记录 `debug` 级别日志，既不影响正常流程，又便于问题排查。

#### 📦 通用分页助手函数
- **新增函数**: 在 `core/pagination.py` 中新增 `paginate_model()` 通用分页查询助手。
- **功能**: 封装了各模块 Service 层重复的分页逻辑（条件构建、总数统计、排序、分页），简化代码。
- **用法示例**:
  ```python
  from core.pagination import paginate_model
  
  items, total = await paginate_model(
      db, User,
      conditions=[User.is_active == True],
      order_by=User.created_at.desc(),
      page=page, page_size=page_size
  )
  ```

### 🛡️ 项目安全加固 (Project Security)

#### 🚫 敏感文件忽略
- **Git 忽略规则更新**: 更新 `.gitignore` 规则，强制忽略 `deployment/env_docker` 和 `docker/env_docker` 等包含真实部署密钥的配置文件。
- **保留示例**: 确保 `*.example` 模板文件可正常提交，兼顾安全与协作便利性，防止生产坏境密钥意外泄露到代码仓库。

### 📖 文档更新 (Documentation Update)

#### 📝 开发规范完善
- **规范同步**: 将近期版本的重要优化全量同步至《开发规范.md》，涵盖：
  - **异常处理**: 明确禁止空捕获，规范日志记录。
  - **分页查询**: 统一使用 `paginate_model` 助手。
  - **数据库连接池**: 规范连接回收与超时参数。
  - **安全开发**: 新增 3.9 节，涵盖 Fernet 加密存储、前端零信任及 HSTS 规范。
  - **权限计算**: 明确了“用户组 + 个人权限”的并集逻辑。
  - **前端性能**: 新增 5.5 节，整合了 CDN 预解析、资源延迟加载 (`defer`) 和图片懒加载规范。
  - **目录结构**: 更新了前端 JS 目录的四层架构定义，移除了已废弃的 `utils` 目录。

### 🎨 界面体验优化 (UI/UX Enhancement)

#### 🇨🇳 界面汉化
- **通知中心状态标签**: 将通知列表中的状态标签（如 `success`, `error`, `warning`）由英文代码修改为对应的中文显示（成功、错误、警告），提升了界面的友好度和专业性。

---

## [v2.5.2] - 2026-01-31 (AI 模块安全架构升级)

### 🛡️ AI 安全架构升级 (Security Architecture Upgrade)

#### 🔐 零信任密钥管理
- **数据库级加密**: 新增 `sys_secrets` 专用表，采用 **Fernet (AES-128)** 算法对 AI API Key 等敏感配置进行强加密存储。密钥由系统 `JWT_SECRET` 自动派生，无需额外配置。
- **前端零存储**: 彻底移除了 LocalStorage 中的明文 API Key 存储逻辑。前端仅持有配置状态（已配置/未配置），真实 Key 永不落盘，彻底杜绝了因 XSS 攻击或设备借用导致的 Key 泄露风险。
- **透明代理机制**: 因为安全考虑，前端发起聊天请求时不再携带 API Key。后端网关会自动识别当前用户，从数据库即时解密 Key 并代理转发请求，确保 Key 在传输层和存储层的绝对安全。

### 🧹 代码清理 (Code Cleanup)
- **移动端残留清理**: 清理了 AI 页面 (`ai.js`) 及样式表 (`desktop.css`) 中关于移动端适配的废弃代码（如 `hide-mobile` 类），进一步精简代码库。

### 🐛 问题修复 (Bug Fixes)
- **权限模块修复**: 修复了 `backend/core/security.py` 中 `require_manager` 依赖的 `manager_checker` 函数定义丢失导致的 `NameError` 启动报错，恢复了业务管理员权限校验逻辑。

---

## [v2.5.1] - 2026-01-31 (在线考试模块视觉优化与关键修复)

### 🐛 关键修复 (Critical Fixes)
- **窗口管理器 (Window Manager)**: 修复了窗口关闭过程中（动画未结束时）触发拖拽事件导致的 `TypeError` 崩溃问题。增加了对窗口实例存在性的空值检查，增强了 UI 交互的鲁棒性。

### 📝 在线考试模块优化 (Exam Module Enhancement)

#### 🎨 界面视觉升级 (UI/UX Upgrade)
- **首页 Hero 背景优化**: 重新设计了“考试中心”首页的 Hero 区域背景。
    - 将原有的亮蓝色渐变替换为深邃的暗蓝色至黑色的高级渐变 (`#1a1c2e` 到 `#161b22`)。
    - 引入了**玻璃拟态 (Glassmorphism)** 设计，为统计卡片添加了磨砂质感、半透明边框及优雅的悬停位移效果。
    - 添加了细腻的背景装饰性柔光，增强界面层次感与高级感。
- **帮助按钮视觉强化**: 优化了导航栏“帮助”按钮的可见性。
    - 为按钮添加了半透明边框与背景色，解决了其在深色背景下“融为一体”的问题。
    - 图标颜色回归系统统一样式，确保视觉风格的连贯性。
- **错题本布局调整**: 
    - 将“我的错题本”视图由居中改为**左对齐**，使标题与上方导航栏视觉对齐，整体布局更加自然、专业。
    - 微调了错题本区域的最大宽度，提升大屏幕下的浏览体验。

#### 🔧 代码规范与修复
- **CSS 规范化**: 修复了样式表中的 CSSLint 警告，补全了标准的 `background-clip: text` 属性以增强浏览器兼容性。

---

## [v2.5.0] - 2026-01-30 (后端核心与模块单元测试)

### 🧪 后端自动化测试 (Backend Unit Testing)

#### 🚀 核心模块覆盖
- **分页组件 (`test_pagination`)**: 全面测试 `PaginationParams` 模型、内存列表分页及数据库 Mock 分页逻辑，修复 MagicMock 在 SQLAlchemy 中的验证问题。
- **限流系统 (`test_rate_limit`)**: 验证 IP 白名单/黑名单机制、滑动窗口算法及封禁自动解除逻辑。
- **变更日志 (`test_changelog`)**: 覆盖版本变更记录的解析、比较与获取最新版本逻辑。
- **CSRF 防护 (`test_csrf`)**: 测试 Token 生成、验证、过期机制及中间件拦截逻辑。
- **错误处理 (`test_errors`)**: 验证自定义异常 (`AppException`) 到 HTTP 响应的转换及统一错误码处理。

#### 📦 业务模块覆盖
- **数据分析 (`analysis_tests`)**: 针对 `ModelingService` 实现了数据集获取、相关性分析、SQL 安全执行及模型 CRUD 的完整 Mock 测试。
- **即时通讯 (`im_tests`)**:
    - **消息加密**: 验证 Fernet 加密算法在消息收发过程中的正确性。
    - **会话管理**: 测试私聊/群聊创建逻辑、成员权限校验。
    - **消息生命周期**: 覆盖消息发送、未读计数更新及消息撤回（超时/权限）逻辑。

---

## [v2.4.22] - 2026-01-30 (性能与安全优化)

### 🚀 性能优化 (Performance Optimization)

#### ⚡ 权限系统缓存 (Permission Caching)
- **内存级缓存**: 在 `backend/core/security.py` 中引入了 `cachetools.TTLCache`，为用户权限和角色信息实现了 60 秒的内存级缓存。
- **减少数据库压力**: 在高并发请求下，显著减少了重复查询数据库获取用户权限的频率，提升了接口响应速度。

### 🛡️ 安全增强 (Security Enhancement)

#### 🔒 HSTS 强制安全传输
- **HTTP Strict Transport Security**: 在 `SecurityHeadersMiddleware` 中默认启用了 `Strict-Transport-Security` 响应头 (有效期 1 年)。
- **安全保障**: 强制客户端在首次通过 HTTPS 访问后，后续所有请求自动升级为 HTTPS，有效防止中间人攻击 (MITM) 和协议降级攻击。

### 📖 文档与部署 (Documentation & Deployment)

#### 🌐 HTTP/2 部署指南
- **Ubuntu 部署手册更新**: 在 `deployment/Ubuntu部署指南.md` 中新增了 "启用 HTTPS 与 HTTP/2" 章节。
- **性能飞跃**: 详细指导如何通过 Nginx 配置开启 HTTP/2 协议，显著提升多文件并发加载时的页面响应速度。

---

## [v2.4.21] - 2026-01-30 (移动端代码清理与代码规范检查)

### 🧹 移动端代码深度清理 (Mobile Code Cleanup)

#### 🚀 移除过时逻辑
- **移动端适配移除**: 彻底移除了 WebOS 对移动端的适配代码，专注于提升桌面端用户体验。
    - 删除了 `mobile.css` 样式文件。
    - 移除了 `window_manager.js` 中关于触摸事件和移动端窗口调整的冗余逻辑。
    - 移除了 `ai.js` 中的移动端检测与适配逻辑。
    - 清理了 HTML 模板中针对移动端的 viewport meta 标签配置。

### 📝 代码规范与文档增强 (Documentation & Standards)

#### 🛡️ 后端代码质量
- **Docstring 全覆盖**: 完成了对后端所有 Python 模块（`backend/`）的代码文档检查。
    - 确保所有 `.py` 文件均包含规范的文件级 Docstring，明确文件用途。
    - 修复了部分遗漏文档的模块，提升了代码的可维护性与可读性。

---

## [v2.4.20] - 2026-01-30 (数据库迁移架构合并与文件管理修复)

### 🗄️ 数据库架构深度优化 (Database Schema Consolidation)

#### 🚀 迁移合并 (Migration Merge)
- **初始架构统一**: 实施了数据库迁移架构的“大合并”策略。将分散在多个版本中的 `fm_folders` 列扩展、`pdf_history` 表创建、`pdf_items` 表创建及其所有索引和注释，全量整合进了 `215f47284b32_initial_schema_production.py` 初始迁移文件中。
- **全新部署能力**: 支持在新环境下通过 `alembic upgrade head` 命令实现一键、完整、带注释的数据库初始化，彻底避免了因中间迁移 ID 丢失或冲突导致的部署失败。
- **清理冗余**: 彻底清理了 `alembic/versions` 目录下已失效的中间迁移脚本，保持代码库的极简与专业性。

#### 🔧 关键修复 (Critical Fixes)
- **文件管理器 500 错误维护**: 彻底解决了部署到生产服务器后，文件管理模块因 `fm_folders` 表缺少 `is_virtual`, `is_system`, `icon`, `module_id`, `module_path` 等字段导致的 SQL 500 (Internal Server Error) 崩溃。
- **PDF 模块稳定性**: 确保了 PDF 操作历史及扩展项目所需的表结构在系统启动之初就已就绪，消除了因表不存在导致的运行时异常。

---

## [v2.4.19] - 2026-01-30 (权限提示遮挡修复与设置逻辑优化)

### 🛡️ 权限系统修复与体验优化 (Permission System Fixes & UX)

#### 🎨 界面显示优化 (UI/UX)
- **消息提醒层级修复**: 修正了全局消息通知 (Toast) 的 `z-index` 配置。解决了在打开模态弹窗（如权限设置、用户编辑等）时，操作成功/失败的提示由于层级过低被黑色遮罩层覆盖的问题，确保反馈结果始终可见。
- **权限设置功能增强**: 
    - **全选功能**: 在用户权限设置和用户组管理弹窗中，为每个模块新增了“全选”功能，支持一键快速勾选或取消勾选该模块下的所有子功能权限，极大提升了配置效率。
    - **UI 视觉增强**: 优化了子功能权限的分组展示，增加了分区块背景、边框及强调色标题，使复杂的权限列表更加层次分明。
- **逻辑优化与同步**: 
    - 修复了用户管理页面「设置权限」弹窗中，切换“用户组”后下方权限列表不刷新的问题。
    - 优化了用户组编辑器（Modal）的事件绑定机制，解决了动态重渲染后事件处理器可能失效的隐患。

#### 🔧 后端接口稳健性 (Backend Robustness)
- **数据容错增强**: 优化了 `update_permissions` 接口。新增对用户组 ID 的强制类型转换与校验，解决了因前端传输格式偏差可能导致的权限更新失败问题。
- **校验逻辑优化**: 优化了后端对用户组权限上限的校验流程，增强了处理直接权限收紧时的逻辑鲁棒性。

---

## [v2.4.18] - 2026-01-29 (系统核心模块单元测试)

### 🧪 核心架构自动化测试 (Core Architecture Testing)

#### 🚀 核心覆盖
- **数据库管理 (`test_database`)**: 实现了针对异步数据库引擎、会话生成器及上下文管理器的专项测试，验证了数据库连接池、事务回滚及 Base 元数据状态。
- **缓存系统 (`test_cache`)**: 通过 Mock Redis 机制，全面验证了 `Cache` 类的 `set/get/delete/exists` 等核心操作，以及初始化失败的健壮性处理。
- **审计日志工具 (`test_audit`)**: 针对 `DataMasker` 感数据脱敏逻辑（密码、手机号、Token 等）和 `AuditLogger` 的批量/立即写入流程进行了 100% 逻辑覆盖。
- **任务调度器 (`test_scheduler`)**: 验证了异步周期性任务的调度、执行频率及调度器的平滑启动与停止机制。
- **WebSocket 管理器 (`test_ws_manager`)**: 实现了单人消息推送、全量广播、在线用户追踪以及连接生命周期管理的完整闭环测试。
- **生命周期引导 (`test_bootstrap`)**: 验证了系统首次启动时的管理员账户自动初始化（含密码复杂度与冲突检测）及默认角色模板（admin/user/guest）的构建逻辑。
- **健康检查 (`test_health_checker`)**: 实现了对数据库、Redis、磁盘及内存状态的异步并发检测测试，覆盖了健康（Healthy）、降级（Degraded）及不健康（Unhealthy）三种状态。
- **版本管理 (`test_versioning`)**: 验证了 API 的多版本路由注册、URI 版本号提取及废弃版本响应头（Warning/Deprecation）的注入逻辑。
- **静态资源增强 (`test_static_files`)**: 测试了基于文件后缀的 Cache-Control 策略以及 Gzip 中间件对不同 MIME 类型内容的压缩行为。

#### 🔧 基础设施优化
- **测试环境纯净化**: 移除了 `conftest.py` 中遗留的硬编码全局 Mock，允许核心模块在受控环境下运行真实逻辑测试，同时保证了与其他业务模块测试的兼容性。
- **Mock 模式标准化**: 统一了异步上下文管理器 (AsyncContextManager) 的 Mock 编写规范，解决了测试过程中常见的 `AttributeError` 报错。

---

## [v2.4.17] - 2026-01-29 (知识库模块单元测试完善)

### 🧪 知识库模块自动化测试 (Knowledge Base Testing)

#### 🚀 核心覆盖
- **服务层测试 (`knowledge_services`)**: 实现了 6 个核心测试用例，涵盖知识库 CRUD（增删改查）以及节点生命周期管理。通过 Mock 向量数据库，确保测试在隔离环境下稳定运行。
- **路由层测试 (`knowledge_router`)**: 建立了 2 组端到端 API 测试流，验证了知识库从创建到物理删除的完整生命周期，以及节点的操作逻辑。
- **解析器测试 (`knowledge_parser`)**: 针对 `RecursiveCharacterTextSplitter` 递归分块算法和基础文档解析引擎（TXT、CSV）建立了专项验证，确保长文档处理的可靠性。

#### 🔧 基础设施增强
- **环境隔离优化**: 细化了知识库测试中的向量库 Mock 策略，防止测试运行过程中产生真实的向量索引文件，保持测试环境纯净。
- **断言逻辑修复**: 修正了部分 Service 层删除操作返回值的断言错误，使其与当前业务逻辑完全匹配。

---

## [v2.4.16] - 2026-01-28 (PDF 模块运行故障修复与功能补全)

### 📄 PDF 工具箱深度优化 (PDF Toolbox Optimization)

#### 🔧 关键修复 (Critical Fixes)
- **运行时故障修复**: 彻底解决了 `PdfService` 缺失 `_register_to_filemanager` 方法导致的 `AttributeError` 崩溃。该问题曾导致“PDF 转图片”等核心转换功能完全不可用。
- **VFS 注册机制补全**: 为 PDF 所有的产出操作（合并、拆分、压缩、旋转、水印、加密、解密、格式转换等）补全了文件注册逻辑。所有生成的文件现在都会自动同步到文件管理器的“PDF 工具”目录下，实现了真正的“即产即见”。
- **文件命名一致性**: 统一了产出件的命名与存储路径解析逻辑，确保在 docker 与本地环境下均能正确回显。

#### 📦 部署配置同步 (Deployment Configuration)
- **Docker 镜像标签对齐**: 在 `deployment/docker-compose.yml` 中默认使用 `latest` 标签，方便用户导入本地构建的最新镜像。
- **版本号同步**: 全量更新 `.env`、`env_docker` 为 v2.4.16 版本。

---

## [v2.4.15] - 2026-01-27 (水印清除增强与自动化测试完善)


### 🧹 水印清除模块深度优化 (Watermark Cleaner Enhancement)

#### ✨ 算法革新 (Advanced Algorithm)
- **智能背景侦测**: 引入了基于 OpenCV 的智能背景采样逻辑。系统会自动分析水印周边颜色方差，识别纯色背景与复杂背景。
- **混合修复策略**: 
  - 对于纯色背景（如白底文档），采用**完美像素填充**，无任何模糊感。
  - 对于复杂背景，采用 **Telea Inpainting 算法**进行接缝修复，并精细化 Mask 区域，减少对正文文字的干扰。
- **多格式支持**: 统一了图片（PNG, JPG, WEBP）与 PDF 的处理流程，PDF 处理现已升级为“全页面图像级去水印”方案。

#### 🎨 界面体验 (UI/UX)
- **布局紧凑化**: 优化了历史记录表格布局，支持展示更多记录；修正了表轴对齐问题。
- **交互引导**: 新增全局统一风格的“帮助”弹窗，提供详细的使用指南和注意事项。
- **预览增强**: 优化了查看处理结果的逻辑，现在直接在浏览器内开启预览而非强制下载。

### 🧪 自动化测试体系完善 (Test Suit Expansion)

#### 🚀 核心模块覆盖
- **水印清除 (`lm_cleaner`)**: 实现 8 个核心测试用例，涵盖基础 CRUD 与真实算法处理流程验证。
- **PDF 工具箱 (`pdf`)**: 实现从路由 (Router) 到服务层 (Service) 的 11 个原子化测试用例。
- **Markdown 编辑器 (`markdown`)**: 建立完整的业务逻辑测试集，涵盖文档生命周期管理与统计引擎。

#### 🔧 基础设施增强
- **异步测试底座**: 全面重构为基于 `httpx.AsyncClient` 的异步测试调用体系，彻底解决了旧版 `TestClient` 在某些异步生命周期下的死锁问题。
- **环境隔离策略**: 
  - 增强了 `tmp_workspace` 测试固件，实现了单例模式（Loader & Storage）在测试间的物理重置。
  - 确保了测试产生的数据库记录与物理文件在单次运行后能够被 100% 物理清理。

---

## [v2.4.14] - 2026-01-27 (智能地图显示修复)

### 🗺️ 智能地图模块优化 (Smart Map Enhancement)

#### 🔧 关键修复 (Critical Fixes)
- **渲染架构重构**: 彻底解决了地图模块在 `setState` 时因容器 `innerHTML` 被重写而导致 Leaflet 实例被销毁的问题。通过重写 `update()` 方法实现了侧边栏的局部渲染，确保地图渲染层持久稳定。
- **CSS 渲染保障**:
  - 修正了 `map.css` 中未定义的 `--color-bg-container` 变量，统一使用 `--color-bg-primary`，解决了因变量失效导致的背景遮挡问题。
  - 移除了 `.map-layout` 的绝对定位，优化了在 WebOS 窗口 Flex 布局下的尺寸兼容性。
  - 强制提升了 Leaflet 内部渲染层 (`.leaflet-tile-pane`) 的 `z-index`，确保地图瓦片始终可见。
- **自适应重绘**: 在地图初始化中引入了循环可见性校验逻辑，解决了在窗口淡入动画期间因高度为 0 导致的 Leaflet 指路偏差。

#### 🧹 清理与优化
- **调试日志移除**: 清理了控制台中大量的地图瓦片加载成功、初始化尺寸等开发调试性日志，使系统输出更纯净。
- **布局稳固化**: 移除了 `.map-canvas` 的冗余背景色，改用 `transparent` 以防止在瓦片加载前的视觉遮挡。

---

## [v2.4.13] - 2026-01-26 (课程视频学习增强)

### 🎬 视频学习功能优化 (Video Learning Enhancement)

#### ✨ 新增功能
- **视频进度恢复**: 自动保存视频播放进度（每5秒保存一次），再次学习时显示上次观看位置，支持一键跳转继续
- **视频播放完成自动标记**: 视频播放结束后自动标记章节为已完成，无需手动点击完成按钮
- **播放速度记忆**: 自动保存播放速度偏好设置，下次观看时自动恢复
- **键盘快捷键支持**: 
  - `←` / `→`: 快退/快进 5 秒
  - `空格键`: 播放/暂停切换
- **视频加载状态**: 显示加载动画和加载失败提示
- **添加章节时直接上传视频**: 在"添加章节"弹窗中新增视频上传区域，支持点击或拖拽上传

#### 🎨 界面优化
- **视频播放器样式**: 全新设计的视频播放器容器，16:9 宽高比，圆角阴影效果
- **控制栏优化**: 优化播放速度选择器样式，添加悬浮和焦点效果
- **进度恢复提示**: 当存在上次播放位置时，显示恢复进度提示条
- **完成按钮状态**: 已完成章节显示绿色"已完成学习"状态
- **搜索框样式统一**: 课程模块搜索框改用全局统一的搜索框组件样式

#### 🔧 技术改进
- **事件管理**: 优化视频播放器事件绑定，避免重复绑定
- **资源清理**: 组件销毁时正确清理视频相关事件监听器
- **进度保存优化**: 采用防抖策略保存进度，减少 localStorage 写入频率
- **视频上传修复**: 修复 `StorageManager` 属性引用错误 (`base_path` → `upload_dir`)

### 📦 存储规范统一 (Storage Standard Unification)

#### 🗂️ 二元目录结构
- **全局统一**: 所有业务模块统一使用 `uploads/` 和 `outputs/` 二元目录结构
- **相册模块**: 照片存 `uploads/`，缩略图存 `outputs/`（原 `photos/` 和 `thumbnails/`）
- **视频模块**: 视频存 `uploads/`，封面存 `outputs/`（原 `videos/` 和 `thumbnails/`）

#### 📝 规范文档同步
- **开发规范更新**: 更新《开发规范.md》第六章"存储规范"中的目录结构说明，与代码保持一致

---


## [v2.4.12] - 2026-01-26 (Office 文档在线预览)

### 📄 Office 文档在线预览功能 (Office Document Online Preview)

#### ✨ 新增功能
- **Word 文档预览**: 支持 `.docx` 格式文档的在线渲染，保留标题、段落、列表、表格、加粗/斜体等基本格式
- **Excel 表格预览**: 支持 `.xlsx` / `.xls` 格式表格的在线查看，包含多工作表切换、表头高亮、大数据量限流保护
- **本地离线方案**: 采用 Mammoth.js 和 SheetJS 两个前端库，全部本地化部署，无需外部 CDN 依赖，支持离线使用

#### 🔧 技术实现
- **OfficeViewer 组件**: 新增 `office_viewer.js` 前端组件，负责库的按需加载和文档渲染
- **样式适配**: 新增 `office_viewer.css`，提供 Word 文档排版样式和 Excel 表格样式，支持暗色模式
- **文件管理器集成**: 修改 FileManager 的 `previewFile` 方法，双击 Word/Excel 文件可直接预览

#### 📦 新增依赖
- `libs/mammoth/mammoth.browser.min.js` - Word 解析库 (628KB)
- `libs/sheetjs/xlsx.full.min.js` - Excel 解析库 (922KB)

### 📕 PDF 阅读器增强 (PDF Reader Enhancement)

#### ✨ 新增功能
- **文件管理器 PDF 预览**: 在文件管理器中双击 PDF 文件，可直接打开增强版预览器
- **页面导航**: 支持上一页/下一页切换，显示当前页码和总页数
- **缩放控制**: 支持放大/缩小（50% - 500%），提供舒适的阅读体验

#### 🔧 技术实现
- **PdfViewer 组件**: 新增独立的 PDF 预览组件，复用 PDF 模块的后端渲染能力
- **样式适配**: 新增 `pdf_viewer.css`，支持深色/浅色模式

---

## [v2.4.11] - 2026-01-25 (架构脱钩与数据库完善)

### 📁 文件管理器架构深度解耦 (FileManager Decoupling)

#### 🚀 架构革新
- **彻底废弃适配器模式**: 移除了所有模块的 `*_adapter.py` 文件及核心层 `file_adapter.py` 工具。
- **文件管理自治**: 文件管理器 (FileManager) 现作为独立网盘应用运行，不再通过适配器自动聚合其他模块（相册、视频等）的文件，极大提升了目录浏览性能。
- **VFS 注册机制**: 确立了基于 `FileManagerService.register_file()` 的按需注册机制。业务模块如需将产物（如导出文档）放入网盘，需显式调用注册接口，确保流程可控且解耦。

#### 🔧 代码清理
- **死代码移除**: 彻底清理了 `filemanager_services.py` 中关于虚拟聚合、自动初始化系统文件夹等过时逻辑。
- **文档更新**: 同步更新《开发规范.md》，明确“模块自治 + 按需注册”的新存储标准。

### 📄 PDF 工具箱数据库完善 (PDF Database Enhancement)

#### 🗄️ 数据库优化
- **表级注释补全**: 为 `pdf_history` 表添加了详细的表级注释。
- **PdfItems 模型补充**: 在 `pdf_models.py` 中补充了 `PdfItems` 数据模型及其对应的表级注释，用于后续扩展项目的存储。
- **Alembic 迁移同步**: 
    - 解决了本地迁移 ID 与数据库记录不一致导致的迁移锁死问题。
    - 生成并执行了专用的迁移脚本，将表级注释及模型变更成功应用至生产环境数据库。

---

## [v2.4.10] - 2025-01-25 (PDF 模块优化)

### 📄 PDF 模块体验优化 (PDF Module Enhancement)

#### 🔧 功能修复
- **中文水印支持**: 修复水印功能使用 Helvetica 字体导致中文乱码的问题，改用 PyMuPDF 内置的简体中文字体 `china-s`，确保中文水印正确显示。
- **下载路径查找优化**: 改进结果文件下载接口，自动按优先级在 `outputs`、`uploads` 和根目录中查找文件，支持 Word/Excel 等新格式的正确 MIME 类型。

#### 🎨 界面优化
- **历史记录图标完善**: 为操作历史新增 12 种操作类型的专属图标映射（PDF转Word、PDF转Excel、加密、解密、旋转、重排、提取页面、删除页面、反转、添加页码、签名、去除水印），提升视觉辨识度。
- **文件选择器图标智能识别**: 文件选择器中根据文件扩展名动态显示对应图标（PDF使用PDF图标、图片使用图片图标等），取代之前固定的PDF图标，使"图片转PDF"等功能的文件选择更加直观。

---



### 📄 PDF 模块交互体验革新 (PDF UX Overhaul)
- **文档驱动新模式**:
    - 进入应用默认为“我的文档”库，将管理与进入阅读作为核心路径。
    - **侧边栏精简**: 移除了冗余的“阅读器”一级菜单。
    - **开卷即读**: 点击任何文档卡片直接开启沉浸式阅读，并智能处理无 ID 的虚拟挂载文件。
    - **退出阅读按钮**: 阅读器顶部新增“退出阅读”按钮，实现开闭卷的顺畅回退。
- **文案统一**: 将侧边栏“使用帮助”更为“帮助”，与系统全局保持一致。
- **工具箱任务化处理**:
    - **任务工作台**: 引入工作台概念，取代原有全量文件平铺。用户可先从库中“按需挑选”文件到工作台。
    - **智能交互**: 点击工具图标（合并、拆分等）会自动优先读取工作台中的文件；如未选择，则弹出库选择器供精准勾选。
    - **视觉升级**: 新增玻璃质感工具箱勋章与任务流引导语。

### 🐛 关键问题修复 (Critical Fixes)
- **渲染空白修复**: 修复了阅读器由于缺少 API 基础路径和身份验证 Token 导致的页面加载失败问题。
- **解析逻辑修复**: 彻底解决了文件选择器生成非法虚拟 ID 导致的“严重解析错误”故障。
- **启动状态同步**: 修复了应用首次打开时无法自动加载文档列表的问题，确保首选标签页数据实时呈现。
- **代码健壮性**: 修复了 `pdf.css` 大括号嵌套错误及 JS 多处转义引起的语法报错。

### ⚙️ 系统增强 (System Enhancements)
- **集成帮助系统**: 在侧边栏新增“帮助”入口，提供完整的文档管理、工作台操作及工具使用指南。
- **后端质量保障**: 
    - 按照开发规范建立 `backend/modules/pdf/pdf_tests/` 目录。
    - 引入基于 `pytest` 的自动化测试框架，涵盖文件列表、历史记录、非法参数检查等核心场景。
    - **实测通过**: 经全量自动化测试验证，PDF 模块所有核心接口响应符合预期，具备生产级稳定性。

## [v2.4.8] - 2026-01-24 (PDF 工具箱重大升级)

### 📄 PDF 工具箱功能大幅扩展 (PDF Toolbox Major Upgrade)

#### 🔄 格式转换 (Format Conversion)
- **PDF 转 Word**: 支持将 PDF 转换为可编辑的 Word 文档 (.docx)，保持格式布局
- **PDF 转 Excel**: 智能识别并提取 PDF 中的表格数据，导出为 Excel 文件
- **PDF 转图片**: 将 PDF 页面批量导出为高清 PNG 图片包
- **图片转 PDF**: 支持多张图片合并生成 PDF
- **提取文本**: 从 PDF 中提取纯文本内容

#### 📝 页面编辑 (Page Editing)
- **旋转页面**: 支持 90°/180°/270° 旋转，可指定页码范围
- **提取页面**: 从 PDF 中提取指定页面另存为新文件
- **删除页面**: 删除不需要的页面
- **反转页面**: 倒序排列所有页面
- **添加页码**: 自动添加页码，支持 6 种位置和自定义格式

#### 🔐 水印与安全 (Watermark & Security)
- **添加水印**: 自定义水印文字、颜色、透明度和字体大小
- **去除水印**: 智能识别并尝试移除 PDF 中的水印
- **加密 PDF**: 使用 AES-256 加密，添加密码保护
- **解密 PDF**: 移除 PDF 的密码保护
- **添加签名**: 在指定位置添加签名或印章图片

#### 🛠️ 技术改进 (Technical Improvements)
- **依赖扩展**: 新增 `pdf2docx`、`python-docx` 库支持格式转换
- **中文文件名修复**: 修复下载/预览中文文件名时的 latin-1 编码错误，使用 RFC 5987 规范处理

---

## [v2.4.7] - 2026-01-23 (PDF 增强版)

### 📄 PDF 工具箱功能升级 (PDF Toolbox Enhancement)
- **新增 PDF 压缩功能**: 支持自定义压缩等级（0-4），有效减小文件体积。
- **新增 PDF 水印功能**: 支持自定义水印文字、颜色、透明度。
- **新增 格式转换功能**:
    - **图片转 PDF**: 支持多张图片合并为 PDF。
    - **PDF 转图片**: 支持将 PDF 页面导出为图片压缩包 (Zip)。
- **交互体验优化**:
    - **文件多选器**: 重构文件选择组件，支持多文件选择（如多图片合并、多PDF合并）及扩展名筛选。
    - **操作历史优化**: 历史记录中新增下载按钮与操作类型图标区分，支持直接下载处理后的文件。
    - **安全下载机制**: 修复了下载路径的安全校验逻辑，支持通过文件名安全下载。

---

## [v2.4.6] - 2026-01-23 (修复与优化)

### 📊 数据透镜相关优化 (DataLens Optimization)
- **消除切换闪烁**: 
  - 移除了 Hub 首页和数据浏览器 (Viewer) 的冗余淡入动画，显著提升了分类切换、模式切换及分页时的视觉连贯性。
  - 优化了侧边栏分类点击逻辑，采用异步预加载机制，将数据获取与状态更新合并，消除了中间态导致的视觉跳变。
- **搜索性能优化**: 
  - 改进了 Hub 搜索框的重绘策略，输入过程中仅更新状态而不触发全量渲染，配合防抖机制，解决了输入卡顿和闪烁问题。


### 🐛 深度问题修复 (Deep Fixes)
- **AI 助手终极修复**:
  - **彻底消除抖动**: 引入增量 DOM 更新机制，彻底解决了流式输出时的页面重排和滚动条跳动。
  - **静默置底加载**: 实现了消息列表的"静默加载"和"首屏隐身"，消除了进入长对话时的"自动翻页"视觉干扰。
  - **时间戳修复**: 修复了从历史记录加载会话时，消息时间显示丢失的问题。
  - **滚动位置保持**: 全面修复了消息删除、编辑、会话切换、生成完成等场景下的滚动位置跳顶问题。
  - **重复气泡修复**: 修复了生成过程中出现两个 AI 回复气泡的问题。
  - **重新生成优化**: 改为"原地替换"模式，删除旧的问答后重新生成，而非追加。
  - **ServiceWorker策略**: 更新为 NetworkFirst 策略，前端代码更新后无需再手动改版本号。
  - **逻辑健壮性**: 引入 `_shouldForceScroll` 标志位，确保在冷启动、会话切换、消息操作等场景下滚动行为的绝对可靠。

- **Docker 与硬件兼容性**:
  - **指令集降级兼容**: 针对飞牛 NAS 等设备中常见的 J3455/J4125 等 CPU，通过显式禁用 AVX/AVX2/FMA 指令集编译 `llama-cpp-python`，彻底解决了 `Illegal instruction` 崩溃问题，实现全硬件平台通用。
  - **存储路径热修复**: 统一了 `UPLOAD_DIR` 为根存储目录 `/app/storage`，解决了 AI 模型及模块化数据无法正确加载的路径偏差问题。
  - **部署包对齐**: 同步了 `docker/` 与 `deployment/` 目录的默认端口 (9000) 和配置规范。

---

## [v2.4.5] - 2026-01-22 (修复与优化)

### 🐳 Docker 部署优化与 NAS 适配 (Docker Deployment & NAS Adaptation)

#### 🛠️ 关键修复 (Critical Fixes)
- **路径解析修复**：修正了 `UPLOAD_DIR` 环境变量的指向规则。必须指向存储根目录 `/app/storage` 而非子目录，否则会导致 AI 模型、OCR 模型及地图瓦片的挂载路径解析错误（404）。
- **挂载方案优化**：针对飞牛 NAS (FnOS) 等系统的子目录挂载兼容性问题，重构了卷映射策略。**推荐直接将模型文件放入 `storage` 目录中**，彻底避免了子目录不生效的问题。
- **启动诊断增强**：在 `docker-entrypoint.sh` 中集成了挂载状态实时监测。容器启动时会自动输出 AI/OCR 目录的文件列表，帮助快速定位权限和路径故障。

#### 📖 文档与引导 (Documentation & Guidance)
- **故障排除手册**：在 `deployment/使用说明.md` 中新增了详尽的故障排除章节，涵盖挂载失效、图片 404 缓存清理、API 兼容性等 5 类常见问题。
- **目录引导系统**：在存储文件夹（AI、OCR、地图）中添加了 `请将文件放到这里.txt` 中文说明，实现“所见即所得”的引导体验。
- **部署流程标准化**：更新了全量部署流程图，确保从镜像导入到模型加载的每一步都有据可查。

---

## [v2.4.5] - 2026-01-19

### 🐳 Docker 全量容器化与极致瘦身 (Dockerization & Optimization)

#### 🚀 镜像瘦身 (94% 缩减)
- **CPU 高效瘦身版**：引入多阶段构建 (Multi-stage Build)，强制安装 CPU 专用版 PyTorch，成功将镜像体积从 **14GB 压缩至 813MB**。
- **依赖隔离**：移除了 10GB+ 的 NVIDIA GPU 加速库，极大提升了在 NAS 和普通云服务器上的部署速度。
- **环境兼容**：即使在无显卡环境下，OCR、AI 对话及 PDF 处理功能仍可自动降级至 CPU 模式运行。

#### 🛠️ 脚本与编码修复
- **编码修正**：修复了 `docker-entrypoint.sh` 入口脚本在 Windows 环境下产生的中文乱码。
- **换行符转换**：统一使用 Linux 标准换行符 (LF)，解决了容器内无法识别脚本的问题。
- **自动迁移系统**：完善了容器启动时的数据库连通性检测与 Alembic 自动迁移逻辑。

#### 📦 模块依赖完善
- **路径加载补全**：新增 `gpxpy` 依赖，修复地图模块在 Docker 环境下无法载入的问题。
- **PDF 支持增强**：升级 `pymupdf` 至 v1.26.0，提升 PDF 解析性能。

---

## [v2.4.4] - 2026-01-18

### 🧹 代码规范化与项目清理 (Code Standardization & Cleanup)

#### 📦 模块清单规范化
- **统一格式**：对 7 个模块的 Manifest 文件进行标准化整理，补充缺失字段：
  - `blog`、`notes`、`knowledge`、`map`、`schedule`、`course`、`ocr`
  - 补充 `assets`、`dependencies`、`kernel_version` 配置项
  - 统一 `author` 为 "JeJe WebOS"
  - 添加结构化注释，提升代码可读性
- **描述更正**：OCR 模块描述从 "PaddleOCR" 更正为 "RapidOCR"（与实际使用的识别引擎一致）

#### 🗑️ 临时文件清理
- 删除残留的临时样式文件 `frontend/css/pages/album_temp.css`

#### 🧪 测试代码规范化
- `tests/test_market.py`：将 `print()` 调试语句替换为 `pytest.fail()`，测试失败信息改为中文

#### 📖 README 文档全面更新
- **主题系统**：更正为实际配置（跟随系统浅色/深色 + 2 套可选特色主题）
- **模块分类**：明确区分"默认启用模块"（6 个）与"按需启用模块"（12 个）
- **目录结构**：完整更新项目目录树，包含所有 18 个业务模块
- **功能描述**：新增"全局搜索"功能说明

---



### 🔐 权限系统重构与实时化 (Permission System Overhaul)
- **实时权限同步**：废弃了 JWT 载荷中存储静态权限的模式，重构为每次请求实时从数据库获取。
- **并集解析逻辑 (Union Logic)**：
  - 系统现在会自动合并“用户组权限”与“个人特有权限”。
  - 只要其中任意一方拥有该权限，用户即可访问，解决了此前权限覆盖不全的问题。
- **跟随用户组逻辑**：
  - 默认情况下，用户权限会实时跟随所属组的变动。
  - 支持“取消跟随”，允许为特定用户定制化增减权限。
- **性能优化**：通过 `Depends` 依赖注入实现了权限获取的单次请求缓存，避免重复数据库交互。

### 📚 数据库规范化与即时文档 (Database Standardization)
- **100% 注释覆盖**：对系统中 40+ 张数据表及其所有字段（包括主键 `id`）补全了详细的中文 `comment`。
- **Alembic 升级**：
  - 优化了迁移环境，支持在迁移过程中自动维护 `alembic_version` 自身的中文注释。
  - **合并全量脚本**：生成了全新的 `initial_schema_production.py`，支持在新生产环境一键部署出带完整注释的规范数据库。

### 🔧 问题修复与细节打磨
- **市场模块**：
  - 修复了管理员通过市场接口管理应用时，因层级权限缺失导致的 `403` 错误。
  - 修正了 `market.js` 中对核心模块的硬编码列表，消除了不必要的警告提示。
- **代码清理**：彻底清理了项目中残留的数十个调试脚本和临时扫描报告。

---

## [v2.4.2] - 2026-01-17

### 🔐 三层应用权限系统 (Three-Tier App Permission System)
- **用户级应用管理**：普通用户现可在「应用市场」中个性化管理自己的应用，包括添加、移除、启用/禁用操作
- **权限层级设计**：
  - **系统层**：管理员控制应用的全局安装和启用状态
  - **用户组层**：管理员配置各用户组可访问的应用范围
  - **用户层**：用户在授权范围内自由管理个人应用列表
- **数据库扩展**：新增 `sys_user_modules` 表存储用户级应用配置
- **API 扩展**：
  - `POST /api/v1/system/market/user/install/{module_id}` - 用户安装应用
  - `POST /api/v1/system/market/user/uninstall/{module_id}` - 用户移除应用
  - `POST /api/v1/system/market/user/toggle/{module_id}` - 用户启用/禁用应用
- **前端适配**：应用市场页面根据用户角色展示不同视图（管理员视图/用户视图）

### 🧹 代码规范化 (Code Standards Compliance)
- **注释中文化**：全面检查并修复项目中残留的英文注释，确保符合开发规范
  - `backend/main.py` - Service Worker 注释
  - `backend/scripts/delete_module.py` - MySQL 语法注释
  - `backend/modules/vault/vault_services.py` - 时间更新注释
  - `backend/modules/datalens/datalens_models.py` - JSON 格式说明
  - `backend/modules/analysis/analysis_tests/test_analysis_extended.py` - 测试文件注释
  - `frontend/js/pages/vault.js` - 错误日志
  - `frontend/js/pages/knowledge.js` - 文件上传注释
- **调试代码清理**：移除开发性和调试性注释

---

## [v2.4.1] - 2026-01-17

### 📊 图表系统深度美化与多主题适配 (Chart Aesthetics & Multi-Theme Support)
- **自适应色彩引擎**：开发了动态主题感知系统，图表文字、轴线、分隔线及标签可根据系统主题（浅色/深色/霓虹）自动调整。
- **浅色模式增强**：彻底优化了图表在“日出印象”等浅色背景下的表现，将文字、轴坐标、轴标题及网格线切换为高对比度深灰/黑色，完美解决此前看不清的问题。
- **深色模式打磨**：大幅调亮了“星夜霓虹”模式下的轴标签、图例与标题亮度，并优化了网格线透明度，确保在大屏展示或夜间使用时信息一目了然。
- **交互细节优化**：
  - 导出图片功能现在会自动根据当前显示效果生成对应的浅色/深色预览图。
  - 热力图中间色根据背景色动态平滑转换，过渡更自然。

---

## [v2.4.0] - 2026-01-17

### 🪐 视觉品牌升级与 PWA 深度优化 (Brand Identity & PWA Polishing)

#### ✨ 系统品牌设计
- **全新品牌图标**：设计并应用了全新的 3D 高科技风格字母 "J" 图标，融合玻璃拟态 (Glassmorphism) 与现代深蓝配色（Telegram 风格）。
- **图标自动化处理**：开发并运行了专用图标处理脚本，实现了图标的主体识别、自动扣图透明化、居中对齐及边距标准化，确保在各种场景下显示完美。
- **PWA 深度适配**：
  - 更新了全局 `manifest.json`，完善图标多尺寸适配和启动背景配色。
  - 增强 Service Worker (`sw.js`)，优化核心资源缓存路径，显著提升 PWA 安装后的离线稳定性和冷启动速度。
  - 修复了 PWA 在某些浏览器环境下背景色显示不一致的问题。

#### 🧹 系统清理与维护 (System Maintenance)
- **代码纯净化**：
  - 彻底清理了项目中残留的所有测试用例产生的调试代码及相关脚本。
  - 删除了已完成使命的开发辅助脚本目录 `scripts/` (包含图标处理工具)，保持项目代码库精简。
  - **缓存自动清理**：执行了全量 `__pycache__` 和 `.pytest_cache` 清理工作，移除编译产生的冗余文件。
- **文档同步更新**：同步更新 `README.md` 与 `更新日志.md` 至 v2.4.1。

---

## [v2.3.9] - 2026-01-17

### 📱 PWA 渐进式应用支持 (PWA Support)

#### ✨ 系统增强
- **PWA 支持**：新增 `manifest.json` 和 `Service Worker`，支持将应用安装为桌面/移动端独立应用
- **离线访问**：通过 Service Worker 缓存核心资源（CSS, JS, Fonts），提升加载速度并支持基础离线访问
- **独立窗口体验**：支持 Standalone 模式，启动后隐藏浏览器地址栏，提供类原生应用的沉浸式体验
- **资源缓存策略**：
  - **核心资源**：Cache First（缓存优先），确保界面快速加载
  - **页面导航**：Network First（网络优先），确保获取最新版本
  - **API 请求**：Network Only（仅网络），保证数据实时性

---

## [v2.3.8] - 2026-01-17

### 🔐 密码箱模块 (Vault Module - 新增)

#### ✨ 核心功能
- **主密码机制**：采用 PBKDF2 密钥派生（480,000 迭代），确保主密码安全
- **AES-256 加密**：所有敏感数据（用户名、密码、备注）使用 Fernet 对称加密存储
- **密码分类管理**：支持自定义分类、图标、颜色，便于组织管理
- **密码条目CRUD**：完整的增删改查功能，支持收藏、搜索、分页
- **随机密码生成**：支持自定义长度、字符类型，自动评估密码强度
- **🔐 密码箱 (Vault) 修复与优化**：
  - 修复了列表数据加载异常的问题（解决了分类筛选和状态同步 bug）
  - 修复了弹窗重复显示的问题
  - 优化了分类下拉框在深色模式下的显示样式
  - **登录验证优化**：主密码输入错误时不再关闭弹窗，而是显示错误信息并支持立即重试
  - 更名为"密码箱"，统一了模块名称
- **安全管理**：
  - 新增 **修改主密码** 功能，支持在线更新主密码并自动重加密数据
  - 新增 **恢复码机制**：设置主密码时会生成唯一恢复码，忘记密码时可使用恢复码重置而不丢失数据
  - 新增 **重置保险箱** 功能，在无恢复码时提供安全的数据清除与重置机制
  - 强制 **强密码策略**：主密码必须至少8位，包含大小写字母和数字
  - 新增 **自动锁定**：5分钟无操作自动锁定密码箱，防止信息泄露
  - 新增 **密码强度指示器**：设置密码时实时显示强度条和进度提示
  - 新增 **导入/导出功能**：支持加密备份和恢复，可导出为 JSON 格式
  - 新增 **帮助指南**：集成模块使用说明，方便用户快速上手
  - 新增 **安全锁定机制**：连续输错5次主密码将锁定密码箱，必须通过恢复码重置
- **用户数据隔离**：严格的用户级数据隔离，确保多用户环境下的数据安全

#### 🎨 前端界面
- **解锁/锁定机制**：页面刷新后需重新输入主密码，增强安全性
- **Premium 设计**：现代化的卡片布局、渐变图标、流畅动画
- **智能图标识别**：根据网站域名自动显示对应图标（GitHub、Google、微信等）
- **一键复制**：快速复制用户名、密码到剪贴板，支持 **30秒自动清除**，防止敏感信息泄露
- **密码显示/隐藏**：敏感信息默认隐藏，点击切换显示，支持 **30秒自动隐藏**，保护屏幕隐私

#### 🔧 技术实现
- **后端**：FastAPI 路由 + SQLAlchemy 模型 + Pydantic 验证
- **加密库**：cryptography (Fernet + PBKDF2)
- **前端**：原生 JS 组件 + CSS3 动画
- **测试**：完整的单元测试覆盖核心功能

---

## [v2.3.7] - 2026-01-15

### 🧹 系统维护与代码规范化 (Code Cleanup & Localization)

#### 🇨🇳 代码注释中文化 (P0)
- **后端 (Analysis Module)**: 
  - 全面检查并汉化 `test_analysis.py` 中的测试用例注释（如 "Mock duckdb_instance" -> "模拟 duckdb_instance"）
  - 规范化 `analysis_chart_service.py`、`analysis_bi_service.py`、`analysis_router.py` 等核心服务文件的注释风格
  - 检查并优化 `datalens_services.py` 及 `backend/main.py` 的注释清晰度
- **前端 (Analysis Pages)**:
  - 汉化 `analysis.js` 中的核心事件绑定注释（如 "Compare events..." -> "比对事件..."）
  - 深度清理 `analysis_chart.js`、`analysis_sql.js`、`analysis_import.js`、`analysis_smart_table.js` 中的残留开发注释
- **样式表 (CSS)**:
  - 系统性汉化核心 CSS 文件注释，提升可维护性：
    - **Knowledge**: "Tree Styling" -> "树形结构样式", "Content Area" -> "内容区域" 等 10+ 处
    - **IM**: "Grouping Messages" -> "消息分组", "Reply Bar" -> "回复栏" 等 8+ 处
    - **Start Menu**: "Start Menu Styles" -> "开始菜单样式" 等 10+ 处
    - **Dock**: "Active indicator dot" -> "激活指示圆点" 等 8+ 处
    - **Desktop**: "Resize Handles" -> "调整大小手柄" 等

#### 🚀 功能特性增强 (New Features)
- **数据分析 (Analysis)**:
  - **ETL 算子增强**:
    - 新增 **机器学习回归 (Linear Regression)** 算子，支持简单的预测性分析场景
    - 前端完成 **ML 回归节点配置面板**：支持特征字段多选、目标字段单选、预测列名自定义
    - 扩展 **数学运算** 算子，支持 `LOG` (对数), `EXP` (指数), `SQRT` (开方), `POWER` (幂), `ABS` (绝对值), `ROUND` (取整), `CEIL` (向上取整), `FLOOR` (向下取整) 等高级运算
    - 优化 `SQRT` 运算对负数的处理，使用 `np.where` 提升安全性和性能
  - **可视化增强**:
    - 图表引擎新增 **桑基图 (Sankey)** 支持，用于流向与占比分析
    - 前端 BI 配置面板新增桑基图专用字段：源节点 (Source)、目标节点 (Target)、数值 (Value)
    - 优化图表工厂，桑基图使用原始数据而非聚合数据，确保流向关系正确

#### ⚖️ 代码质量维护
- **调试信息清理**: 移除项目中残留的调试代码和冗余注释
- **规范检查**: 确保所有修改保持原有功能逻辑，仅进行非侵入式的注释和格式优化

#### 🧪 测试修复 (Test Fixes)
- **AI 模块**: 修复 `test_session_service_exists` 测试，更正方法名 `get_sessions` -> `list_sessions`
- **传输模块**: 修复 `test_create_session`、`test_get_session_by_code` 测试，统一使用静态方法调用风格
- **分析模块**: 调整 `test_calculate_with_nan` 测试以匹配 ETL 服务设计（NaN 视为 0）
- **新增测试**: 添加 `test_analysis_extended.py`，覆盖边界条件和新功能测试

#### 🏗️ 架构与规范优化
- **入口文件重构 (Main Entry)**:
  - 依照开发规范对 `backend/main.py` 进行全量结构化整理，保持原有逻辑不变
  - 优化代码分层：导入 -> 配置 -> 常量 -> 生命周期 -> 中间件 -> 路由 -> 静态资源
- **静态资源规范**:
  - 移动 `leaflet-heat.js` 至 `frontend/libs/leaflet/` 标准目录，修复前后端资源引用不规范问题

#### 🐛 问题修复
- **CSS 语法修复**: 修复 `variables.css` 中因嵌套注释导致的主题变量定义语法错误

---

## [v2.3.6] - 2026-01-14

### 🗑️ 协同办公模块移除 (Office Module Removal)

#### 🧨 功能移除
- **模块下线**: 彻底移除 Collaborative Office (协同办公) 模块，包括文档编辑、表格编辑及即时协作功能。
- **清理资源**:
  - 移除后端 `office` 模块代码及相关服务
  - 移除数据库相关表：`office_documents`, `office_versions`, `office_collaborators`, `office_comments`, `office_edit_sessions`
  - 移除前端 `office.js`、`office.css` 及 `collab_ot.js` 协同引擎
  - 移除路由配置、Dock 栏入口及开始菜单图标配置

---

## [v2.3.5] - 2026-01-14

### 📄 协同办公模块全面优化 (Office Module Enhancement)

#### 📊 内置表格编辑器 (P0 - 新增)
- **轻量级表格编辑**: 内置简易表格编辑器，无需外部依赖，完全支持离线部署
- **单元格编辑**: 支持直接编辑单元格内容，自动保存
- **数据导出**: 支持导出表格为 CSV 格式

#### ✨ 保存策略优化 (P1)
- **智能防抖保存**: 将原固定 5 秒定时保存改为防抖策略，停止输入 3 秒后自动保存，减少不必要的请求
- **兜底定时保存**: 保留 30 秒兜底定时检查，确保长时间编辑不丢失数据
- **保存状态指示器**: 新增三态显示（已保存/未保存/保存中），带动画脉冲效果

#### ⌨️ 快捷键支持 (P1)
- **Ctrl+S 手动保存**: 支持快捷键立即保存文档/表格，并显示保存成功提示
- **离开页面提醒**: 当有未保存内容时，浏览器关闭或离开页面会弹出确认提示

#### 👥 协作者管理优化 (P1)
- **用户搜索功能**: 添加协作者时支持按用户名/昵称搜索，无需手动输入用户ID
- **搜索下拉列表**: 搜索结果显示用户头像、昵称和用户名，点击即可选择
- **智能过滤**: 搜索结果自动过滤已添加的协作者

#### �️ 协作者光标显示 (P2)
- **远程光标可视化**: 显示其他编辑者的光标位置，带用户名标签
- **颜色区分**: 每个用户使用不同颜色的光标，易于区分
- **活跃状态**: 用户不活跃 5 秒后光标自动淡出

#### 📤 文档导出功能 (P2)
- **导出按钮**: 文档编辑器新增导出按钮
- **HTML 格式导出**: 生成包含完整样式的 HTML 文件
- **表格 CSV 导出**: 表格编辑器支持导出为 CSV 格式

#### 🔗 分享与版本功能完善 (P1)
- **分享弹窗**: 完善分享设置弹窗，支持设置分享方式和权限
- **链接复制**: 设置分享后自动将分享链接复制到剪贴板
- **版本历史弹窗**: 完善版本历史查看和版本恢复功能

#### 🧹 编辑会话清理 (P2)
- **自动清理**: 后台定时任务每 5 分钟检查并清理超时会话
- **超时机制**: 10 分钟无活动的编辑会话自动标记为非活跃
- **资源优化**: 防止僵尸会话占用系统资源

#### �🔧 Bug 修复
- **WebSocket 403 修复**: 修复协同办公端点使用错误的鉴权函数导致的连接失败问题
- **审计干扰排除**: 将 WebSocket 路径加入 `AuditMiddleware` 跳过名单，解决握手冲突
- **默认素材补全**: 补全缺失的系统默认头像 `default-avatar.png`，消除 404 错误
- **模块钩子修正**: 将 `office_manifest.py` 中的 `on_startup` 改为 `on_enable`，确保会话清理任务在模块启用时可靠启动
- **后端 API 修复**: 修复用户搜索接口缺少 `and_` 导入的问题

#### 🎨 样式优化
- **用户搜索下拉框**: 新增搜索结果下拉样式，支持头像显示
- **保存状态动画**: 保存中状态添加脉冲动画效果
- **远程光标样式**: 新增协作者光标样式，带闪烁动画和用户名标签

#### 💬 评论批注功能 (P2 - 新增)
- **评论数据模型**: 新增 `OfficeComment` 表，支持评论内容、批注位置、回复关系、解决状态
- **完整 API 接口**: 
  - `GET /{doc_id}/comments` - 获取文档评论列表
  - `POST /{doc_id}/comments` - 添加评论
  - `PUT /comments/{id}` - 更新评论
  - `DELETE /comments/{id}` - 删除评论
  - `POST /comments/{id}/resolve` - 标记为已解决
  - `POST /comments/{id}/reopen` - 重新打开评论
- **评论面板UI**: 
  - 可折叠评论侧边栏
  - 评论列表显示用户头像、时间、内容
  - 支持引用选中文本批注
  - 回复功能和回复列表展示
  - 已解决/未解决状态切换
- **实时通知**: 新增评论时通过 WebSocket 广播通知其他编辑者

#### 🔄 OT协同编辑引擎 (P0 - 新增)
- **纯JavaScript实现**: 无需外部依赖（Yjs/Automerge），支持离线使用
- **操作转换算法**: 
  - 支持 `insert`（插入）、`delete`（删除）、`replace`（替换）三种操作类型
  - 自动解决并发编辑冲突
  - 保持各客户端文档一致性
- **CollabOT 类**: 核心OT引擎
  - `transform()` - 操作转换核心算法
  - `applyOp()` - 应用操作到文本
  - `receiveRemoteOp()` - 接收并处理远程操作
  - 操作历史记录和版本追踪
- **CollabEditor 类**: DOM编辑器封装
  - 自动侦测编辑器内容变化
  - 计算文本差异生成操作
  - 光标位置保存与恢复
  - 300ms 防抖同步
- **WebSocket 集成**: 
  - 本地操作自动发送到服务器
  - 远程操作接收后自动转换并应用
  - 支持断线重连

---

## [v2.3.4] - 2026-01-13

### 📝 在线考试模块优化 (Exam Module Enhancement)

#### ✨ 功能增强
- **帮助系统集成**: 在线考试模块导航栏新增帮助按钮，接入统一的 `ModuleHelp` 帮助体系
- **完整使用指南**: 提供考试中心、题库管理、试卷管理、在线考试、快捷键、错题本和阅卷等功能的详细说明

#### 🎨 界面优化
- **导航栏布局**: 新增帮助按钮固定在导航栏右侧，视觉上与其他导航按钮保持一致
- **样式适配**: 添加 `nav-spacer` 弹性布局和帮助按钮悬浮样式

### 📷 图文识别帮助内容更新 (OCR Help Content Update)

#### 📖 内容更新
- **PDF 识别说明**: 新增多页 PDF 识别、进度显示、停止识别功能说明
- **识别框可视化**: 新增「显示识别框」功能的使用说明
- **识别历史**: 新增历史记录管理功能说明（自动保存最近 10 条记录）
- **语言选项修正**: 更正为实际支持的语言（简体中文、中英混合、纯英文）
- **文件限制修正**: 文件大小限制从 10MB 修正为 20MB

---

## [v2.3.3] - 2026-01-13

### 📷 图文识别模块优化 (OCR Module Enhancement)

#### ✨ 功能增强
- **剪贴板粘贴支持**: 新增 `Ctrl+V` 快捷键直接粘贴剪贴板中的图片进行识别，无需手动上传
- **帮助系统集成**: 接入统一的 `ModuleHelp` 帮助体系，头部新增帮助按钮，提供完整的使用指南
- **多语言 OCR 实例优化**: 修复切换识别语言时模型未刷新的问题，现在每种语言使用独立的 OCR 实例缓存

#### 🔧 代码质量提升
- **Python 3.9 兼容性**: 修复批量识别 API 使用 `list[UploadFile]` 导致的 Python 3.9 兼容性问题，改为 `List[UploadFile]`
- **生命周期完善**: 添加 `afterUpdate` 和 `beforeUnmount` 生命周期方法，正确管理帮助按钮事件和粘贴事件监听器
- **样式优化**: 头部右侧区域添加 flex 布局，确保帮助按钮和状态指示器正确对齐

---

## [v2.3.2] - 2026-01-13

### 📝 在线考试模块全面优化 (Exam Module Enhancement)

#### ⏰ 考试体验升级 (P0)
- **倒计时提醒系统**: 考试剩余5分钟和1分钟时自动弹出警告提醒，配合声音提示确保考生不错过时间
- **断点续做功能**: 进入考试模块时自动检测未完成的考试，支持一键恢复考试进度，刷新页面不丢失状态
- **键盘快捷键**: 考试中支持 `↑/↓` 切换题目，`Ctrl+Enter` 提交试卷，快捷键提示固定显示在右下角

#### 👁️ 预览功能增强 (P1)
- **题目快速预览**: 题库管理中每道题目新增"预览"按钮，点击可展开查看选项、正确答案和解析，无需进入编辑模式
- **试卷预览模式**: 试卷列表新增"预览"按钮，支持在发布前完整预览试卷效果，展示所有题目及参考答案

#### 🎨 界面与样式完善 (P1)
- **答题卡组件**: 新增浮动答题卡样式，支持快速跳转题目，显示已答/未答统计
- **防作弊警告横幅**: 新增顶部红色警告横幅动画效果，检测到异常行为时醒目提示
- **保存状态指示器**: 优化答案保存状态显示（保存中/已保存/保存失败）样式
- **离线状态指示**: 新增网络状态指示器，离线时提示答案已本地缓存
- **错题本样式**: 完善错题本列表样式，显示错误次数徽章和解析内容
- **考试结果详情**: 优化答题对比展示，清晰区分用户答案、正确答案和评语
- **排名视图**: 新增排名页面完整样式，前三名使用金银铜渐变效果
- **阅卷界面**: 完善阅卷详情页面布局，支持对比查看考生答案和参考答案
- **题目高亮动画**: 通过快捷键或答题卡跳转题目时添加高亮过渡效果

#### 🔧 代码质量提升
- **统一计时器管理**: 重构考试计时器为独立方法，支持倒计时提醒功能
- **事件绑定扩展**: 新增题目预览展开、试卷预览等事件处理
- **状态管理优化**: 新增 `expandedQuestionId`、`previewPaper`、`currentQuestionIndex`、`reminded5min/1min` 等状态

---

## [v2.3.1] - 2026-01-12

### 📚 知识库模块深度优化 (Knowledge Base Optimization)

#### 🚀 性能优化 (P0)
- **向量清理完善**: 修复删除知识库时未清理向量数据库中索引数据的问题，确保数据一致性
- **树构建算法优化**: 前端树构建算法从 O(n²) 优化为 O(n)，大幅提升节点数量较多时的渲染性能
- **搜索缓存机制**: 引入 TTL 缓存（100条记录，5分钟过期），减少重复搜索的开销

#### ✨ 功能增强 (P1)
- **知识库更新接口**: 新增 `PUT /knowledge/bases/{base_id}` 接口，支持修改知识库名称、描述、封面等属性
- **批量排序接口**: 新增 `POST /knowledge/nodes/sort` 接口，支持节点拖拽排序持久化
- **长文档图谱提取**: 知识图谱提取支持滑动窗口处理长文档（CHUNK_SIZE=2000, OVERLAP=200），自动去重三元组

#### 📦 前端优化
- **API增强**: 新增 `updateBase()` 和 `batchSortNodes()` 方法
- **注释规范化**: 所有注释统一使用中文，移除英文和开发性注释

#### 🔧 代码质量 (P3)
- **注释规范化**: 后端所有服务、路由、解析器模块注释统一为中文
- **重复代码清理**: 移除重复的注释和冗余代码
- **依赖更新**: 新增 `cachetools>=5.3.0` 依赖

---



### 📚 知识库深度进化 (Knowledge Base Evolution)
- **极致搜索体验 (Intelligence Search)**:
    - **混合检索 (Hybrid Search)**: 深度集成语义向量检索、关键词检索与视觉检索。现已支持“以文搜图”，AI能理解并定位图像中的语义内容。
    - **精细重排 (Cross-Encoder Rerank)**: 引入 Cross-Encoder 模型对检索结果进行二次深度打分，显著提升长文本检索的精准度。
    - **多维过滤系统**: 新增基于文档类型的精细化过滤器，支持即时切换文档、文件等类型。
- **知识图谱可视化 (Knowledge Graph)**:
    - **自动关联提取**: 依托 LLM 自动提取文档间的实体（人物、地点、技术、概念）及复杂关系纽带。
    - **交互式动力学图谱**: 新增基于 ECharts 的力导向图谱视图，支持缩放、拖拽与高亮聚焦，让知识结构化、视觉化。
    - **双视图随心切换**: 支持在“层级树形”与“关联图谱”视图间一键无缝切换。
- **交互与易用性**:
    - **标准化帮助体系**: 全面接入 `ModuleHelp` 架构，提供从搜索技巧到图谱分析的全流程引导。
    - **底层性能优化**: 实现了前端脚本的异步按需加载（如 ECharts），大幅降低初始内存占用。
    - **稳定性修复**: 修复了由于状态管理导致的 ReferenceError 及加载状态同步问题。

## [v2.2.9] - 2026-01-11
    
### 🎬 视频模块增强 (Video Module)
- **个体管理**: 新增单个视频删除功能，支持在视频卡片悬浮层直接精准操作。
- **交互优化**: 修复了点击视频卡片功能按钮（删除、收藏等）会触发视频播放的事件冒泡问题。
- **后端日志**: 细化了视频删除的业务日志输出，区单项删除与批量删除，便于审计追踪。

### 📖 帮助系统升级 (Help System)
- **内容扩充**: 为**相册**和**视频**模块编写了详尽的使用指南，涵盖核心操作、快捷键及注意事项（如监控格式、FFmpeg依赖等）。
- **视觉统一**: 
    - 统一了模块帮助按钮样式，在图标旁新增“帮助”文本标识，显著提升引导性。
    - 将帮助内容迁移至全局 `ModuleHelpContents` 统一管理，确保多模块间体验一致。
    - 移除了幽灵按钮 (btn-ghost) 样式，恢复边框显示，使其在不同背景下均具有良好辨识度。

### 🎓 课程模块深度优化 (Course Module)
- **极致视觉体验**:
    - **高端设计语言**: 引入平滑骨架屏加载动画 (Skeleton Screen)、统计卡片玻璃拟态特效以及精细打磨的卡片阴影与悬浮微交互，全面对标旗舰级产品质感。
    - **Markdown 解析增强**: 重构渲染引擎，支持更丰富的排版样式、代码高亮与嵌套列表，提供出版级阅读体验。
- **智能学习系统**:
    - **断点续学**: 独创智能记忆引擎，自动追踪阅读进度。在"我的学习"卡片上一键点击"继续学习"，即可秒级跳转至上次退出的章节，无需人工查找。
    - **专注模式 (Focus Mode)**: 新增沉浸式阅读开关，开启后自动隐去侧边栏与无关元素，配合全屏居中布局，打造心流级学习环境。
- **交互与易用性**:
    - **章节快速导航**: 底部新增"上一章/下一章"动态导航按钮，支持预览章节标题及禁用状态自适应。
    - **帮助体系**: 内置全套交互式使用指南，覆盖从选课到结业的全流程操作指引。

### 🔧 系统稳定性
- **流媒体优化**: 重构 Gzip 中间件与流传输白名单（STREAMING_PATHS），彻底修复了部分浏览器播放 Mp4 时出现的 `DEMUXER_ERROR` 错误，确保视频加载秒开且无中断。

---

## [v2.2.8] - 2026-01-06

### 优化
- **相册与视频模块 (Album & Video)**: 全面升级视觉体验与功能交互。
    - **旗舰级视觉**: 引入平滑动画、磨砂玻璃效果查看器/播放器及响应式动态网格。
    - **批量处理**: 增加管理模式，支持多选、批量删除照片和视频，极大提升管理效率。
    - **拖拽上传**: 支持将本地图片或视频文件直接拖拽至页面区域进行闪电上传。
    - **封面自定义**: 支持手动将任意照片或视频设为合集封面。
    - **播放增强**: 视频播放器增加倍速切换功能（0.5x - 2.0x），支持空格键暂停/播放。
    - **性能优化**: 实现查看器预加载与视频预热逻辑。
    - **后端重构**: 新增相册与视频的批量删除接口，优化文件关联删除逻辑。
- **Dock 栏**: 修复“笔记”模块无法取消固定的 bug，优化默认应用加载逻辑。

## [v2.2.7] - 2026-01-05 - 日程管理UI/UX全面优化

本版本对日程管理模块进行了全面的界面和体验优化。

### 📅 日程管理布局重构
- **双栏布局**：重新设计日历视图，采用左右双栏布局（日历+日程详情并排）
- **事件绑定修复**：修复"新建日程"按钮无响应的问题
- **侧边栏优化**：修复搜索框溢出、底部按钮间距等布局问题

### ✨ 视觉体验增强
- **日历格子交互**：
  - 悬浮时轻微放大 (+5%) 并显示边框，增强交互反馈
  - 今日高亮使用渐变背景 + 右上角蓝色标记点
  - 选中日期使用渐变背景 + 阴影效果
- **事件数量徽章**：日历格子显示当天日程数量（替代原来的小圆点）
- **日程卡片美化**：添加边框、悬浮阴影、左移动画效果

### ⌨️ 快捷键支持
- `←` / `→`：切换上/下月
- `N`：新建日程
- `T`：跳转到今天

### 🚀 性能优化
- **月份数据缓存**：已查看过的月份数据缓存5分钟，快速切换月份无需重复请求
- **缓存自动清除**：创建/更新日程后自动清除缓存，确保数据实时性

### 🎨 CSS优化
- 日历容器圆角、内边距精简
- 事件列表项添加圆角边框、悬浮变换
- 响应式布局：小屏幕自动切换为单栏

### 🔧 日志输出优化
- 定期任务执行日志降级为 DEBUG，减少启动时日志刷屏
- 模块启用/禁用日志降级为 DEBUG

---

## v2.2.6 (2026-01-06) - 数据表时区统一

本版本对项目中所有数据表的时间字段进行了统一修复，确保全部使用东八区（北京时间）。

### 🕐 时区统一修复
- **新增时区工具模块**：
  - 新增 `utils/timezone.py`，提供统一的时区处理函数
  - `get_beijing_time()` 获取当前北京时间
  - `to_beijing_time()` 将任意时间转换为北京时间
  - `utc_to_beijing()` 和 `beijing_to_utc()` 时区转换函数

- **修复的数据模型**（共17个模块）：
  - `models/account.py` - 用户账户表
  - `modules/schedule/schedule_models.py` - 日程事件、提醒、分类表
  - `modules/notes/notes_models.py` - 笔记、文件夹、标签表
  - `modules/office/office_models.py` - 协同办公文档、版本、协作者表
  - `modules/knowledge/knowledge_models.py` - 知识库、节点表
  - `modules/blog/blog_models.py` - 博客文章、分类、标签表
  - `modules/feedback/feedback_models.py` - 反馈表
  - `modules/filemanager/filemanager_models.py` - 虚拟文件夹、文件表
  - `modules/datalens/datalens_models.py` - 数据源、视图、收藏表
  - `modules/course/course_models.py` - 课程、章节、进度表
  - `modules/analysis/analysis_models.py` - 数据分析相关表
  - `modules/map/map_models.py` - 地图轨迹、配置、标记表
  - `modules/video/video_models.py` - 视频集、视频表
  - `modules/album/album_models.py` - 相册、照片表
  - `modules/exam/exam_models.py` - 考试、题库、答题表
  - `modules/ai/ai_models.py` - AI对话会话、消息表
  - `modules/im/im_models.py` - 即时通讯会话、消息表
  - `modules/transfer/transfer_models.py` - 快传会话、历史表

- **模块创建脚本更新**：
  - 更新 `scripts/create_module.py` 模板，新创建的模块将自动使用东八区时间

- **系统核心模块时区修复**：
  - `core/events.py` - 事件总线时间戳
  - `core/health_checker.py` - 健康检查时间戳
  - `core/loader.py` - 模块加载器时间记录
  - `core/middleware.py` - 中间件统计时间
  - `utils/monitor.py` - 系统监控时间戳
  - `modules/_template/_template_models.py` - 模板文件修复语法错误

### 📖 开发规范更新
- 新增 **3.4 时区规范** 章节，详细说明：
  - 时区工具模块的使用方法
  - 数据库时间字段定义规范
  - 业务层时间操作规范
  - API 响应时间格式要求
  - 例外情况说明（JWT、外部系统等）
- 更新模块开发示例代码，使用 `get_beijing_time` 函数

### 📝 技术变更
- 所有时间字段统一使用 `DateTime(timezone=True)` 类型
- 默认值统一使用 `get_beijing_time` 函数
- 移除对 `datetime.now(timezone.utc)` 和 `datetime.now` 的直接使用

---

## v2.2.5 (2026-01-06) - 日程管理模块全面优化

本版本对日程管理模块进行了深度优化，新增多项实用功能并完善用户体验。

### 📅 日程管理功能增强
- **实时提醒推送**：
  - 后端新增定时任务，每分钟检查待发送的提醒
  - 通过 WebSocket 实时推送日程提醒给在线用户
  - 前端显示 Toast 通知和浏览器系统通知
  - 点击通知可直接跳转到对应日程

- **日程搜索功能**：
  - 侧边栏新增搜索框，支持实时搜索日程
  - 后端新增 `/events/search` API，支持标题、描述、地点模糊搜索
  - 搜索结果独立视图展示，最多返回 50 条记录

- **分类管理集成**：
  - 侧边栏显示用户自定义分类列表
  - 支持按分类筛选日程
  - 新增分类管理弹窗，可添加/删除分类
  - 分类带颜色标识，视觉更直观

- **重复日程支持**：
  - 日程表单新增重复类型选择（每天/每周/每月/每年）
  - 支持设置重复截止日期
  - 选择重复类型后动态显示截止日期选项

- **帮助系统集成**：
  - 侧边栏添加帮助按钮
  - 完整的日程管理使用指南

### 🔧 代码质量优化
- **事件绑定防重复**：添加 `_eventsBound` 状态标记，防止事件重复绑定
- **数据库会话管理**：新增 `get_db_session` 上下文管理器，用于定时任务获取数据库连接
- **WebSocket 消息处理**：前端新增 `schedule_reminder` 消息类型处理，支持浏览器通知

### 💄 界面优化
- 侧边栏头部重构，支持标题和操作按钮布局
- 新增搜索框样式，带清除按钮
- 新增分类列表样式，支持选中状态高亮
- 新增分类管理弹窗样式
- 响应式适配：小屏幕下隐藏搜索和分类区域

---

## v2.2.4 (2026-01-05) - 即时通讯体验重塑

本版本对即时通讯 (IM) 模块进行了深度重构与优化，重点提升了消息交互的流畅度与视觉美感，引入了现代化的聊天功能。

### 💬 即时通讯 (IM) 体验重塑
- **视觉体验升级**：
  - **消息气泡聚合**：智能识别同一用户 2 分钟内的连续消息，自动隐藏重复头像与昵称，界面更加清爽紧凑。
  - **UI 细节打磨**：优化了消息气泡的间距与布局，提升整体阅读体验。
- **交互功能增强**：
  - **右键菜单 (Context Menu)**：在消息气泡上新增右键菜单，支持**复制内容**、**回复消息**、**撤回消息**等快捷操作。
  - **引用回复**：支持对特定消息进行引用回复，输入框上方即时显示引用预览，沟通上下文更清晰。
  - **消息撤回优化**：限制撤回时间为 2 分钟内，超时自动隐藏撤回入口；优化了撤回确认交互，防止重复弹窗。
- **功能扩展**：
  - **全局用户搜索**：新增公开的用户搜索接口，普通用户可通过昵称快速查找并从联系人列表发起聊天。
  - **听觉反馈**：新增新消息提示音支持（需配置音频文件），提升即时响应感知。
  - **文件名搜索**：支持通过关键词搜索文件/图片类消息的文件名。
- **底层优化**：
  - **加密修复**：修复了消息双重 base64 编码导致的解密失败问题，兼容历史数据，确保消息安全可靠。
  - **日志降噪**：优化了 WebSocket 消息推送日志级别，大幅减少离线用户通知导致的日志刷屏。
  - **时区修正**：统一了撤回功能的时区判定逻辑，确保时间限制准确无误。

### 📝 文档更新
- **README**：更新即时通讯模块的功能描述。
- **更新日志**：记录本次 IM 模块的重大更新。

## v2.2.3 (2026-01-04) - AI助手重大升级

本版本对原"智脑AI"模块进行了全面升级，更名为"AI助手"，并新增多项实用功能。

### 🤖 AI助手 (原智脑AI) 全面升级
- **模块重命名**：
  - "智脑AI"正式更名为"AI助手"，名称更加直观友好
  - 更新所有相关文件、路由、菜单配置
  - 版本号升级为 v3.0

- **多模型支持**：
  - 支持动态选择本地模型（自动检测storage/modules/ai/ai_models/目录下的.gguf文件）
  - 侧边栏底部新增模型选择器（仅本地模式显示）
  - 模型选择持久化到LocalStorage
  - 模型加载失败时自动尝试其他可用模型

- **角色预设功能**：
  - 新增5种预设角色：通用助手🧠、编程助手💻、写作助手✍️、翻译助手🌍、数据助手📊
  - 每种角色有针对性的系统提示词，优化特定场景下的回答质量
  - 支持在对话过程中随时切换角色

- **Token统计与性能监控**：
  - 实时显示Token使用量（基于字符估算）
  - 显示生成速度（tokens/秒）
  - 帮助用户了解模型使用情况

- **对话导出功能**：
  - 新增一键导出对话为Markdown文件
  - 包含完整对话记录、时间戳和模型信息
  - 支持离线保存和分享

- **会话搜索**：
  - 侧边栏新增搜索框，支持快速过滤会话
  - 实时搜索，输入即过滤

- **输入历史记录**：
  - 支持上下键切换历史输入
  - 最多保存50条历史记录

- **API密钥加密存储**：
  - API密钥使用加密方式存储到LocalStorage
  - 保护用户敏感信息安全

- **时间显示功能**：
  - 消息气泡显示完整日期时分秒
  - 左侧会话列表显示更新时间
  - 智能格式化：今天/昨天/日期

### 💄 界面与体验优化
- **头部工具栏增强**：
  - 新增角色预设选择器
  - 新增导出对话按钮
  - 优化知识库选择器宽度
  - 调整控件布局，更加紧凑美观

- **侧边栏优化**：
  - 新增会话搜索框
  - 会话项显示更新时间
  - 本地模式下显示模型选择器
  - 自动检测可用模型列表

- **底部信息栏优化**：
  - 支持显示Token统计信息
  - 生成速度实时更新
  - 信息布局采用flex居中对齐

### 🔧 后端服务优化
- **多模型支持**：
  - 新增`get_available_models()`方法，动态检测可用模型
  - `chat_with_context()`和`_chat_local()`支持`model_name`参数
  - 优化模型加载逻辑，支持优雅降级
  - 模型加载失败时自动跳过并尝试其他模型

- **智能SQL生成**：
  - 增强自然语言转SQL功能
  - 支持聚合函数（COUNT/SUM/AVG/MAX/MIN）
  - 支持分组查询（GROUP BY）
  - 智能检测列类型生成SQL

- **数据可视化建议**：
  - 根据查询关键词推荐图表类型
  - 支持折线图、柱状图、饼图、散点图、热力图建议

- **角色预设支持**：
  - 后端新增5种角色预设系统提示词
  - 支持前端传递角色预设参数
  - 根据角色自动调整AI回答风格

- **错误处理优化**：
  - 模型加载失败时提供友好的错误提示
  - 记录失败的模型避免重复尝试
  - 大模型文件加载警告

- **代码质量**：
  - 更新所有相关文件的中文注释
  - 新增AI模块完整测试用例
  - 模块文档描述更新
  - 代码结构更清晰

### 📖 文档更新
- **README**：更新AI助手模块描述，增加新功能说明
- **优化方案**：更新OPTIMIZATION_PLAN.md，标记已完成项目
- **测试用例**：新增AI模块测试文件
- **更新日志**：记录本次重大升级

---

## v2.2.2 (2026-01-03) - 智能地图体验修复与性能提升

本版本重点修复了智能地图 (Smart Map) 页面的交互无响应问题，并深度优化了地图渲染性能与事件绑定逻辑。

### 🗺️ 智能地图 (Smart Map) 修复
- **交互修复**：
  - 修复了地图页面按钮点击无响应的问题。
  - 彻底解决了由于状态更新导致的地图无限重绘循环 (Infinite Re-render Loop)，消除了页面卡死现象。
- **性能优化**：
  - 重构地图初始化流程，采用**非阻塞式 (Non-blocking)** 数据加载策略，确保 UI 控件即刻响应。
  - 优化了事件绑定机制 (`bindEvents`)，确保在任何数据加载状态下交互依然有效。
  - 改进了文件上传控件的事件委托逻辑，增强了组件的稳定性。
- **容错性增强**：
  - 增加了对缺失地图库 (`libs/leaflet/leaflet-heat.js`) 的容错处理，防止脚本错误中断整个大屏页面的运行。

### 🤖 AI助手增强
- **异常处理优化**：
  - 修复了用户在 AI 回复过程中中断对话（如关闭页面）导致的 `RuntimeError: No response returned` 后端报错。
  - 全局异常处理器新增了对客户端主动断开连接 (Client Disconnect) 的识别与优雅处理 (HTTP 499)，避免日志被无效报错刷屏。
- **稳定性提升**：
  - 优化了流式响应 (Streaming Response) 的中间件处理逻辑，确保在高并发对话场景下的连接稳定性。

---

## v2.2.1 (2026-01-02) - 知识库与智能化升级

本版本引入了全新的「知识库」核心模块，并集成了向量数据库与多格式文件解析能力，标志着 JeJe WebOS 迈入 AI 知识管理时代。

### 📚 知识库模块 (New)
- **企业级文档管理**：
  - 新增知识库（Knowledge Base）与文档（Document）管理功能，支持无限层级目录结构。
  - 采用双栏布局设计：左侧为可拖拽调整的目录树，右侧为沉浸式 Markdown 编辑器。
  - 支持创建公开或私有知识库，满足团队协作与个人笔记双重需求。
- **所见即所得编辑器**：
  - 集成 Toast UI Editor，提供 Markdown 实时预览与工具栏辅助编辑。
  - 支持文档大纲自动生成、代码高亮与数学公式渲染。

### 🧠 智能化与文件解析
- **多格式文件支持**：
  - **PDF 解析**：集成 `pdfminer.six`，支持 PDF 文档上传、文本提取与在线预览。
  - **Word/Excel 解析**：集成 `mammoth` 和 `pandas`，支持 `.docx`、`.xlsx`、`.csv` 文件解析与展示。
  - **智能文本分块**：内置 `DocumentParser`，自动将长文档拆分为语义片段。
- **向量语义搜索**：
  - **ChromaDB 集成**：引入本地向量数据库 ChromaDB，实现文档内容的向量化存储。
  - **语义检索**：支持基于自然语言的模糊搜索，能够精准定位文档片段，即使关键词不完全匹配也能找到相关内容。

### ⚡ 交互体验升级
- **拖拽上传**：支持直接将文件拖拽至知识库编辑器区域，自动触发上传、解析与入库流程。
- **多维预览**：根据文件类型自动匹配预览模式（PDF 流式预览、图片灯箱、Office 文档文本预览）。

---

## v2.2.0 (2026-01-02) - 性能优化与代码规范统一

本版本是一个重要的性能优化版本，重点解决了大文件上传内存溢出风险、引入 Redis 缓存层优化高频查询，并全面提升窗口系统的视觉体验。

### 🚀 后端性能优化
- **文件上传流式写入**：重构 `/storage/upload` 接口，采用流式写入模式
  - 使用临时文件 + 分块读取策略，内存占用恒定（仅 1MB/块）
  - 解决大文件上传时服务器内存溢出（OOM）风险
  - 优化文件验证流程，先验证再移动，提升安全性
  - 使用 `shutil.move` 原子操作，确保文件完整性
- **系统设置 Redis 缓存**：为系统设置添加缓存层，减少数据库查询
  - 读取时优先从 Redis 缓存获取（TTL 5分钟）
  - 更新设置时自动清除缓存，确保数据一致性
  - Redis 不可用时自动降级到数据库查询
  - 系统启动时自动预热缓存

### 💄 前端视觉体验增强
- **窗口微动效优化**：
  - 优化弹出动画曲线，添加微妙弹跳效果（scale + translateY + blur）
  - 增强聚焦/失焦状态过渡，失焦窗口自动降低透明度和阴影
  - 新增最小化动画（缩小 + 下移 + 淡出），视觉反馈更流畅
  - 优化关闭动画，添加模糊过渡效果
- **磨砂玻璃效果增强**：
  - 提升 `backdrop-filter` 模糊强度（20px → 24px）
  - 添加 `saturate(180%)` 饱和度增强
  - 新增窗口边缘微光效果（outline）
- **阴影层次细化**：
  - 激活窗口：多层阴影 + 边框高亮
  - 失焦窗口：柔和阴影 + 透明度降低
  - 整体视觉层次更加分明

### 📝 代码注释规范化
- **全面注释检查**：系统检查并修改了项目中所有文件的注释
- **中文注释统一**：确保所有注释均使用中文，提升代码可读性
- **注释类型规范**：
  - 移除所有调试性注释（如 `# 调试：...`）
  - 移除所有开发提示注释（如 `# 注意：...`、`# 提醒：...`）
  - 移除所有废除标记注释（如 `# 已废除：...`）
  - 只保留功能性注释，说明代码的作用和逻辑
- **注释范围**：
  - 后端 Python 文件：全面检查并修改所有注释
  - 前端 JavaScript 文件：全面检查并修改所有注释
  - 移除调试用的 `console.log` 语句

### 📚 文档完善
- **README 文档重写**：
  - 重新编写项目 README，内容更加准确、简洁、全面
  - 完善项目介绍、核心特性、技术架构说明
  - 优化快速开始指南，提供 Docker 和本地开发两种方式
  - 补充配置说明、安全特性、浏览器支持等信息
- **开发规范文档重写**：
  - 全面重写开发规范文档，内容更加完善、准确
  - 新增注释规范章节，明确注释语言和类型要求
  - 完善存储规范说明，提供详细的 API 使用示例
  - 补充测试规范章节，包含测试目录结构和运行方法
  - 更新模块开发实战指南，提供完整的代码示例
  - 新增附录章节，包含常用工具函数和开发检查清单

### 🔧 代码质量提升
- **代码一致性**：统一注释风格，提升代码可维护性
- **文档准确性**：确保文档与项目实际情况完全一致
- **开发体验**：完善开发规范，降低新开发者上手难度

---



---

## v2.1.2 (2026-01-01) - 图表系统重构与ETL引擎增强

### 📊 BI 数据大屏与图表系统增强
- **沉浸式数据大屏**：
  - 新增 **大屏演示模式**，支持一键切换至全屏沉浸式视图
  - 内置 **科技感深色主题**，定制霓虹光效边框与动态背景
  - 自动适配大屏分辨率，隐藏非必要 UI 元素
  - 优化图表渲染逻辑，切换模式时自动重绘，确保样式完美适配
- **图表配置能力升级**：
  - **高级配置支持**：新增双 Y 轴 (Dual Axis)、堆叠图 (Stacked)、数值标签显示配置
  - **可视化数据筛选**：支持在组件级别直接配置数据排除项与高级过滤条件 (=, >, <, 包含)，无需修改数据集
  - **配置 UI 组件化**：提取 `ChartConfigUI` 通用模块，实现配置面板的生成逻辑复用，降低维护成本
- **图表工厂类 (ChartFactory)**：
  - 新增统一的图表生成工具类 `frontend/js/utils/chart_factory.js`，实现图表配置标准化
  - 支持柱状图、折线图、饼图、散点图、直方图、箱线图、热力图、趋势预测、仪表盘等 9 种图表类型
  - 统一数据过滤、字段匹配、排除项处理等逻辑，消除代码重复
  - 提供统一的 ECharts 配置生成接口，提升代码可维护性
- **图表分析模块重构**：
  - 重构 `analysis_chart.js` 和 `analysis_bi.js`，使用 ChartFactory 统一图表生成逻辑
  - 大幅简化图表配置代码，提升代码可读性和维护性

### 🚀 ETL 数据建模引擎增强
- **新算子支持**：
  - **文本处理算子 (text_ops)**：支持大小写转换 (UPPER/LOWER)、去空格 (TRIM)、长度计算 (LENGTH)、字符串反转 (REVERSE) 等操作
  - **数学运算算子 (math_ops)**：支持数值字段的数学运算处理
  - **窗口函数算子 (window)**：支持窗口函数计算，实现更复杂的数据分析场景
- **缓存机制优化**：
  - 新增 ETL 缓存自动清理功能，自动删除超过 24 小时的过期缓存文件
  - 优化缓存目录管理，提升系统存储空间利用率
  - 缓存清理过程异常安全，不影响正常 ETL 执行流程

### 💄 前端体验全面优化
- **数据导入模块优化**：
  - 大幅优化导入界面布局和交互体验
  - 增强文件上传、预览、批量导入等功能
  - 优化导入进度显示和错误提示
- **对比分析功能增强**：
  - 优化数据集对比功能的 UI 设计
  - 改进数据处理逻辑，提升对比结果的准确性
  - 增强对比结果的展示和导出功能
- **智能表格优化**：
  - 增强智能表格的数据展示功能
  - 优化表格编辑和筛选交互
  - 提升大数据量下的表格渲染性能
- **数据清洗模块优化**：
  - 优化清洗规则的配置界面
  - 增强清洗结果的预览和验证功能
- **样式统一化**：
  - 统一分析模块各子功能的样式风格
  - 优化响应式布局，提升不同屏幕尺寸下的显示效果
  - 修复多处样式细节问题，提升视觉一致性

### 🔧 后端服务优化
- **ETL 服务增强**：
  - 优化 ETL 节点执行逻辑，提升处理性能
  - 增强错误处理和日志记录
  - 优化数据转换和缓存机制
- **导入服务优化**：
  - 优化文件导入处理流程
  - 增强数据验证和错误处理
  - 提升大文件导入的稳定性
- **对比服务优化**：
  - 优化数据集对比算法
  - 增强数据清理和格式化处理
  - 提升对比结果的准确性

### 📝 代码质量提升
- **代码重构**：
  - 大量前端代码重构，消除重复逻辑
  - 统一工具类和公共方法，提升代码复用性
  - 优化组件结构和状态管理
- **样式优化**：
  - 统一 CSS 变量使用，提升主题适配性
  - 优化响应式布局和动画效果
  - 修复多处样式细节问题

### 🐛 问题修复
- 修复图表生成时的字段匹配问题
- 修复 ETL 缓存清理时的异常处理
- 修复导入模块的样式显示问题
- 修复智能表格的数据更新问题

---

## v2.1.1 (2025-12-31) - 存储规范统一与开发规范完善

### 📂 存储系统重构
- **统一存储管理器**：重构 `StorageManager`，实现全局统一的存储规则
- **用户隔离**：所有用户相关文件按 `user_{id}/` 目录隔离，确保数据安全
- **模块分类**：模块文件统一存放在 `modules/{module_name}/` 下，支持按用户进一步隔离
- **目录结构优化**：
  - `storage/users/user_{id}/` - 用户私有文件（上传、导出）
  - `storage/modules/{module}/temp/user_{id}/` - 模块临时文件
  - `storage/modules/{module}/archive/user_{id}/` - 模块归档文件
  - `storage/system/` - 系统级文件（备份、日志）



### 📖 开发规范完善
- **JS/CSS文件规范**：
  - 新增「5.3 JS/CSS 文件命名与存放规范」章节
  - 明确文件命名规则：JS和CSS文件名必须完全一致
  - 明确存放规则：目录结构必须对应，子目录保持一致
- **存储规范**：
  - 新增「六、存储规范 (Storage Standards)」章节
  - 详细说明存储目录结构、StorageManager API使用方法
  - 提供完整的代码示例和使用场景说明

### 🐛 问题修复
- **PDF图表显示**：修复PDF中图表只显示一半的问题，优化ECharts渲染容器配置
- **文件路径错误**：修复PDF生成后下载路径不匹配的问题，统一使用临时目录
- **数据清理**：修复删除记录时未清理本地文件的问题，实现完整的文件清理机制

### 📝 文档更新
- **开发规范**：新增JS/CSS文件规范和存储规范章节
- **更新日志**：记录本次存储系统重构和规范完善
- **README**：更新项目结构说明，添加存储规范链接

---

## v2.1.0 (2025-12-25) - 数据透镜架构升级与体验打磨

### 👁️ 数据透镜模块 (DataLens) 深度优化
- **Spotlight 联动**：支持通过 `Ctrl + K` 全局搜索功能快速发现并一键唤起数据视图窗口。
- **高性能文件缓存**：为 CSV 和 Excel 数据源引入 **DataFrame 内存缓存机制**（有效期 60s），彻底解决大文件分页查询时的 IO 瓶颈。
- **架构重构与解耦**：
  - **独立窗口显示**：点击视图卡片时，由“页内标签”改为“桌面独立窗口”模式。
  - **多开对比支持**：支持同时打开多个视图窗口，任务并行处理能力大幅提升。
  - **路由逻辑优化**：支持通过视图 URL 直接唤起独立窗口，实现了主 Hub 与子视图的完全解耦。

### 🐛 问题修复
- **筛选面板逻辑优化**：
  - 打开筛选面板时自动添加默认空条件行，与排序面板行为一致。
  - 关闭筛选面板时自动清空条件并刷新数据。
  - 修复空字段名或占位符字段被发送到后端导致 SQL 查询失败的问题。
- **图表初始化修复**：修复 `_initChart` 方法中 `getElementById` 参数格式错误导致图表一直显示"初始化中"的问题。
- **HTML 标签语法修复**：修复 `datalens_viewer.js` 中多处 HTML 标签格式问题，确保状态标签、分页按钮等正确渲染。
- **独立窗口标题重复**：移除独立窗口模式下的面包屑导航区域，避免与窗口标题栏重复显示。
- **废弃代码清理**：移除已不再使用的"返回首页"按钮及相关事件监听器。

### 💄 UI/UX 与交互细节打磨
- **面包屑导航**：视图窗口新增 `数据透镜 > 分类 > 视图名` 面包屑，增强层级感知与专业感。
- **筛选逻辑优化**：隐藏筛选面板时不再清空已设定的条件，极大提升了复杂筛选场景下的连续操作体验。
- **预览按钮增强**：
  - 添加 `lens-btn-primary` 类，解决浅色模式下按钮不可见的问题。
  - 引入呼吸灯脉冲效果，强化执行指引。
- **样式变量统合**：
  - 修复了 DataLens 内部 CSS 变量命名不一致导致的背景显示异常，确保主题完美适配。
  - 增加了对 `--color-text` 和危险状态色的别名映射。

### 📖 文档更新
- **帮助中心**：新增「数据透镜指南」，详细说明新窗口架构和钉选功能。
- **README**：更新特性描述和版本号。

---

## v2.0.9 (2025-12-24) - 数据分析模块优化与测试规范

### 📊 数据分析模块增强
- **ETL 缓存持久化**：节点执行结果支持 Parquet 格式磁盘缓存，服务重启后可自动恢复，无需重新执行
- **BI 图表渲染优化**：
  - 顺序渲染：使用 `requestAnimationFrame` 避免同时渲染大量图表卡顿
  - 数据缓存：同一数据集多个组件共享缓存（30秒 TTL），减少重复 API 调用
  - 防抖 resize：全局共享 resize 监听器，避免内存泄漏
- **代码重构**：`aggregateData` 函数统一到 `Utils` 工具类，消除 `analysis_chart.js` 与 `analysis_bi.js` 中的重复实现

### 🧪 模块测试规范
- **测试目录结构**：测试文件放置在模块内部 `tests/` 目录下，模块删除时测试自动清理
- **单元测试覆盖**：为数据分析模块编写 26 个 ETL 算子单元测试，覆盖过滤、选择、去重、排序、聚合、采样、限制、类型转换、空值填充、重命名、清洗等算子

### 📖 开发规范更新
- **manifest.py 完整示例**：补充 `version`、`description`、`author`、`ModuleAssets`、`dependencies`、`kernel_version`、`enabled` 字段及生命周期钩子绑定
- **新增「4.4 模块测试规范」章节**：包含测试目录结构、代码示例、运行命令
- **模块内部结构表格更新**：添加 `tests/` 目录说明，`{id}_services.py` 说明复杂模块可拆分多个 service 文件
- **模块模板检查清单更新**：新增「生命周期钩子已绑定」和「tests/ 目录」检查项

### 🔧 模块热插拔修复
- **analysis 模块**：添加缺失的 `__init__.py` 文件
- **manifest 规范化**：更新 `analysis_manifest.py` 结构，与其他模块保持一致

---

## v2.0.8 (2025-12-20) - 数据分析与 BI 可视化增强

### 📊 图表分析功能
- **基础图表**：新增柱状图、饼图、折线图、散点图四种基础图表类型
- **高级图表**：
  - 📶 **直方图**：数据分布分析，自动分箱
  - 📦 **箱线图**：五数概括与异常值检测
  - 🔥 **热力图**：多字段相关性矩阵可视化（皮尔逊系数）
  - 🔮 **趋势预测**：基于移动平均的简单预测
- **图表引擎**：集成 ECharts 5.4.3，支持深色主题与响应式

### 🎯 BI 仪表盘模块
- **代码分离**：独立 `analysis_bi.js` 模块，便于维护扩展
- **仪表盘管理**：创建/删除/保存仪表盘，数据持久化至 LocalStorage
- **可视化组件**：支持柱状图、折线图、饼图、仪表盘等组件
- **编辑模式**：添加/删除/配置组件，支持多种尺寸（小/中/大/宽）
- **网格布局**：6列响应式网格系统，自动适配不同屏幕

### 🐛 主题样式修复
- **Dock 提示框**：修复深色主题下 tooltip 文字为黑色看不清的问题
- **按钮文字**：修复系统深色模式下按钮文字颜色未正确定义的问题

### 📁 新增文件
- `frontend/js/pages/analysis_bi.js` - BI 仪表盘组件
- `frontend/css/pages/analysis_bi.css` - BI 仪表盘样式

---

## v2.0.7 (2025-12-19) - 性能深度优化与品牌视觉提升
- 🚀 **后端全量 N+1 优化**：
    - **覆盖公告与反馈**：继笔记与博客后，全面修复公告 (Announcement) 与反馈 (Feedback) 模块的 N+1 查询问题。通过 ORM 显式联表加载 `selectinload`，确保获取列表和详情时，作者、处理人等关联信息一并加载，大幅降低数据库 IO。
- 📂 **存储结构优化**：
    - **统一备份目录**：将原本散落在 `backend/` 下的 `module_db_backups` 迁移至根目录 `storage/backups/modules`，实现了数据与代码的物理隔离，使后端目录更加纯净。
- 🎨 **品牌视觉识别增强**：
    - **全站图标同步**：在登录页与主页顶部栏引入 🌐 品牌图标，替换了临时的 Emoji。
    - **登录页 Logo**：支持自定义 Logo 图片展示，提升了系统的产品化质感。
- 🐛 **系统稳定性与兼容性**：
    - **Windows 环境适配**：修复了在 Windows 下通过应用市场上传模块包时，由于文件句柄未及时释放导致的“压缩包损坏”错误。
    - **冗余路由清理**：移除 `routers/health.py`，统一归并至 `core/health_checker.py`，减少维护成本。
- 🧪 **测试覆盖**：
    - 运行 `pytest` 通过全部 65 项后端单元测试，确保系统核心逻辑稳健。


## v2.0.6 (2025-12-18) - 系统性能优化与安全加固
- 🚀 **后端查询性能飞跃**：
    - **解决 N+1 问题**：重构笔记 (Notes) 与博客 (Blog) 模块的底层 ORM 模型关联，引入 `selectin` 预加载技术，将原本随列表规模线性增长的数据库请求压缩为常数级，列表加载速度平均提升 200%+。
    - **逻辑精简**：移除路由层冗余的循环异步查询，全面由 ORM 关系驱动数据填充。
- 🛡️ **底层安全加固**：
    - **Zip Slip 防御**：应用市场在安装 `.jwapp` 离线包时新增路径合法性校验，彻底封堵利用恶意相对路径进行系统文件篡改的漏洞。
- 🎨 **界面一致性与细节打磨**：
    - **视觉统合**：统一博客、公告管理页面的功能图标，将各类“新建/发布”操作图标统合为 `➕`，增强系统视觉连贯性。
    - **布局修复**：修复笔记页面在不同窗口尺寸下的弹性高度问题，确保侧边栏和主区域始终填满窗口且无溢出。
    - **浏览器兼容**：针对现代浏览器补全了 CSS 属性规范（如 `line-clamp`），消除检查警告并提升兼容性。
- 🧹 **代码质量改进**：
    - **冗余代码清理**：彻底移除已弃用的国际化 (i18n) API 及相关样式残留，保持代码库纯净。
    - **性能调优**：优化公共前端组件的加载逻辑，减少不必要的 DOM 重绘。

## v2.0.5 (2025-12-18) - 导航整合与笔记体验优化
- 🧭 **系统导航深度整合**：
    - **单一入口化**：侧边栏、开始菜单、Dock 菜单全面简化，不再显示繁琐的子菜单。
    - **一致性体验**：所有应用均通过主页面进入，子功能按键统一移至页面头部操作区，符合原生桌面操作逻辑。
    - **逻辑优化**：遵循 WebOS 窗口化逻辑，彻底移除所有应用子页面的返回按钮，界面更加清爽专业。
- 📝 **笔记模块 (Notes) 重构**：
    - **布局调整**：将“新建笔记”与“新建文件夹”按钮从侧边栏移至主视图头部右侧，保持与博客、公告等应用的一致性。
    - **导航优化**：侧边栏现在专注于目录树和快捷筛选（收藏、标签），布局更加整洁。
- 🏪 **应用中心 (App Center) 优化**：
    - **入口统一**：应用网格取消子菜单弹出，点击图标直接进入应用主页。
    - **路径修复**：补全了公告及其他动态模块的跳转路径映射，修复跳转失效问题。
- 🔧 **系统管理逻辑清晰化**：
    - 统一重命名“系统管理”相关入口，内部整合系统设置、日志、监控与备份，形成闭环管理体验。

## v2.0.4 (2025-12-18) - 控制面板与体验增强
- 🎛️ **用户管理控制面板**：
    - **快速创建用户**：管理员可直接添加用户，无需注册审核流程。
    - **重置用户密码**：管理员可一键重置任意用户密码。
    - **界面优化**：操作按钮统一调整，新增"添加用户"主操作按钮。
- 🔍 **全局搜索 (Spotlight)**：
    - **聚合搜索**：按下 `Ctrl + K` 或 `Ctrl + Space` 唤起搜索框，可同时搜索应用、系统设置项和云端文件。
    - **快速导航**：支持键盘光标键选择和回车打开，显著提升操作效率。
- 🔔 **通知中心增强**：
    - **通知持久化**：系统通知自动保存到消息中心供随时查阅。
    - **分类图标**：消息列表根据类型显示不同图标。
- 👤 **个人中心优化**：
    - **头像裁切**：上传头像前支持拖拽移动和缩放裁切，确保比例正确。
- 📱 **移动端适配**：
    - 新增全局样式 `mobile.css`，完善 TopBar、Dock 和桌面在小屏幕上的响应式布局。
- 🎨 **主题自动切换**：
    - 支持根据系统深色/浅色偏好自动切换主题。

## v2.0.3 (2025-12-18) - 应用市场功能完善
- 🏪 **应用市场**：
    - **离线安装**：支持通过 `.jwapp` 离线包上传安装第三方模块。
    - **规范化流程**：上传后模块处于"待安装"状态，需手动点击安装。
    - **创建应用**：支持一键创建新模块模板，自动生成前后端代码。
    - **删除应用**：支持完全删除未安装的模块。
- 🔧 **组件增强**：
    - **Toast.loading**：新增加载中提示组件，支持动态更新和手动关闭。

## v2.0.2 (2025-12-17) - 快传模块上线
- ⚡ **快传功能**：支持局域网内设备间高速文件传输，具备传输码机制与实时进度同步。
- 🎨 **界面优化**：全新设计的文件上传拖拽区域与传输历史列表。

## v2.0.1 (2025-12-16) - 文件管理与体验增强
- 📁 **文件管理增强**：新增右键菜单、拖拽移动、配额监控与增强的预览支持。
- 📝 **规范化**：统一系统各处功能名称，完善帮助中心文档。

## v2.0.0 (2025-12-15) - 统一发布版本
- ✨ **核心特性**：全新多窗口系统 (Multi-Window System)，支持窗口最小化、最大化、自由缩放与智能层级管理。
- 🎨 **体验优化**：Dock 栏指示器修复，浏览器地址栏同步功能。
