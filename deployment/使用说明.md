# JeJe WebOS 飞牛NAS (FnOS) 部署指南

本目录包含了在飞牛NAS上部署 JeJe WebOS 所需的所有文件。

## 目录结构
- `jeje_webos.tar`: Docker 镜像文件（需要您执行导出操作后生成，大小约为 800MB）
- `docker-compose.yml`: 此处用于编排服务的配置文件
- `env_docker`: 环境变量配置文件
- `models/`: 存放 AI 模型文件的目录
- `ocr_models/`: 存放 OCR（图文识别）模型文件的目录
- `map_tiles/`: 存放离线地图瓦片的目录

## 部署步骤

### 1. 上传文件
在您的飞牛NAS的文件管理器中，创建一个文件夹（例如 `jeje_webos`），将本目录下的 **所有文件和文件夹** 上传到该文件夹中，包括：
- `jeje_webos.tar`
- `docker-compose.yml`
- `env_docker`
- `models/` 文件夹
- `ocr_models/` 文件夹
- `map_tiles/` 文件夹
- `storage/` 文件夹 (空目录，用于数据持久化)
- `logs/` 文件夹 (空目录，用于存放日志)

### 2. 导入镜像 (详细步骤)
由于飞牛NAS的网页管理界面可能暂不支持直接上传本地镜像文件，**推荐使用 SSH 命令行方式导入**。

1. **开启 SSH**:
   - 登录飞牛NAS网页端 -> 设置 -> SSH -> 启用 SSH。
   - 记下端口号（默认为 22）。

2. **连接 NAS**:
   - 在您的电脑上打开终端 (Windows 用户打开 PowerShell)。
   - 输入命令连接：`ssh <您的NAS用户名>@<您的NAS_IP> -p <端口号>`
     例如：`ssh admin@192.168.1.100 -p 22`
   - 输入密码登录。

3. **找到文件并导入**:
   - 飞牛NAS的存储卷通常挂载在 `/vol1` 或 `/vol2` 下。
   - 假设您在文件管理器中将文件上传到了 `docker/jeje_webos` 目录，路径通常是 `/vol1/1000/docker/jeje_webos`（`1000` 是用户ID，可能会不同）。
   - 执行以下命令查找并导入：
   ```bash
   # 1. 尝试找到您上传的目录
   cd /vol1
   find . -name "jeje_webos.tar" 
   
   # 2. 进入该文件的所在目录 (假设上面找到的是 /vol1/1000/docker/jeje_webos/jeje_webos.tar)
   cd /vol1/1000/docker/jeje_webos
   # 【重要】赋予目录权限，确保 Docker 能读取挂载的文件（解决相对路径不生效的关键）
   chmod -R 777 .
   
   # 3. 导入镜像 (这可能需要几分钟)
   sudo docker load -i jeje_webos.tar
   ```
   
4. **验证导入**:
   - 执行 `docker images`
   - 看到 `jeje_webos` `latest` 字样即为成功。

### 3. 部署 AI 模型 (强烈建议)
JeJe WebOS 的 AI 功能需要加载本地模型文件。为了方便管理，我们在部署包中预留了 `models` 目录。

1. **下载模型**: 
   推荐使用 Qwen2.5-Coder (7B) 量化版本，兼顾性能与速度。
   - 文件名: `qwen2.5-coder-7b-instruct-q4_k_m.gguf`
   - 下载地址 (HuggingFace): [点击下载](https://huggingface.co/Qwen/Qwen2.5-Coder-7B-Instruct-GGUF/resolve/main/qwen2.5-coder-7b-instruct-q4_k_m.gguf)
   - 下载地址 (ModelScope): [点击访问](https://modelscope.cn/models/qwen/Qwen2.5-Coder-7B-Instruct-GGUF/files) (请下载 `q4_k_m.gguf` 版本)

2. **放入目录**:
   将下载好的 `.gguf` 文件直接放入上传到 NAS 的 `jeje_webos/models` 文件夹中。

3. **注意**:
   如果您不放入模型文件，AI 助手功能将无法使用本地模式，只能配置在线 API 使用。

### 4. 部署 OCR 模型 (可选/自动)
图文识别功能默认会尝试从 huggingface 下载模型。如果您所在网络无法访问 huggingface，请手动下载。

1. **下载**: 按照 `ocr_models/README.txt` 中的链接下载 3 个 .onnx 文件。
2. **放置**: 将文件放入 `deployment/ocr_models` 目录中。
3. **效果**: 这样可以避免 NAS 部署时网络不通导致无法识别的问题。

### 5. 部署离线地图 (可选)
如果您需要使用离线地图功能：
1. **准备**: 将下载好的 xyz 格式瓦片包（文件夹结构为 z/x/y.png）重命名为自定义的英文名称。
2. **放置**: 将整个文件夹放入 `deployment/map_tiles` 目录中。
3. **使用**: 刷新网页地图，在图层列表中即可看到。

### 6. 配置环境
1. 打开 `env_docker` 文件，根据您的需求修改配置。
   - **强烈建议** 修改 `JWT_SECRET`、`DB_PASSWORD`、`MYSQL_ROOT_PASSWORD` 等安全相关的配置。
   - 默认端口为 `9000`，如果冲突，请在 `docker-compose.yml` 或 `env_docker` 中修改。
   - **注意**: 如果日志出现 "DuckDB ... Conflicting lock" 错误，请将 `docker-compose.yml` 中的 `WEB_CONCURRENCY` 改为 `1`。

### 7. 启动服务
在 SSH 终端中，**确保您当前位于 `docker-compose.yml` 所在的目录下**，执行：
```bash
# 【极重要】确保所有目录权限开放，否则无法启动或挂载失败
chmod -R 777 .

# 启动服务
sudo docker compose up -d
```
或者在飞牛NAS的 Docker 管理界面中，创建一个新的“堆栈” (Stack) 或“项目”，将 `docker-compose.yml` 的内容复制进去（注意这种方式可能需要手动配置环境变量，或者确保 `env_docker` 路径正确）。**推荐使用 SSH 方式启动以确保 `env_docker` 文件被正确读取。**

*注: 如果提示 `docker-compose: command not found`，请使用 `docker compose`（中间有空格）命令。*

### 8. 访问应用
启动完成后，在浏览器中访问：
`http://<您的NAS_IP>:9000`

默认管理员账号：
- 用户名：`admin`
- 密码：`Admin@123` (或者您在 `env_docker` 中配置的密码)

## 数据持久化说明
现在配置已改为**全本地目录映射**：
- 数据库文件、上传的文件：存于 `storage` 目录
- 系统日志：存于 `logs` 目录
- AI/OCR模型：分别存于 `models`, `ocr_models` 目录
- 离线地图：存于 `map_tiles` 目录

这样的好处是您可以在 NAS 文件管理器中直接看到所有数据，备份也只需要备份整个文件夹即可。

## 故障排除

### 问题1: AI/OCR 模型无法加载

**症状**: 日志显示 `未找到可用的本地模型，请将.gguf模型文件放置到storage/modules/ai/ai_models/目录`

**原因**: Docker 子目录挂载可能在某些 NAS 系统上不生效，或者权限不正确。

**诊断步骤**:
```bash
# 进入容器内部检查
sudo docker exec -it jeje-webos-app /bin/bash

# 检查模型目录内容
ls -la /app/storage/modules/ai/ai_models/
ls -la /app/storage/modules/ocr/ocr_models/
ls -la /app/storage/modules/map/map_tiles/

# 如果目录为空或显示的是容器内默认内容（而非宿主机挂载的内容），
# 说明子目录挂载没有生效
```

**解决方案**:

**方案 A: 重启并强制重建容器**
```bash
# 完全停止并删除容器（不删除数据卷）
sudo docker compose down

# 确保目录权限正确
chmod -R 777 ./models ./ocr_models ./map_tiles

# 重新启动，强制重建容器
sudo docker compose up -d --force-recreate
```

**方案 B: 直接将模型放入 storage 目录**

如果子目录挂载始终不生效，可以将模型文件直接放到 `storage` 目录内：
```bash
# 在 NAS 上通过 SSH 操作
cd /你的部署路径/jeje_webos
mkdir -p storage/modules/ai/ai_models
mkdir -p storage/modules/ocr/ocr_models
mkdir -p storage/modules/map/map_tiles

# 复制模型文件到 storage 目录内
cp models/*.gguf storage/modules/ai/ai_models/
cp ocr_models/*.onnx storage/modules/ocr/ocr_models/
cp -r map_tiles/* storage/modules/map/map_tiles/
```

然后修改 `docker-compose.yml`，**注释掉**子目录挂载的三行：
```yaml
    volumes:
      - ./storage:/app/storage
      - ./logs:/app/logs
      # 以下三行注释掉，因为模型已经在 storage 内部
      # - ./models:/app/storage/modules/ai/ai_models:rw
      # - ./ocr_models:/app/storage/modules/ocr/ocr_models:rw
      # - ./map_tiles:/app/storage/modules/map/map_tiles:rw
```

最后重启服务：
```bash
sudo docker compose down
sudo docker compose up -d
```

### 问题2: 图片资源 404 错误

**症状**: 日志显示类似 `GET /images/logo-cn-352x97_1.png | 404`

**原因**: 这些是浏览器或 PWA 缓存的旧资源请求，与当前版本不匹配。

**解决方案**:
1. **清除浏览器缓存**: 按 `Ctrl + Shift + Delete`，选择清除缓存和 Cookie
2. **取消注册 Service Worker**: 
   - 在浏览器中访问应用地址，按 `F12` 打开开发者工具
   - 进入 "Application" (应用) > "Service Workers"
   - 点击 "Unregister" (注销)
3. **刷新页面**: 按 `Ctrl + F5` 强制刷新

### 问题3: API 404 错误

**症状**: 日志显示 `GET /api/v1/guest/comm/config | 404`

**说明**: 这可能是旧版本应用或第三方脚本的请求，当前版本不包含此 API。可以安全忽略，不影响正常使用。

## 彻底清理旧数据 (重装指南)
如果您之前已经部署过 JeJe WebOS，想要彻底清空数据（包括数据库、Redis缓存、上传的文件）进行全新安装，请务必清理旧的 Docker Volume。

**注意：此操作不可恢复，请谨慎操作！**

### 1. 停止旧服务
在 SSH 中进入您之前的部署目录，执行：
```bash
# 停止并移除容器和网络
sudo docker compose down
# 注意：新版 Docker 使用 'docker compose' 而不是 'docker-compose'
```

### 2. 清理数据卷 (关键)
仅仅删除容器是不够的，数据通常保留在 Docker Volume 中。因为权限原因，通常需要加上 `sudo`。

**方法 A (推荐)：使用 docker-compose 自动清理**
如果您还在之前的部署目录中，可以直接添加 `-v` 参数：
```bash
# -v 参数会同时删除 docker-compose.yml 中定义的所有数据卷
sudo docker compose down -v
```

**方法 B：手动查找并删除**
如果您已经找不到之前的目录，或者使用了飞牛 UI 部署，手动清理最稳妥：
```bash
# 1. 列出所有包含 jeje 的数据卷
sudo docker volume ls | grep jeje

# 2. 根据上一步显示的结果，删除相关卷
# (以下仅为示例名称，请以实际查询结果为准)
sudo docker volume rm jeje_webos_jeje-mysql-data
sudo docker volume rm jeje_webos_jeje-redis-data
sudo docker volume rm jeje_webos_jeje-storage
sudo docker volume rm jeje_webos_jeje-logs
```

### 3. 清理本地缓存
如果您之前的部署将 `storage` 映射到了本地目录（而不是使用 Docker Volume），请直接在 NAS 文件管理器中删除对应的文件夹即可。

