============================= test session starts =============================
platform win32 -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0 -- d:\project\jeje_webos\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: D:\project\jeje_webos\backend
configfile: pytest.ini
testpaths: tests, modules
plugins: anyio-4.12.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=session, asyncio_default_test_loop_scope=function
collecting ... collected 872 items / 868 deselected / 4 selected
run-last-failure: rerun previous 4 failures

tests/test_backup_executor.py::TestBackupExecutor::test_execute_backup_task_sync_success FAILED [ 25%]
tests/test_csrf.py::TestCSRF::test_token_expiration FAILED               [ 50%]
tests/test_sql_safety.py::TestIsSafeTableName::test_unicode_table_name FAILED [ 75%]
modules/analysis/analysis_tests/test_modeling.py::TestModelingService::test_get_summary FAILED [100%]

================================== FAILURES ===================================
__________ TestBackupExecutor.test_execute_backup_task_sync_success ___________
tests\test_backup_executor.py:65: in test_execute_backup_task_sync_success
    mock_manager_instance.backup_database.assert_called()
D:\soft\python\Lib\unittest\mock.py:913: in assert_called
    raise AssertionError(msg)
E   AssertionError: Expected 'backup_database' to have been called.
---------------------------- Captured stderr call -----------------------------
2026-02-11 23:14:37,363 - INFO - 开始执行备份任务（线程 MainThread）: 123, 类型: full, 加密: False
2026-02-11 23:14:37,364 - INFO - 开始执行全量打包备份: 123
2026-02-11 23:14:37,364 - ERROR - 备份任务失败: 123, 错误: not enough values to unpack (expected 3, got 0)
Traceback (most recent call last):
  File "D:\project\jeje_webos\backend\utils\backup_executor.py", line 118, in execute_backup_task_sync
    full_success, file_path, file_size = backup_manager.backup_full(str(backup_id))
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 3, got 0)
------------------------------ Captured log call ------------------------------
INFO     utils.backup_executor:backup_executor.py:88 开始执行备份任务（线程 MainThread）: 123, 类型: full, 加密: False
INFO     utils.backup_executor:backup_executor.py:117 开始执行全量打包备份: 123
ERROR    utils.backup_executor:backup_executor.py:217 备份任务失败: 123, 错误: not enough values to unpack (expected 3, got 0)
Traceback (most recent call last):
  File "D:\project\jeje_webos\backend\utils\backup_executor.py", line 118, in execute_backup_task_sync
    full_success, file_path, file_size = backup_manager.backup_full(str(backup_id))
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 3, got 0)
_______________________ TestCSRF.test_token_expiration ________________________
tests\test_csrf.py:41: in test_token_expiration
    assert token not in _csrf_tokens # 校验时应该被删除
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: assert 'w1-6Vn6aqpNGQmb6vW3G_gS24ztHpzdUGP4KZd1wqN4' not in {'w1-6Vn6aqpNGQmb6vW3G_gS24ztHpzdUGP4KZd1wqN4': {'created_at': 1770822877.8643823, 'used': False}}
_________________ TestIsSafeTableName.test_unicode_table_name _________________
tests\test_sql_safety.py:78: in test_unicode_table_name
    assert is_safe_table_name("用户表") is False
E   AssertionError: assert True is False
E    +  where True = is_safe_table_name('\u7528\u6237\u8868')
____________________ TestModelingService.test_get_summary _____________________
D:\soft\python\Lib\site-packages\pandas\core\indexes\base.py:3805: in get_loc
    return self._engine.get_loc(casted_key)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
index.pyx:167: in pandas._libs.index.IndexEngine.get_loc
    ???
index.pyx:196: in pandas._libs.index.IndexEngine.get_loc
    ???
pandas\\_libs\\hashtable_class_helper.pxi:7081: in pandas._libs.hashtable.PyObjectHashTable.get_item
    ???
pandas\\_libs\\hashtable_class_helper.pxi:7089: in pandas._libs.hashtable.PyObjectHashTable.get_item
    ???
E   KeyError: 'cnt'

The above exception was the direct cause of the following exception:
modules\analysis\analysis_tests\test_modeling.py:53: in test_get_summary
    res = await ModelingService.get_summary(mock_db, 1)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
modules\analysis\analysis_modeling_service.py:84: in get_summary
    total_rows = int(row_count_result.iloc[0]['cnt']) if len(row_count_result) > 0 else 0
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\soft\python\Lib\site-packages\pandas\core\series.py:1121: in __getitem__
    return self._get_value(key)
           ^^^^^^^^^^^^^^^^^^^^
D:\soft\python\Lib\site-packages\pandas\core\series.py:1237: in _get_value
    loc = self.index.get_loc(label)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
D:\soft\python\Lib\site-packages\pandas\core\indexes\base.py:3812: in get_loc
    raise KeyError(key) from err
E   KeyError: 'cnt'
=========================== short test summary info ===========================
FAILED tests/test_backup_executor.py::TestBackupExecutor::test_execute_backup_task_sync_success - AssertionError: Expected 'backup_database' to have been called.
FAILED tests/test_csrf.py::TestCSRF::test_token_expiration - AssertionError: assert 'w1-6Vn6aqpNGQmb6vW3G_gS24ztHpzdUGP4KZd1wqN4' not in {'w1-6Vn6aqpNGQmb6vW3G_gS24ztHpzdUGP4KZd1wqN4': {'created_at': 1770822877.8643823, 'used': False}}
FAILED tests/test_sql_safety.py::TestIsSafeTableName::test_unicode_table_name - AssertionError: assert True is False
 +  where True = is_safe_table_name('\u7528\u6237\u8868')
FAILED modules/analysis/analysis_tests/test_modeling.py::TestModelingService::test_get_summary - KeyError: 'cnt'
====================== 4 failed, 868 deselected in 1.33s ======================
