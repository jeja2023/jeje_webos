# JeJe WebOS å¼€å‘è§„èŒƒ

> ğŸ“˜ **å¼€å‘è§„èŒƒä¸æ¨¡å—å®æˆ˜æŒ‡å—**

æœ¬æ–‡æ¡£æ˜¯ JeJe WebOS çš„å®Œæ•´å¼€å‘è§„èŒƒï¼ŒåŒ…å«æ¶æ„çº¦æŸã€ä»£ç æ ‡å‡†ã€æ¨¡å—å¼€å‘æŒ‡å—å’Œå‰ç«¯å¼€å‘æ‰‹å†Œã€‚

---

## ğŸ“‘ ç›®å½•

1. [æ ¸å¿ƒæ¶æ„è§„èŒƒ](#ä¸€-æ ¸å¿ƒæ¶æ„è§„èŒƒ)
2. [é¡¹ç›®ç›®å½•ç»“æ„](#äºŒ-é¡¹ç›®ç›®å½•ç»“æ„)
3. [é€šç”¨å¼€å‘æ ‡å‡†](#ä¸‰-é€šç”¨å¼€å‘æ ‡å‡†)
4. [æ¨¡å—å¼€å‘å®æˆ˜](#å››-æ¨¡å—å¼€å‘å®æˆ˜)
5. [å‰ç«¯å¼€å‘æŒ‡å—](#äº”-å‰ç«¯å¼€å‘æŒ‡å—)
6. [å­˜å‚¨è§„èŒƒ](#å…­-å­˜å‚¨è§„èŒƒ)
7. [æ³¨é‡Šè§„èŒƒ](#ä¸ƒ-æ³¨é‡Šè§„èŒƒ)
8. [æµ‹è¯•è§„èŒƒ](#å…«-æµ‹è¯•è§„èŒƒ)
9. [ä¸‰å¤§æˆ’å¾‹](#ä¹-ä¸‰å¤§æˆ’å¾‹)
10. [æ¨¡å—å­˜å‚¨ä¸ VFS äº¤äº’è§„èŒƒ](#å-æ¨¡å—å­˜å‚¨ä¸-vfs-äº¤äº’è§„èŒƒ)

---

## ä¸€ã€æ ¸å¿ƒæ¶æ„è§„èŒƒ

### 1.1 æ¶æ„åˆ†å±‚

JeJe WebOS é‡‡ç”¨ **å¾®å†…æ ¸ (Micro-Kernel)** æ¶æ„ï¼Œä¸¥æ ¼åˆ’åˆ†ä¸º **å†…æ ¸å±‚ (Kernel)** ä¸ **åº”ç”¨å±‚ (Modules)**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åº”ç”¨å±‚ (Modules)             â”‚
â”‚  blog, notes, feedback, analysis... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ä¾èµ–
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å†…æ ¸å±‚ (Core)                 â”‚
â”‚  Loader, EventBus, Security, DB     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒèŒè´£

| ç»„ä»¶ | èŒè´£ | ğŸ”´ ç¦åŒº |
|:---|:---|:---|
| **å†…æ ¸ (Core)** | æä¾›è´¦å·ã€é‰´æƒã€æ•°æ®åº“è¿æ¥ã€äº‹ä»¶æ€»çº¿ç­‰åŸºç¡€è®¾æ–½ | **ä¸¥ç¦åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘**ï¼ˆå¦‚æ–‡ç« ã€è®¢å•ï¼‰ |
| **æ¨¡å— (Modules)** | å®ç°å…·ä½“ä¸šåŠ¡åŠŸèƒ½ï¼ˆBlog, Notesï¼‰ | **ä¸¥ç¦ç›´æ¥ import å…¶ä»–æ¨¡å—ä»£ç ** |

### 1.3 æ¨¡å—é€šä¿¡

æ¨¡å—ä¹‹é—´ç¦æ­¢ç›´æ¥å¯¼å…¥ï¼Œå¿…é¡»é€šè¿‡ä»¥ä¸‹æ–¹å¼é€šä¿¡ï¼š

1. **äº‹ä»¶æ€»çº¿**ï¼šä½¿ç”¨ `core.events.event_bus` å‘å¸ƒå’Œè®¢é˜…äº‹ä»¶
2. **æ•°æ®åº“å…³è”**ï¼šé€šè¿‡å¤–é”®å…³è”ï¼Œåœ¨ Service å±‚æŸ¥è¯¢å…³è”æ•°æ®
3. **API è°ƒç”¨**ï¼šé€šè¿‡ HTTP API è°ƒç”¨ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºè·¨æœåŠ¡åœºæ™¯ï¼‰

---

## äºŒã€é¡¹ç›®ç›®å½•ç»“æ„

### 2.1 æ•´ä½“ç»“æ„

```
jeje_webos/
â”œâ”€â”€ backend/                      # åç«¯æ ¸å¿ƒ
â”‚   â”œâ”€â”€ core/                     # å†…æ ¸å±‚ï¼ˆç¦æ­¢ä¿®æ”¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ security.py           # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ loader.py              # æ¨¡å—åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ middleware.py         # å…¨å±€ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ events.py             # äº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ modules/                  # åº”ç”¨å±‚ï¼ˆå¼€å‘ä¸»æˆ˜åœºï¼‰
â”‚   â”‚   â”œâ”€â”€ _template/            # æ¨¡å—ç”Ÿæˆæ¨¡æ¿
â”‚   â”‚   â””â”€â”€ {module_id}/          # ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ routers/                  # ç³»ç»Ÿçº§è·¯ç”±
â”‚   â”œâ”€â”€ models/                   # ç³»ç»Ÿçº§æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/                  # ç³»ç»Ÿçº§ Schema
â”‚   â”œâ”€â”€ scripts/                  # å¼€å‘è„šæœ¬
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ tests/                    # ç³»ç»Ÿçº§æµ‹è¯•
â”‚   â””â”€â”€ main.py                   # å¯åŠ¨å…¥å£
â”‚
â”œâ”€â”€ frontend/                     # å‰ç«¯æ¡Œé¢ç¯å¢ƒ
â”‚   â”œâ”€â”€ css/                      # æ ·å¼å±‚
â”‚   â”‚   â”œâ”€â”€ core/                 # åŸºç¡€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ components/           # ç»„ä»¶æ ·å¼
â”‚   â”‚   â””â”€â”€ pages/                # é¡µé¢æ ·å¼
â”‚   â”œâ”€â”€ js/                       # é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒåº“
â”‚   â”‚   â”œâ”€â”€ components/           # UI ç»„ä»¶
â”‚   â”‚   â””â”€â”€ pages/                # ä¸šåŠ¡é¡µé¢
â”‚   â””â”€â”€ index.html                # å•é¡µå…¥å£
â”‚
â””â”€â”€ storage/                      # æ•°æ®æŒä¹…åŒ–
    â”œâ”€â”€ public/                   # å…¬å…±æ–‡ä»¶ (avatars, attachments)
    â”œâ”€â”€ modules/                  # æ¨¡å—ä¸“å±å­˜å‚¨ (æ ¸å¿ƒä¸šåŠ¡æ•°æ®)
    â””â”€â”€ system/                   # ç³»ç»Ÿçº§æ–‡ä»¶ (backups, logs, temp)
```

### 2.2 æ¨¡å—å†…éƒ¨ç»“æ„

æ¯ä¸ªä¸šåŠ¡æ¨¡å—å¿…é¡»éµå¾ªä»¥ä¸‹å‘½åè§„èŒƒï¼ˆ**å¼ºåˆ¶å¸¦æœ‰æ¨¡å—å‰ç¼€**ï¼‰ï¼š

| æ–‡ä»¶å | å¿…é¡» | è¯´æ˜ |
|:---|:---:|:---|
| `__init__.py` | âœ… | ç©ºæ–‡ä»¶ï¼Œæ ‡è®°ä¸º Python åŒ… |
| `{id}_manifest.py` | âœ… | æ¨¡å—æ¸…å•ï¼Œå®šä¹‰å…ƒæ•°æ®ã€æƒé™ã€èœå•ã€ç”Ÿå‘½å‘¨æœŸ |
| `{id}_router.py` | âœ… | API è·¯ç”±å®šä¹‰ |
| `{id}_models.py` | âœ… | æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLAlchemyï¼‰ |
| `{id}_schemas.py` | âœ… | æ•°æ®éªŒè¯æ¨¡å‹ï¼ˆPydanticï¼‰ |
| `{id}_services.py` | âšª | ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆæ¨èï¼‰ |
| `{id}_tests/` | âšª | æ¨¡å—æµ‹è¯•ç›®å½•ï¼ˆæ¨èï¼‰ |

> **è¯´æ˜**ï¼šæ‰€æœ‰ **åŠŸèƒ½æ¨¡å—** çš„æ–‡ä»¶å’Œç›®å½•å¿…é¡»å¸¦æœ‰ `{module_id}_` å‰ç¼€ï¼Œé˜²æ­¢ IDE ä¸­æœç´¢æ—¶å‡ºç°å¤§é‡åŒåæ–‡ä»¶æˆ–ç›®å½•ã€‚

> âš ï¸ **ç³»ç»Ÿçº§ vs åŠŸèƒ½æ¨¡å—å‘½ååŸåˆ™**ï¼š
> - **ç³»ç»Ÿçº§ç›®å½•ä¿æŒç¨³å®š**ï¼š`backend/tests/`ã€`backend/models/`ã€`backend/core/` ç­‰ç³»ç»Ÿçº§ç›®å½•ä½¿ç”¨ç®€æ´é€šç”¨å‘½åï¼Œå› ä¸ºå®ƒä»¬æ˜¯å”¯ä¸€çš„ä¸”ç¨³å®šçš„
> - **åŠŸèƒ½æ¨¡å—å¿…é¡»åŠ å‰ç¼€**ï¼šå„åŠŸèƒ½æ¨¡å—å†…çš„ç›®å½•å¿…é¡»æ·»åŠ æ¨¡å—IDå‰ç¼€ä»¥åŒºåˆ†ï¼Œå¦‚ï¼š
>   - æ¨¡å—æµ‹è¯•ï¼š`blog_tests/`ã€`notes_tests/`ï¼ˆä¸æ˜¯ `tests/`ï¼‰
>   - æ¨¡å—å­˜å‚¨ï¼š`storage/modules/ai/ai_models/`ã€`storage/modules/knowledge/embedding_models/`
>
> è¿™æ ·æ—¢ä¿æŒäº†ç³»ç»Ÿå±‚çš„ç®€æ´ç¨³å®šï¼Œåˆé¿å…äº†åŠŸèƒ½æ¨¡å—ä¹‹é—´çš„å‘½åå†²çªã€‚

> **ç³»ç»Ÿçº§æ–‡ä»¶ä¾‹å¤–**ï¼šä½äº `backend/models/`ã€`backend/routers/`ã€`backend/schemas/` çš„ç³»ç»Ÿçº§æ–‡ä»¶ï¼ˆå¦‚ `user.py`ã€`announcement.py`ã€`notification.py`ï¼‰æŒ‰ç…§ MVC åˆ†å±‚è®¾è®¡ï¼Œå…è®¸åŒåå­˜åœ¨äºä¸åŒç›®å½•ä¸­ï¼Œå› ä¸ºå®ƒä»¬å±äºä¸åŒçš„èŒè´£å±‚ï¼ˆæ¨¡å‹å±‚ã€è·¯ç”±å±‚ã€åè®®å±‚ï¼‰ã€‚

---

## ä¸‰ã€é€šç”¨å¼€å‘æ ‡å‡†

### 3.1 å‘½åè§„èŒƒ

| å¯¹è±¡ | è§„èŒƒ | ç¤ºä¾‹ |
|:---|:---|:---|
| **æ–‡ä»¶å** | `{module_id}_` å‰ç¼€ | `blog_router.py` |
| **ç±»å** | PascalCase | `BlogPost`, `BlogService` |
| **å˜é‡/å‡½æ•°** | snake_case | `get_post_list`, `user_id` |
| **æ•°æ®åº“è¡¨** | `{module_id}_` å‰ç¼€ | `blog_posts`, `sys_users` |
| **API è·¯å¾„** | `/api/v1/{module}/{resource}` | `/api/v1/blog/posts` |
| **å¸¸é‡** | UPPER_SNAKE_CASE | `MAX_FILE_SIZE`, `DEFAULT_PAGE_SIZE` |

### 3.2 ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰ API å¿…é¡»è¿”å›ç»Ÿä¸€çš„ JSON ç»“æ„ï¼š

```python
# æˆåŠŸå“åº”
{
    "code": 200,
    "message": "æ“ä½œæˆåŠŸ",
    "data": { ... }
}

# å¤±è´¥å“åº”
{
    "code": 400,
    "message": "å‚æ•°é”™è¯¯",
    "data": null
}

# åˆ†é¡µå“åº”
{
    "code": 200,
    "message": "success",
    "data": {
        "items": [...],
        "total": 100,
        "page": 1,
        "size": 10
    }
}
```

ä½¿ç”¨å·¥å…·å‡½æ•°ï¼š

```python
from schemas.response import success, error

# æˆåŠŸ
return success(data=result, message="æ“ä½œæˆåŠŸ")

# å¤±è´¥
return error(code=400, message="å‚æ•°é”™è¯¯")
```

### 3.3 æ•°æ®åº“æ¨¡å‹è§„èŒƒ

#### 3.3.1 ä¸¥ç¦ä½¿ç”¨å­—ç¬¦ä¸²å¼•ç”¨

åœ¨å®šä¹‰ `ForeignKey` å’Œ `relationship` æ—¶ï¼Œ**å¿…é¡»ä½¿ç”¨æ¨¡å‹ç±»æœ¬èº«**ï¼Œä¸¥ç¦ä½¿ç”¨å­—ç¬¦ä¸²ï¼š

```python
# âœ… æ­£ç¡®
from models import User

class BlogPost(Base):
    user_id: Mapped[int] = mapped_column(ForeignKey(User.id))
    user: Mapped[User] = relationship(User)

# âŒ é”™è¯¯
class BlogPost(Base):
    user_id: Mapped[int] = mapped_column(ForeignKey("sys_users.id"))
    user: Mapped["User"] = relationship("User")
```

#### 3.3.2 è·¨æ¨¡å—å…³ç³»å¤„ç†

é¿å…åœ¨ä¸åŒæ¨¡å—çš„æ¨¡å‹ä¹‹é—´å®šä¹‰åŒå‘ `relationship`ï¼š

```python
# âœ… æ­£ç¡®ï¼šåªä¿ç•™å¤–é”®ï¼Œåœ¨ Service å±‚æŸ¥è¯¢
class TransferSession(Base):
    sender_id: Mapped[int] = mapped_column(ForeignKey(User.id))
    # ä¸å®šä¹‰ relationship

# åœ¨ Service ä¸­æŸ¥è¯¢
user = await db.get(User, session.sender_id)

# âŒ é”™è¯¯ï¼šè·¨æ¨¡å— relationship
class TransferSession(Base):
    sender: Mapped[User] = relationship(User, backref="sessions")
```

#### 3.3.3 é¿å…ä½¿ç”¨ SQLAlchemy Enum ç±»å‹

å®šä¹‰æ•°æ®åº“åˆ—æ—¶ï¼Œ**ä½¿ç”¨ `String` ç±»å‹ä»£æ›¿ `Enum` ç±»å‹**ï¼š

```python
# âœ… æ­£ç¡®
from enum import Enum as PyEnum

class Status(str, PyEnum):
    PENDING = "pending"
    PUBLISHED = "published"

class BlogPost(Base):
    status: Mapped[str] = mapped_column(String(32), default=Status.PENDING.value)

# âŒ é”™è¯¯
from sqlalchemy import Enum
class BlogPost(Base):
    status: Mapped[Status] = mapped_column(Enum(Status))
```

#### 3.3.4 ç»Ÿä¸€å¯¼å…¥è·¯å¾„

æ‰€æœ‰æ¨¡å—å¯¼å…¥å¿…é¡»åŸºäºé¡¹ç›®æ ¹ç›®å½•ï¼ˆ`backend`ï¼‰ï¼Œä¸è¦ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ï¼š

```python
# âœ… æ­£ç¡®
from modules.transfer.models import TransferSession

# âŒ é”™è¯¯
from ..transfer.models import TransferSession
```

### 3.4 æ—¶åŒºè§„èŒƒ

é¡¹ç›®ç»Ÿä¸€ä½¿ç”¨ **ä¸œå…«åŒºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼ŒUTC+8ï¼‰** ä½œä¸ºæ ‡å‡†æ—¶é—´ã€‚

#### 3.4.1 æ—¶åŒºå·¥å…·æ¨¡å—

æ‰€æœ‰æ—¶é—´æ“ä½œå¿…é¡»ä½¿ç”¨ `utils.timezone` æ¨¡å—æä¾›çš„å·¥å…·å‡½æ•°ï¼š

```python
from utils.timezone import (
    BEIJING_TZ,          # ä¸œå…«åŒºæ—¶åŒºå¯¹è±¡
    get_beijing_time,    # è·å–å½“å‰åŒ—äº¬æ—¶é—´
    to_beijing_time,     # å°†ä»»æ„æ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
    utc_to_beijing,      # UTC æ—¶é—´è½¬åŒ—äº¬æ—¶é—´
    beijing_to_utc       # åŒ—äº¬æ—¶é—´è½¬ UTC æ—¶é—´
)
```

#### 3.4.2 æ•°æ®åº“æ—¶é—´å­—æ®µè§„èŒƒ

æ‰€æœ‰æ•°æ®åº“ `DateTime` å­—æ®µ**å¿…é¡»**éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

```python
from utils.timezone import get_beijing_time

class MyModel(Base):
    # âœ… æ­£ç¡®ï¼šä½¿ç”¨ DateTime(timezone=True) + get_beijing_time
    created_at = Column(DateTime(timezone=True), default=get_beijing_time, comment="åˆ›å»ºæ—¶é—´")
    updated_at = Column(DateTime(timezone=True), default=get_beijing_time, onupdate=get_beijing_time, comment="æ›´æ–°æ—¶é—´")
    
    # âŒ é”™è¯¯ï¼šä½¿ç”¨ datetime.now()ï¼ˆæ— æ—¶åŒºä¿¡æ¯ï¼‰
    # created_at = Column(DateTime, default=datetime.now)
    
    # âŒ é”™è¯¯ï¼šä½¿ç”¨ UTC æ—¶é—´
    # created_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))
    
    # âŒ é”™è¯¯ï¼šä½¿ç”¨ server_default=func.now()ï¼ˆä¾èµ–æ•°æ®åº“æ—¶åŒºï¼‰
    # created_at = Column(DateTime, server_default=func.now())
```

**è¦ç‚¹è¯´æ˜ï¼š**

| è§„åˆ™ | è¯´æ˜ |
|:---|:---|
| `DateTime(timezone=True)` | å¿…é¡»å¯ç”¨æ—¶åŒºæ”¯æŒï¼Œç¡®ä¿æ•°æ®åº“å­˜å‚¨æ—¶åŒºä¿¡æ¯ |
| `default=get_beijing_time` | ä½¿ç”¨å·¥å…·å‡½æ•°ä½œä¸ºé»˜è®¤å€¼ï¼Œä¸è¦ä½¿ç”¨ lambda |
| `onupdate=get_beijing_time` | æ›´æ–°æ—¶é—´å­—æ®µåŒæ ·ä½¿ç”¨å·¥å…·å‡½æ•° |

#### 3.4.3 ä¸šåŠ¡å±‚æ—¶é—´æ“ä½œè§„èŒƒ

åœ¨ä¸šåŠ¡ä»£ç ä¸­è·å–å½“å‰æ—¶é—´ï¼š

```python
from utils.timezone import get_beijing_time, to_beijing_time

# âœ… æ­£ç¡®ï¼šè·å–å½“å‰åŒ—äº¬æ—¶é—´
now = get_beijing_time()

# âœ… æ­£ç¡®ï¼šå°†ç”¨æˆ·è¾“å…¥æ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
user_time = to_beijing_time(input_datetime)

# âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ datetime.now()
# now = datetime.now()

# âŒ é”™è¯¯ï¼šä½¿ç”¨ UTC æ—¶é—´
# now = datetime.now(timezone.utc)
```

#### 3.4.4 API å“åº”æ—¶é—´æ ¼å¼

æ—¶é—´å­—æ®µåœ¨ JSON å“åº”ä¸­åº”ä½¿ç”¨ ISO 8601 æ ¼å¼ï¼Œå¹¶åŒ…å«æ—¶åŒºä¿¡æ¯ï¼š

```python
# âœ… æ­£ç¡®ï¼šå¸¦æ—¶åŒºçš„ ISO æ ¼å¼
"created_at": "2026-01-06T19:00:00+08:00"

# âŒ é”™è¯¯ï¼šæ— æ—¶åŒºä¿¡æ¯
"created_at": "2026-01-06T19:00:00"
```

#### 3.4.5 ä¾‹å¤–æƒ…å†µ

ä»¥ä¸‹åœºæ™¯ä»ä½¿ç”¨ UTC æ—¶é—´ï¼š

| åœºæ™¯ | åŸå›  |
|:---|:---|
| JWT ä»¤ç‰Œè¿‡æœŸæ—¶é—´ (`exp`) | JWT æ ‡å‡†è§„èŒƒè¦æ±‚ä½¿ç”¨ UTC |
| ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ | å¤–éƒ¨ API å¯èƒ½è¦æ±‚ UTC |
| cron å®šæ—¶ä»»åŠ¡æ—¶é—´è®¡ç®— | é¿å…å¤ä»¤æ—¶ç­‰å¤æ‚æ—¶åŒºé—®é¢˜ |

---

## å››ã€æ¨¡å—å¼€å‘å®æˆ˜

### 4.1 ä½¿ç”¨ CLI è„šæ‰‹æ¶ï¼ˆæ¨èï¼‰

**3 ç§’é’Ÿç”Ÿæˆå®Œæ•´æ¨¡å—ï¼š**

```bash
cd backend
python scripts/create_module.py <æ¨¡å—ID> <æ¨¡å—åç§°>

# ç¤ºä¾‹
python scripts/create_module.py todo_list å¾…åŠäº‹é¡¹
```

ç”Ÿæˆçš„ä»£ç åŒ…å«ï¼š
- ğŸ **åç«¯æ ¸å¿ƒ**ï¼šåŒ…å«è·¯ç”± (Router)ã€ä¸šåŠ¡é€»è¾‘ (Service)ã€æ•°æ®æ¨¡å‹ (Model) å’Œæ•°æ®éªŒè¯ (Schema)
- ğŸ¨ **å‰ç«¯ç»„ä»¶**ï¼šåŒ…å« JS é¡µé¢ç»„ä»¶å’Œé…å¥—çš„ CSS æ ·å¼
- ğŸ“œ **è‡ªåŠ¨æ³¨å†Œ**ï¼šæ¨¡å—æ¸…å• (Manifest) å°†è‡ªåŠ¨æ³¨å†Œåˆ°ç³»ç»Ÿ

### 4.2 æ‰‹åŠ¨å¼€å‘æµç¨‹

#### 4.2.1 å®šä¹‰æ¸…å• (`{id}_manifest.py`)

```python
from core.loader import ModuleManifest, ModuleAssets
import logging

logger = logging.getLogger(__name__)

# ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¯é€‰ï¼‰
async def on_install():
    """æ¨¡å—å®‰è£…æ—¶æ‰§è¡Œ"""
    logger.info("æ¨¡å—æ­£åœ¨å®‰è£…...")

async def on_enable():
    """æ¨¡å—å¯ç”¨æ—¶æ‰§è¡Œ"""
    logger.info("æ¨¡å—å·²å¯ç”¨")

async def on_disable():
    """æ¨¡å—ç¦ç”¨æ—¶æ‰§è¡Œ"""
    logger.info("æ¨¡å—å·²ç¦ç”¨")

manifest = ModuleManifest(
    # åŸºæœ¬ä¿¡æ¯
    id="todo",
    name="å¾…åŠäº‹é¡¹",
    version="1.0.0",
    description="ç®€å•é«˜æ•ˆçš„å¾…åŠäº‹é¡¹ç®¡ç†",
    icon="âœ…",
    author="JeJe WebOS",
    
    # è·¯ç”±é…ç½®
    router_prefix="/api/v1/todo",
    
    # èœå•é…ç½®
    menu={
        "title": "å¾…åŠ",
        "icon": "âœ…",
        "path": "/todo",
        "order": 10,
        "children": [
            {"title": "æˆ‘çš„å¾…åŠ", "path": "/todo/list", "icon": "ğŸ“"}
        ]
    },
    
    # å‰ç«¯èµ„æº
    assets=ModuleAssets(css=[], js=[]),
    
    # æƒé™å£°æ˜
    permissions=["todo.read", "todo.create", "todo.update", "todo.delete"],
    
    # æ¨¡å—ä¾èµ–
    dependencies=[],
    
    # å†…æ ¸ç‰ˆæœ¬è¦æ±‚
    kernel_version=">=1.0.0",
    
    # æ˜¯å¦å¯ç”¨
    enabled=True,
    
    # ç”Ÿå‘½å‘¨æœŸé’©å­
    on_install=on_install,
    on_enable=on_enable,
    on_disable=on_disable,
)
```

#### 4.2.2 å®šä¹‰æ•°æ®æ¨¡å‹ (`{id}_models.py`)

```python
from core.database import Base
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import Integer, String, DateTime, ForeignKey
from datetime import datetime
from models import User
from utils.timezone import get_beijing_time

class TodoItem(Base):
    __tablename__ = "todo_items"  # âš ï¸ å¿…é¡»å¸¦æ¨¡å—å‰ç¼€
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey(User.id))
    title: Mapped[str] = mapped_column(String(200))
    completed: Mapped[bool] = mapped_column(default=False)
    # æ—¶é—´å­—æ®µç»Ÿä¸€ä½¿ç”¨ä¸œå…«åŒºæ—¶é—´ï¼ˆå‚è€ƒ 3.4 æ—¶åŒºè§„èŒƒï¼‰
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=get_beijing_time, comment="åˆ›å»ºæ—¶é—´")
    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=get_beijing_time, onupdate=get_beijing_time, comment="æ›´æ–°æ—¶é—´")
```

#### 4.2.3 å®šä¹‰ Schema (`{id}_schemas.py`)

```python
from pydantic import BaseModel
from datetime import datetime

class TodoCreate(BaseModel):
    title: str
    completed: bool = False

class TodoUpdate(BaseModel):
    title: str | None = None
    completed: bool | None = None

class TodoResponse(BaseModel):
    id: int
    user_id: int
    title: str
    completed: bool
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True
```

#### 4.2.4 ç¼–å†™ä¸šåŠ¡é€»è¾‘ (`{id}_services.py`)

```python
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from .todo_models import TodoItem
from .todo_schemas import TodoCreate, TodoUpdate

class TodoService:
    @staticmethod
    async def create_todo(db: AsyncSession, user_id: int, data: TodoCreate) -> TodoItem:
        todo = TodoItem(user_id=user_id, **data.model_dump())
        db.add(todo)
        await db.commit()
        await db.refresh(todo)
        return todo
    
    @staticmethod
    async def get_todo_list(db: AsyncSession, user_id: int, skip: int = 0, limit: int = 10):
        stmt = select(TodoItem).where(TodoItem.user_id == user_id).offset(skip).limit(limit)
        result = await db.execute(stmt)
        return result.scalars().all()
```

#### 4.2.5 ç¼–å†™ API è·¯ç”± (`{id}_router.py`)

```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from core.database import get_db
from core.security import get_current_user, TokenData
from schemas.response import success
from .todo_schemas import TodoCreate, TodoUpdate, TodoResponse
from .todo_services import TodoService

router = APIRouter()

@router.post("/", response_model=dict)
async def create_todo(
    data: TodoCreate,
    db: AsyncSession = Depends(get_db),
    user: TokenData = Depends(get_current_user)
):
    todo = await TodoService.create_todo(db, user.user_id, data)
    return success(data=TodoResponse.model_validate(todo).model_dump())

@router.get("/", response_model=dict)
async def get_todo_list(
    skip: int = 0,
    limit: int = 10,
    db: AsyncSession = Depends(get_db),
    user: TokenData = Depends(get_current_user)
):
    todos = await TodoService.get_todo_list(db, user.user_id, skip, limit)
    return success(data=[TodoResponse.model_validate(t).model_dump() for t in todos])
```

### 4.3 æ¨¡å—æ‰“åŒ…ä¸å‘å¸ƒ

#### 4.3.1 ä½¿ç”¨æ‰“åŒ…è„šæœ¬

```bash
cd backend
python scripts/pack_module.py <module_id>

# ç¤ºä¾‹
python scripts/pack_module.py todo
```

ç”Ÿæˆçš„ `.jwapp` æ–‡ä»¶ä½äº `dist/` ç›®å½•ã€‚

#### 4.3.2 æ‰“åŒ…æ ¼å¼

`.jwapp` æ˜¯ä¸€ä¸ª ZIP å‹ç¼©åŒ…ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
todo.jwapp (ZIP å‹ç¼©åŒ…)
â””â”€â”€ todo/                   # å¿…é¡»åŒ…å«ä¸€å±‚ä»¥æ¨¡å—IDå‘½åçš„æ ¹æ–‡ä»¶å¤¹
    â”œâ”€â”€ __init__.py         # åŒ…åˆå§‹åŒ–æ–‡ä»¶
    â”œâ”€â”€ todo_manifest.py    # æ¨¡å—æ¸…å•
    â”œâ”€â”€ todo_router.py      # è·¯ç”±å®šä¹‰
    â””â”€â”€ ...                 # å…¶ä»–æ¨¡å—æ–‡ä»¶
```

> âš ï¸ **æ³¨æ„**ï¼šå‹ç¼©åŒ…å†…**å¿…é¡»**åŒ…å«é¡¶å±‚çš„æ–‡ä»¶å¤¹ï¼Œä¸èƒ½ç›´æ¥å°†æ–‡ä»¶æ”¾åœ¨å‹ç¼©åŒ…æ ¹ç›®å½•ã€‚

---

## äº”ã€å‰ç«¯å¼€å‘æŒ‡å—

### 5.1 é¡µé¢ç»„ä»¶å¼€å‘

åœ¨ `frontend/js/pages/` ä¸­åˆ›å»ºé¡µé¢ç»„ä»¶ï¼š

```javascript
// frontend/js/pages/todo.js
class TodoPage extends Component {
    constructor(container) {
        super(container);
        this.state = {
            list: [],
            loading: false
        };
    }

    render() {
        const { list, loading } = this.state;
        return `
            <div class="page-todo">
                <h1>å¾…åŠäº‹é¡¹</h1>
                ${loading ? '<div>åŠ è½½ä¸­...</div>' : ''}
                <ul>
                    ${list.map(item => `<li>${item.title}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    async afterMount() {
        const res = await Api.get('/todo/');
        this.setState({ list: res.data });
    }
}
```

### 5.2 æ³¨å†Œè·¯ç”±

åœ¨ `frontend/js/pages/app.js` ä¸­æ³¨å†Œé¡µé¢ï¼š

```javascript
'/todo/list': { 
    auth: true, 
    handler: wrap(TodoPage, 'å¾…åŠäº‹é¡¹') 
}
```

### 5.3 JS/CSS æ–‡ä»¶å‘½åä¸å­˜æ”¾è§„èŒƒ

#### 5.3.1 æ–‡ä»¶å‘½åè§„åˆ™

**æ ¸å¿ƒåŸåˆ™ï¼šJS å’Œ CSS æ–‡ä»¶å¿…é¡»ä¸€ä¸€å¯¹åº”ï¼Œä¸”æ–‡ä»¶åä¿æŒä¸€è‡´ã€‚**

| æ–‡ä»¶ç±»å‹ | å‘½åè§„åˆ™ | ç¤ºä¾‹ |
|---------|---------|------|
| **é¡µé¢ JS** | `{module_id}.js` æˆ– `{module_id}_{page_name}.js` | `todo.js`, `analysis_chart.js` |
| **é¡µé¢ CSS** | **å¿…é¡»ä¸ JS æ–‡ä»¶åå®Œå…¨ä¸€è‡´** | `todo.css`, `analysis_chart.css` |
| **ç»„ä»¶ JS** | `{component_name}.js` | `window.js`, `dock.js` |
| **ç»„ä»¶ CSS** | **å¿…é¡»ä¸ JS æ–‡ä»¶åå®Œå…¨ä¸€è‡´** | `window.css`, `dock.css` |
| **å·¥å…· JS** | `{tool_name}.js`ï¼ˆæ— éœ€å¯¹åº” CSSï¼‰ | `chart_factory.js`, `shortcut_manager.js` |

#### 5.3.2 ç›®å½•èŒè´£å®šä¹‰

å‰ç«¯ JS ç›®å½•é‡‡ç”¨**å››å±‚åˆ†ç¦»æ¶æ„**ï¼Œå„ç›®å½•èŒè´£å¦‚ä¸‹ï¼š

| ç›®å½• | èŒè´£ | ç‰¹å¾ | å…¸å‹æ–‡ä»¶ |
|------|------|------|----------|
| `js/core/` | **å†…æ ¸å±‚** | æ¡†æ¶çº§åŸºç¡€è®¾æ–½ï¼Œæä¾› API è°ƒç”¨ã€è·¯ç”±ã€åŸºç¡€ç»„ä»¶ç±»ç­‰ | `api.js`, `router.js`, `component.js` |
| `js/components/` | **UI ç»„ä»¶å±‚** | å¯å¤ç”¨çš„ç•Œé¢ç»„ä»¶ï¼Œå…·æœ‰ DOM ç»“æ„å’Œç”Ÿå‘½å‘¨æœŸ | `modal.js`, `toast.js`, `dock.js` |
| `js/utils/` | **å·¥å…·å±‚** | è·¨æ¨¡å—å¤ç”¨çš„ä¸šåŠ¡å·¥å…·å‡½æ•°ï¼Œçº¯é€»è¾‘æ—  DOM ä¾èµ– | `chart_factory.js`, `shortcut_manager.js` |
| `js/pages/` | **ä¸šåŠ¡å±‚** | å…·ä½“ä¸šåŠ¡æ¨¡å—çš„é¡µé¢ç»„ä»¶ | `todo.js`, `analysis/analysis.js` |

**ä¸¥æ ¼ç¦æ­¢ï¼š**
- âŒ åœ¨ `core/` ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘
- âŒ åœ¨ `components/` ä¸­å­˜æ”¾çº¯é€»è¾‘å·¥å…·å‡½æ•°
- âŒ åœ¨ `utils/` ä¸­å­˜æ”¾æœ‰ DOM ç”Ÿå‘½å‘¨æœŸçš„ UI ç»„ä»¶
- âŒ åœ¨ `pages/` ä¸­å­˜æ”¾é€šç”¨å·¥å…·æˆ–å¯å¤ç”¨ç»„ä»¶

#### 5.3.3 ç›®å½•è¯¦ç»†è¯´æ˜

##### `js/core/` - å†…æ ¸å±‚

å­˜æ”¾**æ¡†æ¶çº§åŸºç¡€è®¾æ–½**ï¼Œæ˜¯æ•´ä¸ªå‰ç«¯åº”ç”¨çš„åº•å±‚æ”¯æ’‘ï¼š

```javascript
// å…¸å‹ç‰¹å¾ï¼šæä¾›å…¨å±€ APIï¼Œè¢«æ‰€æœ‰å…¶ä»–å±‚ä¾èµ–
const Api = {
    get(url) { ... },
    post(url, data) { ... }
};
window.Api = Api;
```

**é€‚åˆå­˜æ”¾ï¼š**
- API è¯·æ±‚å°è£… (`api.js`)
- è·¯ç”±ç®¡ç† (`router.js`)
- åŸºç¡€ç»„ä»¶ç±» (`component.js`)
- å·¥å…·å‡½æ•°åº“ (`utils.js`)
- äº‹ä»¶æ€»çº¿ (`event_bus.js`)

**ä¸é€‚åˆå­˜æ”¾ï¼š**
- å…·ä½“ UI ç»„ä»¶
- ä¸šåŠ¡å·¥å…·ç±»
- é¡µé¢ç»„ä»¶

##### `js/components/` - UI ç»„ä»¶å±‚

å­˜æ”¾**å¯å¤ç”¨çš„ UI ç»„ä»¶**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

```javascript
// å…¸å‹ç‰¹å¾ï¼šç»§æ‰¿ Component ç±»ï¼Œæœ‰ render/afterMount ç”Ÿå‘½å‘¨æœŸ
class Modal {
    constructor(options) { ... }
    render() { return `<div class="modal">...</div>`; }
    show() { ... }
    close() { ... }
}
```

**é€‚åˆå­˜æ”¾ï¼š**
- æ¨¡æ€æ¡†ç»„ä»¶ (`modal.js`)
- æ¶ˆæ¯æç¤ºç»„ä»¶ (`toast.js`)
- ç³»ç»Ÿæ¡Œé¢ç»„ä»¶ (`dock.js`, `topbar.js`, `start_menu.js`)
- å…¨å±€æœç´¢ç»„ä»¶ (`spotlight.js`)
- å¸¦ UI äº¤äº’çš„æ•°æ®å·¥å…· (`data_tools.js`)

**ä¸é€‚åˆå­˜æ”¾ï¼š**
- çº¯é€»è¾‘å·¥å…·å‡½æ•°
- ä¸šåŠ¡é¡µé¢ç»„ä»¶

##### `js/utils/` - å·¥å…·å±‚

å­˜æ”¾**è·¨æ¨¡å—å¤ç”¨çš„ä¸šåŠ¡å·¥å…·å‡½æ•°**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

```javascript
// å…¸å‹ç‰¹å¾ï¼šçº¯é™æ€æ–¹æ³•ï¼Œæ—  DOM ä¾èµ–ï¼Œæä¾› API ä¾›å…¶ä»–æ¨¡å—è°ƒç”¨
const ChartFactory = {
    generateOption(type, data, config) { ... },  // çº¯é€»è¾‘è®¡ç®—
    validateConfig(config) { ... },              // å‚æ•°æ ¡éªŒ
    getColorScheme(scheme) { ... }               // è¿”å›æ•°æ®
};
window.ChartFactory = ChartFactory;
```

**é€‚åˆå­˜æ”¾ï¼š**
- å›¾è¡¨é…ç½®ç”Ÿæˆå™¨ (`chart_factory.js`, `chart_config_ui.js`)
- å›¾è¡¨æ ·å¼é…ç½® (`chart_style_config.js`)
- å¿«æ·æ–¹å¼ç®¡ç†å™¨ (`shortcut_manager.js`)
- æ¨¡å—å¸®åŠ©å·¥å…· (`module_help.js`)
- é€šç”¨æ•°æ®å¤„ç†å·¥å…·

**ä¸é€‚åˆå­˜æ”¾ï¼š**
- æœ‰ DOM ç»“æ„å’Œç”Ÿå‘½å‘¨æœŸçš„ UI ç»„ä»¶
- æ¡†æ¶çº§åŸºç¡€è®¾æ–½

##### `js/pages/` - ä¸šåŠ¡å±‚

å­˜æ”¾**å…·ä½“ä¸šåŠ¡æ¨¡å—çš„é¡µé¢ç»„ä»¶**ï¼š

```javascript
// å…¸å‹ç‰¹å¾ï¼šç»§æ‰¿ Componentï¼Œå®ç°å…·ä½“ä¸šåŠ¡é€»è¾‘
class TodoPage extends Component {
    constructor(container) { super(container); }
    render() { ... }
    async afterMount() { await this.loadData(); }
}
```

**é€‚åˆå­˜æ”¾ï¼š**
- å„ä¸šåŠ¡æ¨¡å—çš„ä¸»é¡µé¢
- æ¨¡å—å†…çš„å­é¡µé¢

**å­ç›®å½•è§„åˆ™ï¼š**
- ç®€å•æ¨¡å—ï¼šç›´æ¥æ”¾åœ¨ `pages/` ä¸‹ï¼Œå¦‚ `todo.js`
- å¤æ‚æ¨¡å—ï¼šåˆ›å»ºå­ç›®å½•ï¼Œå¦‚ `pages/analysis/analysis.js`

#### 5.3.4 æ–‡ä»¶å­˜æ”¾è§„åˆ™

**ç›®å½•ç»“æ„å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„èŒƒï¼š**

```
frontend/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ core/                    # å†…æ ¸å±‚ï¼ˆæ¡†æ¶çº§åŸºç¡€è®¾æ–½ï¼‰
â”‚   â”‚   â”œâ”€â”€ api.js               # API è¯·æ±‚å°è£…
â”‚   â”‚   â”œâ”€â”€ router.js            # è·¯ç”±ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ component.js         # åŸºç¡€ç»„ä»¶ç±»
â”‚   â”‚   â””â”€â”€ utils.js             # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ components/              # UI ç»„ä»¶å±‚ï¼ˆå¯å¤ç”¨ç•Œé¢ç»„ä»¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ modal.js             # æ¨¡æ€æ¡†
â”‚   â”‚   â”œâ”€â”€ toast.js             # æ¶ˆæ¯æç¤º
â”‚   â”‚   â”œâ”€â”€ dock.js              # åº•éƒ¨ Dock æ 
â”‚   â”‚   â””â”€â”€ topbar.js            # é¡¶éƒ¨çŠ¶æ€æ 
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å±‚ï¼ˆè·¨æ¨¡å—ä¸šåŠ¡å·¥å…·ï¼‰
â”‚   â”‚   â”œâ”€â”€ chart/               # å›¾è¡¨ç›¸å…³å·¥å…·ï¼ˆåŒå‰ç¼€åˆ†ç»„ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ chart_factory.js
â”‚   â”‚   â”‚   â”œâ”€â”€ chart_config_ui.js
â”‚   â”‚   â”‚   â”œâ”€â”€ chart_helper.js
â”‚   â”‚   â”‚   â”œâ”€â”€ chart_render_cache.js
â”‚   â”‚   â”‚   â””â”€â”€ chart_style_config.js
â”‚   â”‚   â”œâ”€â”€ module_help/         # æ¨¡å—å¸®åŠ©å·¥å…·ï¼ˆåŒå‰ç¼€åˆ†ç»„ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ module_help.js
â”‚   â”‚   â”‚   â””â”€â”€ module_help_contents.js
â”‚   â”‚   â””â”€â”€ shortcut_manager.js  # å¿«æ·æ–¹å¼ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ pages/                   # ä¸šåŠ¡å±‚ï¼ˆæ¨¡å—é¡µé¢ç»„ä»¶ï¼‰
â”‚       â”œâ”€â”€ todo.js              # ç®€å•æ¨¡å—
â”‚       â”œâ”€â”€ analysis/            # å¤æ‚æ¨¡å—ï¼ˆå­ç›®å½•ï¼‰
â”‚       â”‚   â”œâ”€â”€ analysis.js
â”‚       â”‚   â””â”€â”€ analysis_chart.js
â”‚       â””â”€â”€ datalens/
â”‚           â””â”€â”€ datalens.js
â”‚
â””â”€â”€ css/
    â”œâ”€â”€ core/                    # å†…æ ¸æ ·å¼
    â”œâ”€â”€ components/              # ç»„ä»¶æ ·å¼ï¼ˆä¸ js/components/ å¯¹åº”ï¼‰
    â”œâ”€â”€ utils/                   # å·¥å…·æ ·å¼ï¼ˆå¯é€‰ï¼Œå¦‚æœ‰ UI åˆ™éœ€è¦ï¼‰
    â””â”€â”€ pages/                   # é¡µé¢æ ·å¼ï¼ˆä¸ js/pages/ å¯¹åº”ï¼‰
        â”œâ”€â”€ todo.css
        â”œâ”€â”€ analysis/
        â”‚   â”œâ”€â”€ analysis.css
        â”‚   â””â”€â”€ analysis_chart.css
        â””â”€â”€ datalens/
            â””â”€â”€ datalens.css
```

**å­˜æ”¾è§„åˆ™ï¼š**
1. **ç›®å½•å¯¹åº”**ï¼š`js/pages/` ä¸­çš„æ–‡ä»¶å¿…é¡»åœ¨ `css/pages/` ä¸­æœ‰å¯¹åº”çš„ CSS æ–‡ä»¶
2. **å­ç›®å½•ä¸€è‡´**ï¼šå¦‚æœ JS æ–‡ä»¶åœ¨å­ç›®å½•ä¸­ï¼ŒCSS æ–‡ä»¶ä¹Ÿå¿…é¡»åœ¨ç›¸åŒçš„å­ç›®å½•ä¸­
3. **æ–‡ä»¶åä¸€è‡´**ï¼šCSS æ–‡ä»¶åå¿…é¡»ä¸å¯¹åº”çš„ JS æ–‡ä»¶åå®Œå…¨ä¸€è‡´
4. **å·¥å…·å±‚ä¾‹å¤–**ï¼š`js/utils/` ä¸­çš„æ–‡ä»¶å¦‚æœæ˜¯çº¯é€»è¾‘å·¥å…·ï¼Œå¯ä»¥ä¸éœ€è¦å¯¹åº”çš„ CSS æ–‡ä»¶
5. **åŒå‰ç¼€åˆ†ç»„**ï¼šå½“ç›®å½•ä¸‹æœ‰ **2 ä¸ªåŠä»¥ä¸ŠåŒå‰ç¼€** çš„æ–‡ä»¶æ—¶ï¼Œå¿…é¡»åˆ›å»ºå­ç›®å½•è¿›è¡Œåˆ†ç»„ç®¡ç†

#### 5.3.5 åŒå‰ç¼€æ–‡ä»¶åˆ†ç»„è§„åˆ™

**è§„åˆ™è¯´æ˜ï¼š**

å½“æŸä¸ªç›®å½•ä¸‹å­˜åœ¨ **2 ä¸ªæˆ– 2 ä¸ªä»¥ä¸Š** å…·æœ‰ç›¸åŒå‰ç¼€çš„æ–‡ä»¶æ—¶ï¼Œå¿…é¡»å°†è¿™äº›æ–‡ä»¶ç§»åŠ¨åˆ°ä»¥è¯¥å‰ç¼€å‘½åçš„å­ç›®å½•ä¸­ã€‚


**ç¤ºä¾‹ï¼š**

```
# âŒ é”™è¯¯ï¼šåŒå‰ç¼€æ–‡ä»¶æ•£è½åœ¨ç›®å½•ä¸­
js/utils/
â”œâ”€â”€ chart_factory.js
â”œâ”€â”€ chart_config_ui.js
â”œâ”€â”€ chart_helper.js
â”œâ”€â”€ chart_render_cache.js
â”œâ”€â”€ chart_style_config.js      # 5ä¸ª chart_ å‰ç¼€æ–‡ä»¶
â”œâ”€â”€ module_help.js             # 2ä¸ª module_help å‰ç¼€æ–‡ä»¶
â”œâ”€â”€ module_help_contents.js
â””â”€â”€ shortcut_manager.js

# âœ… æ­£ç¡®ï¼šåˆ›å»ºå­ç›®å½•åˆ†ç»„
js/utils/
â”œâ”€â”€ chart/                      # å›¾è¡¨ç›¸å…³å·¥å…·å­ç›®å½•
â”‚   â”œâ”€â”€ chart_factory.js
â”‚   â”œâ”€â”€ chart_config_ui.js
â”‚   â”œâ”€â”€ chart_helper.js
â”‚   â”œâ”€â”€ chart_render_cache.js
â”‚   â””â”€â”€ chart_style_config.js
â”œâ”€â”€ module_help/                # æ¨¡å—å¸®åŠ©å·¥å…·å­ç›®å½•
â”‚   â”œâ”€â”€ module_help.js
â”‚   â””â”€â”€ module_help_contents.js
â””â”€â”€ shortcut_manager.js
```

**é€‚ç”¨èŒƒå›´ï¼ˆæ•´ä¸ªé¡¹ç›®ï¼‰ï¼š**
- `frontend/js/` æ‰€æœ‰å­ç›®å½•
- `frontend/css/` æ‰€æœ‰å­ç›®å½•
- `backend/modules/` å„æ¨¡å—å†…éƒ¨
- `backend/utils/` å·¥å…·ç›®å½•
- å…¶ä»–ä»»ä½•åŒ…å«åŒå‰ç¼€æ–‡ä»¶çš„ç›®å½•

**ä¾‹å¤–æƒ…å†µï¼š**
- `backend/core/` å†…æ ¸å±‚ä¸é€‚ç”¨æ­¤è§„åˆ™
- `frontend/js/core/` å†…æ ¸å±‚ä¸é€‚ç”¨æ­¤è§„åˆ™

#### 5.3.6 åˆ¤æ–­æ–‡ä»¶å½’å±çš„å†³ç­–æµç¨‹

å½“ä¸ç¡®å®šæ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªä¸ªç›®å½•æ—¶ï¼ŒæŒ‰ä»¥ä¸‹æµç¨‹åˆ¤æ–­ï¼š

```
æ˜¯å¦æ˜¯æ¡†æ¶çº§åŸºç¡€è®¾æ–½ï¼ˆAPIã€è·¯ç”±ã€åŸºç¡€ç±»ï¼‰ï¼Ÿ
    â”œâ”€â”€ æ˜¯ â†’ js/core/
    â””â”€â”€ å¦ â†“

æ˜¯å¦æœ‰ DOM ç»“æ„å’Œç”Ÿå‘½å‘¨æœŸï¼ˆrenderã€afterMountï¼‰ï¼Ÿ
    â”œâ”€â”€ æ˜¯ â†’ æ˜¯å¦æ˜¯é€šç”¨ UI ç»„ä»¶ï¼Ÿ
    â”‚         â”œâ”€â”€ æ˜¯ â†’ js/components/
    â”‚         â””â”€â”€ å¦ â†’ js/pages/
    â””â”€â”€ å¦ â†“

æ˜¯å¦æ˜¯è·¨æ¨¡å—å¤ç”¨çš„ä¸šåŠ¡å·¥å…·ï¼Ÿ
    â”œâ”€â”€ æ˜¯ â†’ js/utils/
    â””â”€â”€ å¦ â†’ js/pages/ï¼ˆä½œä¸ºæ¨¡å—å†…éƒ¨å·¥å…·ï¼‰
```

### 5.4 åº”ç”¨å›¾æ ‡è®¾è®¡è§„èŒƒ

ä¸ºäº†ä¿è¯ç³»ç»Ÿè§†è§‰ä½“éªŒçš„é«˜åº¦ç»Ÿä¸€ä¸ä¸“ä¸šæ„Ÿï¼Œæ‰€æœ‰æ¨¡å—çš„åº”ç”¨å›¾æ ‡å¿…é¡»éµå¾ª **"Premium MacOS é£æ ¼"** åŠå…¶å¯¹åº”çš„å®ç°è§„èŒƒï¼š

#### 5.4.1 å›¾æ ‡æ ¸å¿ƒè®¾è®¡
1. **å®¹å™¨å½¢çŠ¶ (Squircle)**ï¼šå›¾æ ‡å®¹å™¨å¿…é¡»é‡‡ç”¨ iOS/macOS é£æ ¼çš„è¶…æ¤­åœ†åœ†è§’çŸ©å½¢ï¼Œåœ¨ `app-icon-box` ç±»ä¸­ç»Ÿä¸€å®šä¹‰ã€‚
2. **é²œæ´»æ¸å˜ (Vibrant Gradients)**ï¼šå¿…é¡»ä½¿ç”¨æ˜äº®çš„çº¿æ€§æ¸å˜è‰²èƒŒæ™¯ã€‚ç¦æ­¢ä½¿ç”¨å•ä¸€çº¯è‰²ã€‚
   - ç¤ºä¾‹ï¼š`linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)`
3. **ç™½è‰²çº¿æ€§å›¾æ ‡ (White Remix Icon)**ï¼šä¸­é—´å›¾æ ‡å¿…é¡»ä½¿ç”¨ç™½è‰² (`#ffffff`) çš„ **Remix Icon**ã€‚
4. **ç»ç’ƒ/é«˜å…‰è´¨æ„Ÿ**ï¼šå›¾æ ‡å®¹å™¨é¡¶éƒ¨å¿…é¡»åŒ…å« 50% åŒºåŸŸçš„åŠé€æ˜ç™½è‰²é®ç½©ï¼Œä»¥äº§ç”Ÿé«˜å…‰æ„Ÿã€‚

#### 5.4.2 å¼€å‘æ³¨å†Œæµç¨‹
æ–°å¼€å‘çš„åº”ç”¨åœ¨æ³¨å†Œåˆ°ç³»ç»Ÿæ—¶ï¼Œå¿…é¡»åœ¨ä»¥ä¸‹ä½ç½®å®Œæˆå›¾æ ‡æ˜ å°„ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºé»˜è®¤ Emojiï¼š

- **æ ¸å¿ƒæ˜ å°„è¡¨**ï¼šåœ¨ `frontend/js/pages/market.js` çš„ `_getIconSpec` æ–¹æ³•ä¸­æ·»åŠ å®šä¹‰ã€‚
- **å¼€å§‹èœå•æ˜ å°„**ï¼šåœ¨ `frontend/js/components/start_menu.js` çš„ `_getIconSpec` æ–¹æ³•ä¸­æ·»åŠ å®šä¹‰ã€‚
- **Dock æ æ˜ å°„**ï¼šåœ¨ `frontend/js/components/dock.js` çš„ `_getIconSpec` æ–¹æ³•ä¸­æ·»åŠ å®šä¹‰ã€‚

#### 5.4.3 é¢„å®šä¹‰æ¸å˜è‰²åº“
å¼€å‘è€…åº”ä¼˜å…ˆä½¿ç”¨ `frontend/css/pages/market.css` ä¸­å·²å®šä¹‰çš„æ¸å˜ç±»ï¼Œå¦‚ï¼š
- `gradient-blue`: è“è‰²ï¼ˆçŸ¥è¯†åº“ã€åšå®¢ï¼‰
- `gradient-yellow`: é»„è‰²ï¼ˆç¬”è®°ï¼‰
- `gradient-emerald`: ç¿ ç»¿ï¼ˆåœ°å›¾ï¼‰
- `gradient-indigo`: é›è“ï¼ˆAIã€æ–‡ä»¶ç®¡ç†ï¼‰
- `gradient-purple`: ç´«è‰²ï¼ˆæ•°æ®åˆ†æï¼‰

---

## å…­ã€å­˜å‚¨è§„èŒƒ

### 6.1 å­˜å‚¨ç›®å½•ç»“æ„

```
storage/
â”œâ”€â”€ public/                      # ç³»ç»Ÿå…¬å…±èµ„æºï¼ˆä¸åŒºåˆ†ç”¨æˆ·ï¼Œå…¨å‘˜å¯è§ï¼‰
â”‚   â”œâ”€â”€ avatars/                # ç”¨æˆ·å¤´åƒ
â”‚   â””â”€â”€ attachments/            # å…¬å…±é™„ä»¶ï¼ˆå…¨å‘˜å¯è§çš„åº“ï¼‰
â”‚
â”œâ”€â”€ modules/                     # æ¨¡å—ä¸“å±å­˜å‚¨ï¼ˆæŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼Œæ ¸å¿ƒæ•°æ®åŒºï¼‰
â”‚   â”œâ”€â”€ ai/                      # AI åŠ©æ‰‹æ¨¡å—
â”‚   â”‚   â””â”€â”€ ai_models/           # æœ¬åœ°ç¦»çº¿å¤§æ¨¡å‹æ–‡ä»¶ (GGUF, TensorRT)
â”‚   â”œâ”€â”€ album/                   # ç›¸å†Œæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ uploads/             # åŸå§‹ç…§ç‰‡æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ outputs/             # ç³»ç»Ÿç”Ÿæˆçš„é¢„è§ˆç¼©ç•¥å›¾
â”‚   â”œâ”€â”€ analysis/                # æ•°æ®åˆ†ææ¨¡å—
â”‚   â”‚   â”œâ”€â”€ uploads/             # å¾…åˆ†æçš„åŸå§‹æ•°æ®é›† (CSV/Excel)
â”‚   â”‚   â”œâ”€â”€ outputs/             # åˆ†æç”Ÿæˆçš„æ¸…ç†æ•°æ®æˆ–å¯è§†åŒ–æˆæœ
â”‚   â”‚   â”œâ”€â”€ temp/                # ä»»åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´ä¸´æ—¶æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ analysis.db          # DuckDB æŒä¹…åŒ–åˆ†æå¼•æ“æ•°æ®åº“
â”‚   â”œâ”€â”€ blog/                    # åšå®¢æ¨¡å—
â”‚   â”‚   â””â”€â”€ uploads/             # æ–‡ç« å¼•ç”¨çš„åŸå§‹é™„ä»¶ã€å›¾ç‰‡
â”‚   â”œâ”€â”€ course/                  # è¯¾ç¨‹æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ uploads/             # æ•™å­¦ç´ æã€è§†é¢‘è¯¾ç¨‹ã€èµ„æºåŒ…
â”‚   â”‚   â””â”€â”€ outputs/             # ç”Ÿæˆçš„è¯¾ä»¶ã€è®²ä¹‰å¯¼å‡º
â”‚   â”œâ”€â”€ exam/                    # è€ƒè¯•æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ uploads/             # åŸå§‹è¯•å·åº“ã€é¢˜åº“é™„ä»¶
â”‚   â”‚   â””â”€â”€ outputs/             # è€ƒç”Ÿæˆç»©å•ã€åˆ†ææŠ¥å‘Š
â”‚   â”œâ”€â”€ feedback/                # åé¦ˆæ¨¡å—
â”‚   â”‚   â””â”€â”€ uploads/             # ç”¨æˆ·åé¦ˆæ—¶ä¸Šä¼ çš„æˆªå›¾æˆ–æ—¥å¿—
â”‚   â”œâ”€â”€ filemanager/             # æ–‡ä»¶ç®¡ç†ç½‘ç›˜ (æœ¬èº«ä½œä¸ºä¸šåŠ¡æ¨¡å—)
â”‚   â”‚   â”œâ”€â”€ uploads/             # ç”¨æˆ·ç›´æ¥ä½œä¸ºç½‘ç›˜ä¸Šä¼ çš„å„ç§æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ outputs/             # ç½‘ç›˜å†…æ‰¹é‡æ“ä½œï¼ˆå‹ç¼©ã€å¯¼å‡ºï¼‰çš„ç”Ÿæˆç‰©
â”‚   â”œâ”€â”€ im/                      # å³æ—¶é€šè®¯æ¨¡å—
â”‚   â”‚   â””â”€â”€ uploads/             # èŠå¤©è¿‡ç¨‹ä¸­ä¼ è¾“çš„å¤šåª’ä½“æ–‡ä»¶åŠé™„ä»¶
â”‚   â”œâ”€â”€ knowledge/               # çŸ¥è¯†åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ embedding_models/    # è¯­ä¹‰å‘é‡åŒ–æ¨¡å‹ (Sentence-Transformers)
â”‚   â”‚   â””â”€â”€ vector_db/           # ChromaDB/Milvus å‘é‡æ•°æ®åº“ç´¢å¼•
â”‚   â”œâ”€â”€ map/                     # åœ°å›¾ä¸è½¨è¿¹æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ map_tiles/           # ç¦»çº¿åœ°å›¾ç“¦ç‰‡å›¾ç‰‡ç¼“å­˜
â”‚   â”‚   â””â”€â”€ map_gps/             # ç”¨æˆ·ä¸Šä¼ æˆ–ç”Ÿæˆçš„è½¨è¿¹ (GPX/KML) æ–‡ä»¶
â”‚   â”œâ”€â”€ ocr/                     # å›¾æ–‡è¯†åˆ«æ¨¡å—
â”‚   â”‚   â””â”€â”€ ocr_models/          # è½»é‡çº§æœ¬åœ°è¯†åˆ«æ¨¡å‹ (ONNX)
â”‚   â”œâ”€â”€ pdf/                     # PDF å·¥å…·ç®± (æ¨¡å—è‡ªæ²»æ¨¡å¼)
â”‚   â”‚   â”œâ”€â”€ uploads/             # ç”¨æˆ·ä¸Šä¼ å¾…å¤„ç†çš„åŸå§‹ PDF
â”‚   â”‚   â””â”€â”€ outputs/             # å¤„ç†ï¼ˆè½¬æ¢ã€åˆå¹¶ç­‰ï¼‰å‡ºçš„æˆæœæ–‡ä»¶
â”‚   â””â”€â”€ video/                   # è§†é¢‘æ’­æ”¾å™¨æ¨¡å—
â”‚       â”œâ”€â”€ uploads/             # åŸå§‹è§†é¢‘æ–‡ä»¶åº“
â”‚       â””â”€â”€ outputs/             # è‡ªåŠ¨æŠ“å–çš„è§†é¢‘å°é¢ç¼©ç•¥å›¾
â”‚
â”‚   # âš ï¸ ç‰¹æ®Šéš”ç¦»åŸåˆ™
â”‚   # vault: ä¸¥ç¦åœ¨ storage/modules äº§ç”Ÿå¯è§ç›®å½•ï¼Œæ•°æ®å¿…é¡»åŠ å¯†å­˜å‚¨
â”‚   # transfer: ä¸¥ç¦äº§ç”ŸæŒä¹…ç›®å½•ï¼Œç¢ç‰‡æ•°æ®ç»Ÿå½’ storage/system/transfer_temp ä¸” 24h è‡ªåŠ¨æ¸…ç†
â”‚   # schedule: çº¯æ•°æ®åº“è®°å½•ï¼Œæ— ç‰©ç†å­˜å‚¨ç›®å½•
â”‚
â””â”€â”€ system/                      # ç³»ç»Ÿè¿è¡Œç»´æŠ¤ç›®å½•
    â”œâ”€â”€ backups/                 # è‡ªåŠ¨åŒ–åŠæ‰‹åŠ¨æ•°æ®åº“å¤‡ä»½ (.sql/.zip)
    â”œâ”€â”€ logs/                    # è¿è¡Œæ—¶æ—¥å¿—æ–‡ä»¶ (.log)
    â””â”€â”€ transfer_temp/           # è·¨ç«¯å¿«ä¼ çš„ç¬æ—¶ç¢ç‰‡ç¼“å­˜ (å³ç„š)
```

### 6.2 StorageManager API ä½¿ç”¨è§„èŒƒ

#### 6.2.1 è·å–ç”¨æˆ·ç§æœ‰ç›®å½• (Cloud Drive)

> âš ï¸ **é‡è¦å˜æ›´**ï¼šç³»ç»Ÿå·²å¼ƒç”¨é¡¶å±‚ `storage/users/` ç›®å½•ã€‚æ‰€æœ‰â€œç”¨æˆ·ç§æœ‰æ–‡ä»¶â€ç°åœ¨é€»è¾‘ä¸Šå½’å±äº **ç½‘ç›˜ (FileManager)** æ¨¡å—ã€‚

```python
from utils.storage import get_storage_manager

storage_manager = get_storage_manager()

# è·å–ç”¨æˆ·ç½‘ç›˜ä¸Šä¼ ç›®å½•
# æ­¤è°ƒç”¨ç°åœ¨ä¼šè‡ªåŠ¨é‡å®šå‘è‡³: storage/modules/filemanager/uploads/user_1/
user_upload_dir = storage_manager.get_user_dir(user_id=1, sub_dir="uploads")

# è·å–ç”¨æˆ·ç½‘ç›˜å¯¼å‡ºç›®å½•
# é€»è¾‘è·¯å¾„: storage/modules/filemanager/exports/user_1/
user_export_dir = storage_manager.get_user_dir(user_id=1, sub_dir="exports")
```

#### 6.2.2 è·å–æ¨¡å—ç›®å½•

```python
# è·å–æ¨¡å—ä¸´æ—¶ç›®å½•ï¼ˆæŒ‰ç”¨æˆ·éš”ç¦»ï¼‰
temp_dir = storage_manager.get_module_dir("report", "temp", user_id=1)
# â†’ storage/modules/report/temp/user_1/

# è·å–æ¨¡å—å½’æ¡£ç›®å½•ï¼ˆæŒ‰ç”¨æˆ·éš”ç¦»ï¼‰
archive_dir = storage_manager.get_module_dir("report", "archive", user_id=1)
# â†’ storage/modules/report/archive/user_1/
```

#### 6.2.3 è·å–ç³»ç»Ÿçº§ç›®å½•

```python
# è·å–å¤‡ä»½ç›®å½•
backup_dir = storage_manager.get_system_dir("backups")
# â†’ storage/system/backups/
```

4. **å¿…é¡»æ”¯æŒæ¸…ç†**ï¼šåˆ é™¤ç”¨æˆ·æˆ–æ¨¡å—æ—¶ï¼Œå¿…é¡»åŒæ—¶æ¸…ç†å¯¹åº”çš„æ–‡ä»¶ç›®å½•

### 6.4 æ¨¡å—æ–‡ä»¶ç®¡ç†è®¾è®¡æ¨¡å¼ (æ ¸å¿ƒåŸåˆ™)

ä¸ºäº†ä¿è¯æ¨¡å—çš„å¥å£®æ€§ä¸è§£è€¦ï¼Œç³»ç»Ÿé‡‡ç”¨ **"æ¨¡å—è‡ªæ²» + ç»Ÿä¸€å…¥å£"** çš„æ··åˆæ¨¡å¼ã€‚

#### 6.4.1 æ¨¡å—è‡ªæ²»åŸåˆ™ (Module Autonomy)
1. **äºŒå…ƒç›®å½•ç»“æ„**ï¼šæ¨¡å—å¿…é¡»å»ºç«‹ `uploads`ï¼ˆå­˜åŸä»¶ï¼‰å’Œ `outputs`ï¼ˆå­˜æˆæœï¼‰ç›®å½•ã€‚å¦‚æ¶‰åŠå¤æ‚è¿ç®—ï¼Œå¯å¢åŠ  `temp`ã€‚æ‰€æœ‰ç‰©ç†æ–‡ä»¶å­˜æ”¾åœ¨ `storage/modules/{module_id}/` ä¸‹ã€‚
2. **å¼ƒç”¨é¡¶å±‚ Users**ï¼šä¸¥ç¦ç›´æ¥åœ¨ `storage/users/` ä¸‹åˆ›å»ºç›®å½•ã€‚
3. **ç‹¬ç«‹æ¥å£**ï¼šæ¨¡å—å¿…é¡»æä¾›è‡ªå·±çš„ `/upload`ã€`/files` æ¥å£ï¼Œæµç¨‹é—­ç¯åº”åœ¨æ¨¡å—å†…éƒ¨å®Œæˆã€‚
4. **å®Œå…¨è„±é’©**ï¼šå„æ¨¡å—çš„ç‰©ç†å­˜å‚¨ç›®å½•**ä¸å†**è‡ªåŠ¨æ˜ å°„åˆ°æ–‡ä»¶ç®¡ç†å™¨ã€‚

#### 6.4.2 æ–‡ä»¶ç®¡ç†å™¨å®šä½ (Independent App)
1. **ç‹¬ç«‹åº”ç”¨**ï¼šæ–‡ä»¶ç®¡ç†å™¨ (`FileManager`) ç°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„â€œç½‘ç›˜â€åº”ç”¨è¿è¡Œï¼Œä»…ç®¡ç†å­˜æ”¾åœ¨å…¶è‡ªèº«æ•°æ®åº“ (`fm_files`, `fm_folders`) ä¸­çš„æ–‡ä»¶ã€‚
2. **æŒ‰éœ€æ³¨å†Œ**ï¼šå¦‚æœä¸šåŠ¡æ¨¡å—å¸Œæœ›å°†ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆå¦‚å¯¼å‡ºçš„ PDFã€ç”Ÿæˆçš„æŠ¥è¡¨ï¼‰æä¾›ç»™ç”¨æˆ·åœ¨ç½‘ç›˜ä¸­é•¿æœŸä¿å­˜ï¼Œå¯ä»¥é€šè¿‡ `FileManagerService.register_file()` æ¥å£æ˜ç¡®åœ°å°†æ–‡ä»¶æ³¨å†Œè¿› VFSã€‚
3. **æ— è‡ªåŠ¨èšåˆ**ï¼šç³»ç»Ÿä¸å†é€šè¿‡æ‰«ææˆ–é€‚é…å™¨æ–¹å¼å°†ç›¸å†Œã€è§†é¢‘ç­‰æ¨¡å—çš„æ–‡ä»¶è‡ªåŠ¨æ˜¾ç¤ºåœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼Œä»¥ä¿è¯å„æ¨¡å—çš„æ€§èƒ½ä¸æ•°æ®ç§å¯†æ€§ã€‚

#### 6.4.3 è®¾è®¡æ”¶ç›Š
*   **æè‡´è§£è€¦**ï¼šç§»é™¤é€‚é…å™¨å±‚ï¼Œå¤§å¹…é™ä½ç³»ç»Ÿå¤æ‚åº¦ï¼Œæ¶ˆé™¤æ¨¡å—é—´å¾ªç¯ä¾èµ–ã€‚
*   **æ€§èƒ½é£è·ƒ**ï¼šæ–‡ä»¶ç®¡ç†å™¨æµè§ˆç›®å½•æ—¶æ— éœ€è½®è¯¢å„ä¸ªæ¨¡å—çš„é€‚é…å™¨ï¼Œå“åº”é€Ÿåº¦æå‡è‡³æ¯«ç§’çº§ã€‚
*   **æ¶æ„æ¸…æ™°**ï¼šç‰©ç†å­˜å‚¨å½’å±æ˜ç¡®ï¼Œå„æ¨¡å—æ•°æ®ç”Ÿå‘½å‘¨æœŸäº’ä¸å¹²æ‰°ã€‚

---

## ä¸ƒã€æ³¨é‡Šè§„èŒƒ

### 7.1 æ³¨é‡Šè¯­è¨€

**æ‰€æœ‰æ³¨é‡Šå¿…é¡»ä½¿ç”¨ä¸­æ–‡**ï¼ŒåŒ…æ‹¬ï¼š
- æ–‡ä»¶å¤´éƒ¨è¯´æ˜
- å‡½æ•°/ç±»æ–‡æ¡£å­—ç¬¦ä¸²
- è¡Œå†…æ³¨é‡Š
- TODO/FIXME æ³¨é‡Š

### 7.2 æ³¨é‡Šç±»å‹

åªä¿ç•™**åŠŸèƒ½æ€§æ³¨é‡Š**ï¼Œç§»é™¤ä»¥ä¸‹ç±»å‹çš„æ³¨é‡Šï¼š
- âŒ è°ƒè¯•æ³¨é‡Šï¼ˆå¦‚ `# è°ƒè¯•ï¼šæ‰“å°å˜é‡`ï¼‰
- âŒ å¼€å‘æç¤ºï¼ˆå¦‚ `# æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¼˜åŒ–`ï¼‰
- âŒ æé†’æ³¨é‡Šï¼ˆå¦‚ `# æé†’ï¼šè®°å¾—æ›´æ–°`ï¼‰
- âŒ åºŸé™¤æ³¨é‡Šï¼ˆå¦‚ `# å·²åºŸé™¤ï¼Œä½¿ç”¨æ–°æ–¹æ³•`ï¼‰
- âŒ æ–°å¢æ ‡è®°ï¼ˆå¦‚ `# æ–°å¢ï¼šæ·»åŠ äº†åŠŸèƒ½`ï¼‰

### 7.3 æ³¨é‡Šç¤ºä¾‹

```python
# âœ… æ­£ç¡®ï¼šåŠŸèƒ½æ€§æ³¨é‡Š
# è·å–ç”¨æˆ·ä¸Šä¼ ç›®å½•
user_dir = storage_manager.get_user_dir(user_id, "uploads")

# âŒ é”™è¯¯ï¼šè°ƒè¯•æ³¨é‡Š
# è°ƒè¯•ï¼šæ‰“å°ç”¨æˆ·ç›®å½•
print(user_dir)

# âŒ é”™è¯¯ï¼šæé†’æ³¨é‡Š
# æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ£€æŸ¥æƒé™
```

### 7.4 æ•°æ®åº“æ³¨é‡Šè§„èŒƒ

æ‰€æœ‰æ•°æ®åº“è¡¨å’Œå­—æ®µå®šä¹‰**å¼ºåˆ¶åŒ…å«ä¸­æ–‡æ³¨é‡Š**ï¼Œä»¥æ”¯æŒæ•°æ®åº“å·¥å…·æŸ¥çœ‹å’Œæ–‡æ¡£ç”Ÿæˆã€‚

**è¡¨æ³¨é‡Šè¦æ±‚ï¼š**

åœ¨ `__table_args__` ä¸­æ·»åŠ  `'comment'` å±æ€§ã€‚

```python
# âœ… æ­£ç¡®
class BlogPost(Base):
    __tablename__ = "blog_posts"
    __table_args__ = {
        'extend_existing': True,
        'comment': 'åšå®¢æ–‡ç« è¡¨'  # å¿…é¡»æ·»åŠ ä¸­æ–‡è¡¨æ³¨é‡Š
    }
```

**å­—æ®µæ³¨é‡Šè¦æ±‚ï¼š**

åœ¨ `mapped_column` æˆ– `Column` ä¸­æ·»åŠ  `comment` å‚æ•°ã€‚ä¸¥ç¦ä»…ä½¿ç”¨ Python `#` æ³¨é‡Šã€‚

```python
# âœ… æ­£ç¡®
class BlogPost(Base):
    title: Mapped[str] = mapped_column(String(200), comment="æ–‡ç« æ ‡é¢˜")
    status: Mapped[str] = mapped_column(String(20), default="draft", comment="çŠ¶æ€")

# âŒ é”™è¯¯ï¼šä»…ä½¿ç”¨ Python æ³¨é‡Š
class BlogPost(Base):
    title: Mapped[str] = mapped_column(String(200))  # æ–‡ç« æ ‡é¢˜
```

---

## å…«ã€æµ‹è¯•è§„èŒƒ

> âš ï¸ **æµ‹è¯•æ˜¯å¿…é¡»çš„**ï¼šæ‰€æœ‰åŠŸèƒ½æ¨¡å—å¿…é¡»åŒ…å«æµ‹è¯•ç›®å½•å’ŒåŸºæœ¬æµ‹è¯•ç”¨ä¾‹ã€‚

### 8.1 æµ‹è¯•ç›®å½•ç»“æ„

åŠŸèƒ½æ¨¡å—çš„æµ‹è¯•ç›®å½•å¿…é¡»ä½¿ç”¨ `{module_id}_tests/` å‘½åæ ¼å¼ï¼š

```
modules/todo/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ todo_manifest.py
â”œâ”€â”€ todo_router.py
â”œâ”€â”€ todo_services.py
â””â”€â”€ todo_tests/                  # æµ‹è¯•ç›®å½•ï¼ˆå¿…é¡»å¸¦æ¨¡å—å‰ç¼€ï¼‰
    â”œâ”€â”€ __init__.py              # å¿…é¡»
    â”œâ”€â”€ conftest.py              # æµ‹è¯•å¤¹å…·å’Œé…ç½®
    â””â”€â”€ test_todo.py             # å•å…ƒæµ‹è¯•
```

> **æ³¨æ„**ï¼šç³»ç»Ÿçº§æµ‹è¯•ä½¿ç”¨ `backend/tests/` ç›®å½•ï¼ŒåŠŸèƒ½æ¨¡å—æµ‹è¯•ä½¿ç”¨ `{module_id}_tests/` ç›®å½•ã€‚

### 8.2 æµ‹è¯•ç¤ºä¾‹

```python
# modules/todo/todo_tests/test_todo.py
import pytest
from modules.todo.todo_services import TodoService
from modules.todo.todo_schemas import TodoCreate

class TestTodoService:
    @pytest.mark.asyncio
    async def test_create_todo(self, db_session, sample_user_id):
        """æµ‹è¯•åˆ›å»ºå¾…åŠ"""
        data = TodoCreate(title="æµ‹è¯•ä»»åŠ¡", content="æµ‹è¯•å†…å®¹")
        result = await TodoService.create(db_session, sample_user_id, data)
        assert result is not None
        assert result.title == "æµ‹è¯•ä»»åŠ¡"
    
    @pytest.mark.asyncio
    async def test_get_todo_not_found(self, db_session, sample_user_id):
        """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„è®°å½•"""
        result = await TodoService.get_by_id(db_session, 99999, sample_user_id)
        assert result is None
```

### 8.3 è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå•ä¸ªæ¨¡å—çš„æµ‹è¯•
python -m pytest modules/todo/todo_tests/ -v

# è¿è¡Œæ‰€æœ‰æ¨¡å—æµ‹è¯•ï¼ˆä½¿ç”¨æ¨¡å—å‰ç¼€å‘½åæ ¼å¼ï¼‰
python -m pytest modules/*_tests/ -v --ignore=modules/_template

# è¿è¡Œç³»ç»Ÿçº§æµ‹è¯• + æ¨¡å—æµ‹è¯•
python -m pytest tests/ modules/*/\*_tests/ -v

# è¿è¡Œå¸¦è¦†ç›–ç‡æŠ¥å‘Š
python -m pytest modules/todo/todo_tests/ -v --cov=modules/todo --cov-report=html
```

### 8.4 æµ‹è¯•è¦æ±‚

| è¦æ±‚ | è¯´æ˜ |
|:---|:---|
| **å¿…é¡»åˆ›å»ºæµ‹è¯•ç›®å½•** | æ¯ä¸ªåŠŸèƒ½æ¨¡å—å¿…é¡»åŒ…å« `{module_id}_tests/` ç›®å½• |
| **å¿…é¡»åŒ…å«åŸºæœ¬æµ‹è¯•** | è‡³å°‘è¦†ç›– CRUD æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥åœºæ™¯ |
| **æµ‹è¯•ç‹¬ç«‹æ€§** | æ¯ä¸ªæµ‹è¯•åº”ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„æ‰§è¡Œé¡ºåº |
| **ä½¿ç”¨å¼‚æ­¥æµ‹è¯•** | å¼‚æ­¥æ“ä½œä½¿ç”¨ `@pytest.mark.asyncio` æ ‡è®° |

---

## ä¹ã€ä¸‰å¤§æˆ’å¾‹

| æˆ’å¾‹ | è¯´æ˜ | åæœ |
|:---|:---|:---|
| ğŸ”´ **ä¸¥ç¦åç«¯æ¸²æŸ“ HTML** | åç«¯åªèƒ½è¿”å› JSONã€‚æ‰€æœ‰ UI å¿…é¡»åœ¨å‰ç«¯ JS ä¸­æ¸²æŸ“ã€‚ | ç ´åå‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ— æ³•é™æ€åŒ–éƒ¨ç½²ã€‚ |
| ğŸ”´ **ä¸¥ç¦è·¨æ¨¡å— Import** | æ¨¡å—ä¹‹é—´ç¦æ­¢ `from modules.blog import x`ã€‚ | å¯¼è‡´æ¨¡å—å¼ºè€¦åˆï¼Œæ— æ³•ç‹¬ç«‹çƒ­æ’æ‹”ã€‚è¯·ä½¿ç”¨ **äº‹ä»¶æ€»çº¿** é€šä¿¡ã€‚ |
| ğŸ”´ **ä¸¥ç¦ç§é€ å“åº”æ ¼å¼** | å¿…é¡»ä½¿ç”¨ `schemas.success()` ç­‰å·¥å…·å‡½æ•°ã€‚ | å¯¼è‡´å‰ç«¯ API è§£æå™¨æ— æ³•ç»Ÿä¸€å¤„ç†é”™è¯¯ã€‚ |

---

## åã€æ¨¡å—å­˜å‚¨ä¸ VFS äº¤äº’è§„èŒƒ

### 10.1 å­˜å‚¨ç‹¬ç«‹æ€§

æ¨¡å—äº§ç”Ÿçš„æ–‡ä»¶åº”ä¼˜å…ˆä¿å­˜åœ¨æ¨¡å—è‡ªå·±çš„å­˜å‚¨ç›®å½•ä¸‹ï¼š`storage/modules/{module_id}/{sub_dir}/user_{id}/`ã€‚æ¨¡å—åº”åœ¨è‡ªå·±çš„æ•°æ®åº“ä¸­è®°å½•è¿™äº›æ–‡ä»¶ã€‚

### 10.2 VFS æ³¨å†Œæ¥å£

å½“æ¨¡å—éœ€è¦å°†æ–‡ä»¶â€œå¯¼å‡ºâ€æˆ–â€œä¿å­˜â€åˆ°ç”¨æˆ·çš„ç½‘ç›˜æ—¶ï¼Œåº”ä½¿ç”¨ `FileManagerService` æä¾›çš„æ³¨å†Œæ¥å£ï¼š

```python
from modules.filemanager.filemanager_services import FileManagerService

# ä¸šåŠ¡æ¨¡å—è°ƒç”¨ç¤ºä¾‹
async def save_to_disk(db, user_id, filename, physical_path):
    service = FileManagerService(db, user_id)
    # å°†å·²å­˜åœ¨äºç‰©ç†ç£ç›˜çš„æ–‡ä»¶æ³¨å†Œåˆ° VFS çš„ "æˆ‘çš„æ–‡æ¡£" æ–‡ä»¶å¤¹ä¸­
    await service.register_file(
        folder_name="æˆ‘çš„æ–‡æ¡£",
        filename=filename,
        storage_path=physical_path,
        file_size=os.path.getsize(physical_path),
        mime_type="application/pdf"
    )
```

### 10.3 è§„èŒƒæ€»ç»“

| åŠ¨ä½œ | è§„èŒƒè¦æ±‚ |
|:---|:---|
| **æ¨¡å—å†…éƒ¨æ–‡ä»¶ç®¡ç†** | æ¨¡å—è‡ªå»ºè¡¨ï¼Œè‡ªå»ºä¸Šä¼ /ä¸‹è½½æ¥å£ï¼Œç‹¬ç«‹æ“ä½œæ–‡ä»¶ |
| **é€‚é…å™¨æ¨¡å¼** | **å·²åºŸå¼ƒ**ã€‚ä¸¥ç¦ç¼–å†™ `*_adapter.py` æ–‡ä»¶ |
| **è‡ªåŠ¨åŒæ­¥** | **å·²å–æ¶ˆ**ã€‚æ–‡ä»¶ç®¡ç†å™¨ä¸å†è‡ªåŠ¨å±•ç¤ºæ¨¡å—å†…éƒ¨æ–‡ä»¶ |
| **æ–‡ä»¶å…±äº«** | è‹¥éœ€åœ¨æ–‡ä»¶ç®¡ç†å™¨å±•ç¤ºï¼Œå¿…é¡»æ˜ç¡®è°ƒç”¨ `register_file` |

---

## ğŸ“š é™„å½•

### A. å¸¸ç”¨å·¥å…·å‡½æ•°

```python
# å“åº”å°è£…
from schemas.response import success, error

# æƒé™æ£€æŸ¥
from core.security import require_permission

# æ•°æ®åº“ä¼šè¯
from core.database import get_db

# å½“å‰ç”¨æˆ·
from core.security import get_current_user

# å­˜å‚¨ç®¡ç†
from utils.storage import get_storage_manager

# äº‹ä»¶å‘å¸ƒ
from core.events import event_bus, Events
await event_bus.publish(Event(name=Events.USER_CREATED, data={...}))
```

### B. æ¨¡å—å¼€å‘æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æ–‡ä»¶å·²ä½¿ç”¨ `{module_id}_` å‰ç¼€å‘½å
- [ ] æ•°æ®åº“è¡¨åå·²ä½¿ç”¨ `{module_id}_` å‰ç¼€
- [ ] Manifest å·²æ­£ç¡®é…ç½®æƒé™ã€èœå•ã€è·¯ç”±
- [ ] åº”ç”¨å›¾æ ‡å·²åœ¨ JS æ˜ å°„è¡¨ä¸­å®šä¹‰ä¸”ç¬¦åˆ Premium MacOS é£æ ¼
- [ ] æœªç›´æ¥ import å…¶ä»–æ¨¡å—ä»£ç 
- [ ] ä½¿ç”¨ `StorageManager` ç®¡ç†æ–‡ä»¶å­˜å‚¨
- [ ] API å“åº”ä½¿ç”¨ç»Ÿä¸€çš„ `success()` å’Œ `error()` å‡½æ•°
- [ ] æ‰€æœ‰æ³¨é‡Šä¸ºä¸­æ–‡åŠŸèƒ½æ€§æ³¨é‡Š
- [ ] å·²ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] **è‹¥æ¨¡å—äº§ç”Ÿæ–‡ä»¶**ï¼šç‰©ç†å­˜å‚¨ä½äº `storage/modules/{id}/`
- [ ] **è‹¥æ¨¡å—äº§ç”Ÿæ–‡ä»¶**ï¼šä¸¥ç¦åˆ›å»ºé€‚é…å™¨ï¼Œéµå¾ªæ¨¡å—è‡ªæ²»åŸåˆ™
- [ ] **è‹¥éœ€ä¿å­˜è‡³ç½‘ç›˜**ï¼šé€šè¿‡ `FileManagerService.register_file()` æ˜ç¡®æ³¨å†Œ

---

**æœ€åæ›´æ–°**ï¼š2026-01-25
